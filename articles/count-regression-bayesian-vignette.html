<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Count Regression Part II - Bayesian Approches • appregr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Count Regression Part II - Bayesian Approches">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">appregr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/count-regression-bayesian-vignette.html">Count Regression Part II - Bayesian Approches</a>
    </li>
    <li>
      <a href="../articles/count-regression-hierarchical-mixedeffect-partII-vignettes.html">Count Regression Part III - Heirarchical / Mixed Effects</a>
    </li>
    <li>
      <a href="../articles/count-regression-hierarchical-mixedeffects-vignette.html"> Heirarchical / Mixed Effects</a>
    </li>
    <li>
      <a href="../articles/count-regression-vignette.html">Count Regression</a>
    </li>
    <li>
      <a href="../articles/regression-diagnositcs-vignette.html">regression-diagnostics-vignette</a>
    </li>
    <li>
      <a href="../articles/regression-numerical-linalg-vignette.html">regression-numerical-linalg-vignette</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Count Regression Part II - Bayesian Approches</h1>
            <h3 class="subtitle">A tutorial on count regression</h3>
                        <h4 class="author">Bruce Campbell</h4>
            
            <h4 class="date">25 July, 2019</h4>
      
      
      <div class="hidden name"><code>count-regression-bayesian-vignette.Rmd</code></div>

    </div>

    
    
<p>##Bayesian Approaches to Count Regression</p>
<p>Please see the intorduction to count regression post for a review of count models from the maximum likelihood point o f view. Here we look to replicate the some of same models from a Bayesian persepctive. We also start our exploration of hierarchical models with an example of a hierarchical zero inflated model. Part III of this series will go more into mixed effects and hierarchical models.</p>
<p>We introduce plate notation here. This is a graphical depiction of the static and probablistic dependiencies in a Bayesian model. The symbols for a visual representation of a graphical model are; a) Solid squares represent constant nodes, which specify fixed- valued variables. b) Stochastic nodes are represented by solid circles. These variables correspond to random variables and may depend on other variables. c) Deterministic nodes (dotted circles) indicate variables that are determined by a specific function applied to another variable. They can be thought of as variable transformations. d) Observed states are placed in clamped stochastic nodes, represented by gray-shaded circles. e) Replication over a set of variables is indicated by enclosing the replicated nodes in a plate (dashed rectangle)</p>
<p>Below are examples of a basic linear model and a generative version of the linear model in plate notation.</p>
<p><img src="linear_model_plate_notation.jpg"></p>
<p><img src="generative_linear_model_plate_notation.jpg"></p>
<p>##Generate overdispersed synthetic data <span class="math inline">\(y \sim \theta \;\; e^{\beta_0+\beta_1 x}\)</span></p>
<table class="table">
<caption>Synthtic Data : Summary Statistics</caption>
<colgroup>
<col width="5%">
<col width="9%">
<col width="4%">
<col width="11%">
<col width="11%">
<col width="4%">
<col width="9%">
<col width="9%">
<col width="12%">
<col width="9%">
<col width="9%">
</colgroup>
<thead><tr class="header">
<th></th>
<th align="center">N</th>
<th></th>
<th align="center">Mean</th>
<th align="center">SD</th>
<th></th>
<th align="center">Min</th>
<th align="center">Q1</th>
<th align="center">Median</th>
<th align="center">Q3</th>
<th align="center">Max</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>y</td>
<td align="center">1000</td>
<td></td>
<td align="center">25.33</td>
<td align="center">16.95</td>
<td></td>
<td align="center">0</td>
<td align="center">12</td>
<td align="center">21</td>
<td align="center">36</td>
<td align="center">84</td>
</tr>
<tr class="even">
<td>x</td>
<td align="center">1000</td>
<td></td>
<td align="center">4.79</td>
<td align="center">2.9</td>
<td></td>
<td align="center">0.01</td>
<td align="center">2.36</td>
<td align="center">4.73</td>
<td align="center">7.32</td>
<td align="center">10</td>
</tr>
</tbody>
</table>
<p><img src="count-regression-bayesian-vignette_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>#Fit Poisson model using Stan glm wrapper</p>
<pre><code>
SAMPLING FOR MODEL 'count' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.000112 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 1.12 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 0.538768 seconds (Warm-up)
Chain 1:                0.569344 seconds (Sampling)
Chain 1:                1.10811 seconds (Total)
Chain 1: </code></pre>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(stan_poisson)</a></code></pre></div>
<pre><code>stan_glm
 family:       poisson [log]
 formula:      y ~ x
 observations: 1000
 predictors:   2
------
            Median MAD_SD
(Intercept) 2.1    0.0   
x           0.2    0.0   

Sample avg. posterior predictive distribution of y:
         Median MAD_SD
mean_PPD 25.3    0.2  

------
* For help interpreting the printed output see ?print.stanreg
* For info on the priors used see ?prior_summary.stanreg</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">posterior_poisson &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">as.matrix</a></span>(stan_poisson)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">plot_title &lt;-<span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">"Poisson Model Posterior distributions"</span>, <span class="st">"with medians and 80% intervals"</span>)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="kw">mcmc_areas</span>(posterior_poisson, <span class="dt">pars =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"(Intercept)"</span>, <span class="st">"x"</span>), <span class="dt">prob =</span> <span class="fl">0.8</span>) <span class="op">+</span><span class="st"> </span>plot_title</a></code></pre></div>
<p><img src="count-regression-bayesian-vignette_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">rhats &lt;-<span class="st"> </span><span class="kw">rhat</span>(stan_poisson)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">ratios &lt;-<span class="st"> </span><span class="kw">neff_ratio</span>(stan_poisson)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="kw">mcmc_rhat</span>(rhats)</a></code></pre></div>
<p><img src="count-regression-bayesian-vignette_files/figure-html/unnamed-chunk-4-2.png" width="700"></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">mcmc_neff</span>(ratios, <span class="dt">size =</span> <span class="dv">3</span>)</a></code></pre></div>
<p><img src="count-regression-bayesian-vignette_files/figure-html/unnamed-chunk-4-3.png" width="700"></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">mcmc_neff_hist</span>(ratios)</a></code></pre></div>
<p><img src="count-regression-bayesian-vignette_files/figure-html/unnamed-chunk-4-4.png" width="700"></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co"># there's a small enough number of parameters in the model that we can</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="co"># display their names on the y-axis</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="kw">mcmc_neff</span>(ratios) <span class="op">+</span><span class="st"> </span><span class="kw">yaxis_text</span>(<span class="dt">hjust =</span> <span class="dv">1</span>)</a></code></pre></div>
<p><img src="count-regression-bayesian-vignette_files/figure-html/unnamed-chunk-4-5.png" width="700"></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co"># can also look at autocorrelation</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">draws &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/array">as.array</a></span>(posterior_poisson)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="kw">mcmc_acf</span>(draws, <span class="dt">pars =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"(Intercept)"</span>, <span class="st">"x"</span>), <span class="dt">lags =</span> <span class="dv">10</span>)</a></code></pre></div>
<p><img src="count-regression-bayesian-vignette_files/figure-html/unnamed-chunk-4-6.png" width="700"></p>
<p>##Fit negative binomial model using Stan glm wrapper</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">stan_nb &lt;-<span class="st"> </span><span class="kw">stan_glm</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="dt">data =</span> modelling_data, <span class="dt">family =</span> neg_binomial_<span class="dv">2</span>, <span class="dt">prior =</span> <span class="kw">normal</span>(<span class="dv">0</span>, </a>
<a class="sourceLine" id="cb10-2" data-line-number="2">    <span class="fl">2.5</span>), <span class="dt">prior_intercept =</span> <span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="dt">chains =</span> chains, <span class="dt">cores =</span> no_cores)</a></code></pre></div>
<pre><code>
SAMPLING FOR MODEL 'count' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.000233 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 2.33 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 2.32319 seconds (Warm-up)
Chain 1:                1.98158 seconds (Sampling)
Chain 1:                4.30478 seconds (Total)
Chain 1: </code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(stan_nb)</a></code></pre></div>
<pre><code>stan_glm
 family:       neg_binomial_2 [log]
 formula:      y ~ x
 observations: 1000
 predictors:   2
------
            Median MAD_SD
(Intercept) 2.1    0.0   
x           0.2    0.0   

Auxiliary parameter(s):
                      Median MAD_SD
reciprocal_dispersion 9.1    0.7   

Sample avg. posterior predictive distribution of y:
         Median MAD_SD
mean_PPD 25.3    0.5  

------
* For help interpreting the printed output see ?print.stanreg
* For info on the priors used see ?prior_summary.stanreg</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">posterior_nb &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">as.matrix</a></span>(stan_nb)</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"></a>
<a class="sourceLine" id="cb14-3" data-line-number="3">plot_title &lt;-<span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">"Negative Binomial Model Posterior distributions"</span>, <span class="st">"with medians and 80% intervals"</span>)</a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="kw">mcmc_areas</span>(posterior_nb, <span class="dt">pars =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"(Intercept)"</span>, <span class="st">"x"</span>), <span class="dt">prob =</span> <span class="fl">0.8</span>) <span class="op">+</span><span class="st"> </span>plot_title</a></code></pre></div>
<p><img src="count-regression-bayesian-vignette_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">rhats &lt;-<span class="st"> </span><span class="kw">rhat</span>(stan_nb)</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">ratios &lt;-<span class="st"> </span><span class="kw">neff_ratio</span>(stan_nb)</a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="kw">mcmc_rhat</span>(rhats)</a></code></pre></div>
<p><img src="count-regression-bayesian-vignette_files/figure-html/unnamed-chunk-5-2.png" width="700"></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="kw">mcmc_neff</span>(ratios, <span class="dt">size =</span> <span class="dv">3</span>)</a></code></pre></div>
<p><img src="count-regression-bayesian-vignette_files/figure-html/unnamed-chunk-5-3.png" width="700"></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw">mcmc_neff_hist</span>(ratios)</a></code></pre></div>
<p><img src="count-regression-bayesian-vignette_files/figure-html/unnamed-chunk-5-4.png" width="700"></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="co"># there's a small enough number of parameters in the model that we can</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="co"># display their names on the y-axis</span></a>
<a class="sourceLine" id="cb18-3" data-line-number="3"><span class="kw">mcmc_neff</span>(ratios) <span class="op">+</span><span class="st"> </span><span class="kw">yaxis_text</span>(<span class="dt">hjust =</span> <span class="dv">1</span>)</a></code></pre></div>
<p><img src="count-regression-bayesian-vignette_files/figure-html/unnamed-chunk-5-5.png" width="700"></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="co"># can also look at autocorrelation</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2">draws &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/array">as.array</a></span>(posterior_nb)</a>
<a class="sourceLine" id="cb19-3" data-line-number="3"><span class="kw">mcmc_acf</span>(draws, <span class="dt">pars =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"(Intercept)"</span>, <span class="st">"x"</span>), <span class="dt">lags =</span> <span class="dv">10</span>)</a></code></pre></div>
<p><img src="count-regression-bayesian-vignette_files/figure-html/unnamed-chunk-5-6.png" width="700"></p>
<div id="poisson-regression---hand-built-" class="section level2">
<h2 class="hasAnchor">
<a href="#poisson-regression---hand-built-" class="anchor"></a>Poisson regression - hand built.</h2>
<p>The last two examples used the <code>rstanarm</code> package which wraps the code and diagnotics up into something like the glm function. Here we fit a Poisson model using hand coded Stan code for the GLM.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">N &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">as.integer</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(modelling_data))</a>
<a class="sourceLine" id="cb20-2" data-line-number="2">p &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">as.integer</a></span>(<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">modelling_data<span class="op">$</span>y &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">as.integer</a></span>(modelling_data<span class="op">$</span>y)</a>
<a class="sourceLine" id="cb20-4" data-line-number="4">model_poisson &lt;-<span class="st"> "</span></a>
<a class="sourceLine" id="cb20-5" data-line-number="5"><span class="st">data {</span></a>
<a class="sourceLine" id="cb20-6" data-line-number="6"><span class="st">  // Number of observations (an integer)</span></a>
<a class="sourceLine" id="cb20-7" data-line-number="7"><span class="st">  int&lt;lower=0&gt; N;</span></a>
<a class="sourceLine" id="cb20-8" data-line-number="8"><span class="st">  // Number of beta parameters</span></a>
<a class="sourceLine" id="cb20-9" data-line-number="9"><span class="st">  int&lt;lower=0&gt; p;</span></a>
<a class="sourceLine" id="cb20-10" data-line-number="10"></a>
<a class="sourceLine" id="cb20-11" data-line-number="11"><span class="st">  // Covariates</span></a>
<a class="sourceLine" id="cb20-12" data-line-number="12"><span class="st">  real x[N];</span></a>
<a class="sourceLine" id="cb20-13" data-line-number="13"></a>
<a class="sourceLine" id="cb20-14" data-line-number="14"><span class="st">  // Count outcome</span></a>
<a class="sourceLine" id="cb20-15" data-line-number="15"><span class="st">  int&lt;lower=0&gt; y[N];</span></a>
<a class="sourceLine" id="cb20-16" data-line-number="16"><span class="st">}</span></a>
<a class="sourceLine" id="cb20-17" data-line-number="17"></a>
<a class="sourceLine" id="cb20-18" data-line-number="18"><span class="st">parameters {</span></a>
<a class="sourceLine" id="cb20-19" data-line-number="19"><span class="st">  // Define parameters to estimate</span></a>
<a class="sourceLine" id="cb20-20" data-line-number="20"><span class="st">  real beta[p];</span></a>
<a class="sourceLine" id="cb20-21" data-line-number="21"><span class="st">}</span></a>
<a class="sourceLine" id="cb20-22" data-line-number="22"></a>
<a class="sourceLine" id="cb20-23" data-line-number="23"><span class="st">transformed parameters  {</span></a>
<a class="sourceLine" id="cb20-24" data-line-number="24"><span class="st">  real lp[N];</span></a>
<a class="sourceLine" id="cb20-25" data-line-number="25"><span class="st">  real mu[N];</span></a>
<a class="sourceLine" id="cb20-26" data-line-number="26"></a>
<a class="sourceLine" id="cb20-27" data-line-number="27"><span class="st">  for (i in 1:N) {</span></a>
<a class="sourceLine" id="cb20-28" data-line-number="28"><span class="st">    lp[i] &lt;- beta[1] + beta[2]*x[i];</span></a>
<a class="sourceLine" id="cb20-29" data-line-number="29"></a>
<a class="sourceLine" id="cb20-30" data-line-number="30"><span class="st">    // Mean</span></a>
<a class="sourceLine" id="cb20-31" data-line-number="31"><span class="st">    mu[i] &lt;- exp(lp[i]);</span></a>
<a class="sourceLine" id="cb20-32" data-line-number="32"><span class="st">  }</span></a>
<a class="sourceLine" id="cb20-33" data-line-number="33"><span class="st">}</span></a>
<a class="sourceLine" id="cb20-34" data-line-number="34"></a>
<a class="sourceLine" id="cb20-35" data-line-number="35"><span class="st">model {</span></a>
<a class="sourceLine" id="cb20-36" data-line-number="36"><span class="st">  // Flat prior for mu (no need to specify if non-informative)</span></a>
<a class="sourceLine" id="cb20-37" data-line-number="37"></a>
<a class="sourceLine" id="cb20-38" data-line-number="38"><span class="st">  // Likelihood part of Bayesian inference</span></a>
<a class="sourceLine" id="cb20-39" data-line-number="39"><span class="st">  y ~ poisson(mu);</span></a>
<a class="sourceLine" id="cb20-40" data-line-number="40"><span class="st">}</span></a>
<a class="sourceLine" id="cb20-41" data-line-number="41"><span class="st">"</span></a>
<a class="sourceLine" id="cb20-42" data-line-number="42"></a>
<a class="sourceLine" id="cb20-43" data-line-number="43">stan_poisson_fit &lt;-<span class="st"> </span><span class="kw">stan</span>(<span class="dt">model_code =</span> model_poisson, <span class="dt">data =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">x =</span> modelling_data<span class="op">$</span>x, </a>
<a class="sourceLine" id="cb20-44" data-line-number="44">    <span class="dt">y =</span> modelling_data<span class="op">$</span>y, <span class="dt">N =</span> N, <span class="dt">p =</span> p), <span class="dt">cores =</span> no_cores, <span class="dt">chains =</span> chains, </a>
<a class="sourceLine" id="cb20-45" data-line-number="45">    <span class="dt">iter =</span> iter, <span class="dt">warmup =</span> warmup, <span class="dt">thin =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>DIAGNOSTIC(S) FROM PARSER:
Info: assignment operator &lt;- deprecated in the Stan language; use = instead.
Info: assignment operator &lt;- deprecated in the Stan language; use = instead.


SAMPLING FOR MODEL '969164c09e269485b42249d4cfc13cc7' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.000106 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 1.06 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:   1 / 1000 [  0%]  (Warmup)
Chain 1: Iteration: 100 / 1000 [ 10%]  (Warmup)
Chain 1: Iteration: 200 / 1000 [ 20%]  (Warmup)
Chain 1: Iteration: 201 / 1000 [ 20%]  (Sampling)
Chain 1: Iteration: 300 / 1000 [ 30%]  (Sampling)
Chain 1: Iteration: 400 / 1000 [ 40%]  (Sampling)
Chain 1: Iteration: 500 / 1000 [ 50%]  (Sampling)
Chain 1: Iteration: 600 / 1000 [ 60%]  (Sampling)
Chain 1: Iteration: 700 / 1000 [ 70%]  (Sampling)
Chain 1: Iteration: 800 / 1000 [ 80%]  (Sampling)
Chain 1: Iteration: 900 / 1000 [ 90%]  (Sampling)
Chain 1: Iteration: 1000 / 1000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 0.30071 seconds (Warm-up)
Chain 1:                1.02336 seconds (Sampling)
Chain 1:                1.32407 seconds (Total)
Chain 1: </code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">posterior_poisson &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">as.matrix</a></span>(stan_poisson_fit)</a>
<a class="sourceLine" id="cb22-2" data-line-number="2"></a>
<a class="sourceLine" id="cb22-3" data-line-number="3">plot_title &lt;-<span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">"Negative Binomial Model Posterior distributions"</span>, <span class="st">"with medians and 80% intervals"</span>)</a>
<a class="sourceLine" id="cb22-4" data-line-number="4"><span class="kw">mcmc_areas</span>(posterior_poisson, <span class="dt">pars =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"beta[1]"</span>, <span class="st">"beta[2]"</span>), <span class="dt">prob =</span> <span class="fl">0.8</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-5" data-line-number="5"><span class="st">    </span>plot_title</a></code></pre></div>
<p><img src="count-regression-bayesian-vignette_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">rhats &lt;-<span class="st"> </span><span class="kw">rhat</span>(stan_poisson_fit)</a>
<a class="sourceLine" id="cb23-2" data-line-number="2">ratios &lt;-<span class="st"> </span><span class="kw">neff_ratio</span>(stan_poisson_fit)</a>
<a class="sourceLine" id="cb23-3" data-line-number="3"><span class="kw">mcmc_rhat</span>(rhats)</a></code></pre></div>
<p><img src="count-regression-bayesian-vignette_files/figure-html/unnamed-chunk-6-2.png" width="700"></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="kw">mcmc_neff</span>(ratios, <span class="dt">size =</span> <span class="dv">3</span>)</a></code></pre></div>
<p><img src="count-regression-bayesian-vignette_files/figure-html/unnamed-chunk-6-3.png" width="700"></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="co"># there's a small enough number of parameters in the model that we can</span></a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="co"># display their names on the y-axis</span></a>
<a class="sourceLine" id="cb25-3" data-line-number="3"><span class="kw">mcmc_neff</span>(ratios) <span class="op">+</span><span class="st"> </span><span class="kw">yaxis_text</span>(<span class="dt">hjust =</span> <span class="dv">1</span>)</a></code></pre></div>
<p><img src="count-regression-bayesian-vignette_files/figure-html/unnamed-chunk-6-4.png" width="700"></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="kw">mcmc_neff_hist</span>(ratios)</a></code></pre></div>
<p><img src="count-regression-bayesian-vignette_files/figure-html/unnamed-chunk-6-5.png" width="700"></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="co"># can also look at autocorrelation</span></a>
<a class="sourceLine" id="cb27-2" data-line-number="2">draws &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/array">as.array</a></span>(posterior_poisson)</a>
<a class="sourceLine" id="cb27-3" data-line-number="3"><span class="kw">mcmc_acf</span>(draws, <span class="dt">pars =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"beta[1]"</span>, <span class="st">"beta[2]"</span>), <span class="dt">lags =</span> <span class="dv">10</span>)</a></code></pre></div>
<p><img src="count-regression-bayesian-vignette_files/figure-html/unnamed-chunk-6-6.png" width="700"></p>
</div>
<div id="zero-inflated-models" class="section level2">
<h2 class="hasAnchor">
<a href="#zero-inflated-models" class="anchor"></a>Zero Inflated Models</h2>
<p>Heirarchical zero inflated gamma model. This a “hurdle” model, in which a bernoulli GLM produces zeros/nonzeros, and then a gamma GLM produces the nonzero values, using varying effects correlated with those in the bernoulli process.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="co"># inverse logit</span></a>
<a class="sourceLine" id="cb28-2" data-line-number="2">logistic &lt;-<span class="st"> </span><span class="cf">function</span> (x)</a>
<a class="sourceLine" id="cb28-3" data-line-number="3">{</a>
<a class="sourceLine" id="cb28-4" data-line-number="4">  p &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(x)<span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(x))</a>
<a class="sourceLine" id="cb28-5" data-line-number="5">  p &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(x <span class="op">==</span><span class="st"> </span><span class="ot">Inf</span>, <span class="dv">1</span>, p)</a>
<a class="sourceLine" id="cb28-6" data-line-number="6">  p</a>
<a class="sourceLine" id="cb28-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb28-8" data-line-number="8"></a>
<a class="sourceLine" id="cb28-9" data-line-number="9"><span class="co"># simulate data</span></a>
<a class="sourceLine" id="cb28-10" data-line-number="10">N &lt;-<span class="st"> </span><span class="dv">1000</span> <span class="co"># number of cases</span></a>
<a class="sourceLine" id="cb28-11" data-line-number="11">J &lt;-<span class="st"> </span><span class="dv">20</span> <span class="co"># number of clusters</span></a>
<a class="sourceLine" id="cb28-12" data-line-number="12">NperJ &lt;-<span class="st"> </span>N<span class="op">/</span>J <span class="co"># cases per cluster</span></a>
<a class="sourceLine" id="cb28-13" data-line-number="13">theta &lt;-<span class="st"> </span><span class="dv">1</span> <span class="co"># scale</span></a>
<a class="sourceLine" id="cb28-14" data-line-number="14">mu &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>( <span class="dv">0</span> , <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(<span class="dv">7</span>) ) <span class="co"># means of varying intercepts</span></a>
<a class="sourceLine" id="cb28-15" data-line-number="15">id &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>( <span class="dv">1</span><span class="op">:</span>J , <span class="dt">each=</span>NperJ )</a>
<a class="sourceLine" id="cb28-16" data-line-number="16">Sigma &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>( <span class="dv">0</span> , <span class="dt">nrow=</span><span class="dv">2</span> , <span class="dt">ncol=</span><span class="dv">2</span> ) <span class="co"># var-cov matrix for varying intercepts</span></a>
<a class="sourceLine" id="cb28-17" data-line-number="17">Sigma[<span class="dv">1</span>,<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="fl">0.15</span></a>
<a class="sourceLine" id="cb28-18" data-line-number="18">Sigma[<span class="dv">2</span>,<span class="dv">2</span>] &lt;-<span class="st"> </span><span class="fl">0.5</span></a>
<a class="sourceLine" id="cb28-19" data-line-number="19">Sigma[<span class="dv">1</span>,<span class="dv">2</span>] &lt;-<span class="st"> </span>Sigma[<span class="dv">2</span>,<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="fl">-0.8</span> <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>( Sigma[<span class="dv">1</span>,<span class="dv">1</span>] <span class="op">*</span><span class="st"> </span>Sigma[<span class="dv">2</span>,<span class="dv">2</span>] )</a>
<a class="sourceLine" id="cb28-20" data-line-number="20">alpha &lt;-<span class="st"> </span><span class="kw">mvrnorm</span>( J , <span class="dt">mu=</span>mu , <span class="dt">Sigma=</span>Sigma )</a>
<a class="sourceLine" id="cb28-21" data-line-number="21">y1 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Binomial">rbinom</a></span>( N , <span class="dt">size=</span><span class="dv">1</span> , <span class="dt">prob=</span><span class="kw">logistic</span>( alpha[id,<span class="dv">1</span>] ) ) <span class="co"># sim zeros</span></a>
<a class="sourceLine" id="cb28-22" data-line-number="22">y2 &lt;-<span class="st"> </span>(<span class="dv">1</span><span class="op">-</span>y1) <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/GammaDist">rgamma</a></span>( N , <span class="dt">shape=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(alpha[id,<span class="dv">2</span>])<span class="op">*</span>theta , <span class="dt">scale=</span>theta ) <span class="co"># sim observed</span></a>
<a class="sourceLine" id="cb28-23" data-line-number="23"></a>
<a class="sourceLine" id="cb28-24" data-line-number="24"><span class="co"># prep data for Stan</span></a>
<a class="sourceLine" id="cb28-25" data-line-number="25">dat &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb28-26" data-line-number="26">  <span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>( y2<span class="op">==</span><span class="dv">0</span> , <span class="dv">20</span> , y2 ), <span class="co"># 20 to prevent gamma density gacking in vectorized code</span></a>
<a class="sourceLine" id="cb28-27" data-line-number="27">  <span class="dt">iszero =</span> y1,</a>
<a class="sourceLine" id="cb28-28" data-line-number="28">  <span class="dt">N =</span> N,</a>
<a class="sourceLine" id="cb28-29" data-line-number="29">  <span class="dt">J =</span> J,</a>
<a class="sourceLine" id="cb28-30" data-line-number="30">  <span class="dt">Omega =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/diag">diag</a></span>(<span class="dv">2</span>),</a>
<a class="sourceLine" id="cb28-31" data-line-number="31">  <span class="dt">id =</span> id</a>
<a class="sourceLine" id="cb28-32" data-line-number="32">)</a>
<a class="sourceLine" id="cb28-33" data-line-number="33"></a>
<a class="sourceLine" id="cb28-34" data-line-number="34">model_zigamma &lt;-<span class="st"> '</span></a>
<a class="sourceLine" id="cb28-35" data-line-number="35"><span class="st">data {</span></a>
<a class="sourceLine" id="cb28-36" data-line-number="36"><span class="st">int&lt;lower=0&gt; N;                 // number of cases</span></a>
<a class="sourceLine" id="cb28-37" data-line-number="37"><span class="st">int&lt;lower=1&gt; J;                 // number of clusters</span></a>
<a class="sourceLine" id="cb28-38" data-line-number="38"><span class="st">real&lt;lower=0&gt; y[N];             // observed outcome</span></a>
<a class="sourceLine" id="cb28-39" data-line-number="39"><span class="st">int&lt;lower=0,upper=1&gt; iszero[N]; // indicates a zero outcome</span></a>
<a class="sourceLine" id="cb28-40" data-line-number="40"><span class="st">int&lt;lower=1&gt; id[N];             // cluster number for each case</span></a>
<a class="sourceLine" id="cb28-41" data-line-number="41"><span class="st">cov_matrix[2] Omega;            // diagonal prior</span></a>
<a class="sourceLine" id="cb28-42" data-line-number="42"><span class="st">}</span></a>
<a class="sourceLine" id="cb28-43" data-line-number="43"><span class="st">parameters {</span></a>
<a class="sourceLine" id="cb28-44" data-line-number="44"><span class="st">vector[2] mu;                   // means of varying effects</span></a>
<a class="sourceLine" id="cb28-45" data-line-number="45"><span class="st">cov_matrix[2] Sigma;            // var-cov matrix for varying effects</span></a>
<a class="sourceLine" id="cb28-46" data-line-number="46"><span class="st">vector[2] alpha[J];             // varying effects for each cluster</span></a>
<a class="sourceLine" id="cb28-47" data-line-number="47"><span class="st">real theta;                     // log scale</span></a>
<a class="sourceLine" id="cb28-48" data-line-number="48"><span class="st">}</span></a>
<a class="sourceLine" id="cb28-49" data-line-number="49"><span class="st">model {</span></a>
<a class="sourceLine" id="cb28-50" data-line-number="50"><span class="st">real pi;                        // probability of zero GLM</span></a>
<a class="sourceLine" id="cb28-51" data-line-number="51"><span class="st">real mugamma;                   // mean of gamma GLM</span></a>
<a class="sourceLine" id="cb28-52" data-line-number="52"><span class="st">Sigma ~ inv_wishart( 3 , Omega );</span></a>
<a class="sourceLine" id="cb28-53" data-line-number="53"><span class="st">mu[1] ~ normal( 0 , 100 );</span></a>
<a class="sourceLine" id="cb28-54" data-line-number="54"><span class="st">mu[2] ~ normal( 0 , 100 );</span></a>
<a class="sourceLine" id="cb28-55" data-line-number="55"><span class="st">theta ~ normal( 0 , 100 );</span></a>
<a class="sourceLine" id="cb28-56" data-line-number="56"><span class="st">for (j in 1:J) alpha[j] ~ multi_normal( mu , Sigma );</span></a>
<a class="sourceLine" id="cb28-57" data-line-number="57"><span class="st">for (n in 1:N) {</span></a>
<a class="sourceLine" id="cb28-58" data-line-number="58"><span class="st">pi = inv_logit( alpha[ id[n] , 1 ] );</span></a>
<a class="sourceLine" id="cb28-59" data-line-number="59"><span class="st">mugamma = exp( alpha[ id[n] , 2 ] );</span></a>
<a class="sourceLine" id="cb28-60" data-line-number="60"><span class="st">}</span></a>
<a class="sourceLine" id="cb28-61" data-line-number="61"><span class="st">}</span></a>
<a class="sourceLine" id="cb28-62" data-line-number="62"><span class="st">generated quantities {</span></a>
<a class="sourceLine" id="cb28-63" data-line-number="63"><span class="st">real dev;                       // deviance of each set of samples</span></a>
<a class="sourceLine" id="cb28-64" data-line-number="64"><span class="st">real pi;                        // temp for computing dev</span></a>
<a class="sourceLine" id="cb28-65" data-line-number="65"><span class="st">real mugamma;                   // temp for computing dev</span></a>
<a class="sourceLine" id="cb28-66" data-line-number="66"><span class="st">real rho;                       // correlation btw varying intercepts</span></a>
<a class="sourceLine" id="cb28-67" data-line-number="67"><span class="st">real sdi[2];                     // sd of varying intercepts</span></a>
<a class="sourceLine" id="cb28-68" data-line-number="68"><span class="st">dev &lt;- 0;                       // not sure need to init to zero</span></a>
<a class="sourceLine" id="cb28-69" data-line-number="69"><span class="st">for ( n in 1:N ) {</span></a>
<a class="sourceLine" id="cb28-70" data-line-number="70"><span class="st">pi = inv_logit( alpha[ id[n] , 1 ] );</span></a>
<a class="sourceLine" id="cb28-71" data-line-number="71"><span class="st">mugamma = exp( alpha[ id[n] , 2 ] );</span></a>
<a class="sourceLine" id="cb28-72" data-line-number="72"><span class="st">dev = dev + (-2) * if_else( iszero[n] , log(pi) , log1m(pi) + gamma_log( y[n] , mugamma*exp(theta) , exp(theta) ) );</span></a>
<a class="sourceLine" id="cb28-73" data-line-number="73"><span class="st">}</span></a>
<a class="sourceLine" id="cb28-74" data-line-number="74"><span class="st">for( k in 1:2 ) sdi[k] = sqrt( Sigma[k,k] );</span></a>
<a class="sourceLine" id="cb28-75" data-line-number="75"><span class="st">rho = Sigma[1,2] / sqrt( Sigma[1,1] * Sigma[2,2] );</span></a>
<a class="sourceLine" id="cb28-76" data-line-number="76"><span class="st">}</span></a>
<a class="sourceLine" id="cb28-77" data-line-number="77"><span class="st">'</span></a>
<a class="sourceLine" id="cb28-78" data-line-number="78"></a>
<a class="sourceLine" id="cb28-79" data-line-number="79"><span class="co"># optional init list</span></a>
<a class="sourceLine" id="cb28-80" data-line-number="80">init_alpha =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>( <span class="dv">0</span> , <span class="dt">nrow=</span>J , <span class="dt">ncol=</span><span class="dv">2</span> )</a>
<a class="sourceLine" id="cb28-81" data-line-number="81">init_alpha[ , <span class="dv">2</span> ] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>( <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(<span class="dv">7</span>) , J )</a>
<a class="sourceLine" id="cb28-82" data-line-number="82">initlist &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb28-83" data-line-number="83">    <span class="dt">theta =</span> <span class="dv">1</span> ,</a>
<a class="sourceLine" id="cb28-84" data-line-number="84">    <span class="dt">mu =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>( <span class="dv">0</span> , <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(<span class="dv">7</span>) ) ,</a>
<a class="sourceLine" id="cb28-85" data-line-number="85">    <span class="dt">Sigma =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/diag">diag</a></span>(<span class="dv">2</span>) ,</a>
<a class="sourceLine" id="cb28-86" data-line-number="86">    <span class="dt">alpha =</span> init_alpha</a>
<a class="sourceLine" id="cb28-87" data-line-number="87">))</a>
<a class="sourceLine" id="cb28-88" data-line-number="88"></a>
<a class="sourceLine" id="cb28-89" data-line-number="89">fit &lt;-<span class="st"> </span><span class="kw">stan</span>( <span class="dt">model_code =</span> model_zigamma , <span class="dt">data =</span> dat , <span class="dt">iter =</span> iter , <span class="dt">warmup =</span> warmup , <span class="dt">init=</span><span class="st">"random"</span> , <span class="dt">cores=</span>no_cores, <span class="dt">chains =</span> chains,<span class="dt">control=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">adapt_delta=</span>.<span class="dv">9</span>,<span class="dt">max_treedepth=</span><span class="dv">20</span> ) )</a></code></pre></div>
<pre><code>DIAGNOSTIC(S) FROM PARSER:
Info: assignment operator &lt;- deprecated in the Stan language; use = instead.
Info: Deprecated function 'gamma_log'; please replace suffix '_log' with '_lpdf' for density functions or '_lpmf' for mass functions
Info: the if_else() function is deprecated.  Use the conditional operator '?:' instead.


SAMPLING FOR MODEL '9dc7983397a9006ed9f27a81fd07593c' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.000308 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 3.08 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:   1 / 1000 [  0%]  (Warmup)
Chain 1: Iteration: 100 / 1000 [ 10%]  (Warmup)
Chain 1: Iteration: 200 / 1000 [ 20%]  (Warmup)
Chain 1: Iteration: 201 / 1000 [ 20%]  (Sampling)
Chain 1: Iteration: 300 / 1000 [ 30%]  (Sampling)
Chain 1: Iteration: 400 / 1000 [ 40%]  (Sampling)
Chain 1: Iteration: 500 / 1000 [ 50%]  (Sampling)
Chain 1: Iteration: 600 / 1000 [ 60%]  (Sampling)
Chain 1: Iteration: 700 / 1000 [ 70%]  (Sampling)
Chain 1: Iteration: 800 / 1000 [ 80%]  (Sampling)
Chain 1: Iteration: 900 / 1000 [ 90%]  (Sampling)
Chain 1: Iteration: 1000 / 1000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 25.8286 seconds (Warm-up)
Chain 1:                71.6094 seconds (Sampling)
Chain 1:                97.438 seconds (Total)
Chain 1: </code></pre>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1">rstan<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/rstan/topics/stanfit-method-traceplot">traceplot</a></span>( fit , <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"mu"</span>,<span class="st">"theta"</span>,<span class="st">"sdi"</span>,<span class="st">"rho"</span>) )</a></code></pre></div>
<p><img src="count-regression-bayesian-vignette_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="co">#pairs(fit)</span></a>
<a class="sourceLine" id="cb31-2" data-line-number="2"></a>
<a class="sourceLine" id="cb31-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>( fit , <span class="dt">digits=</span><span class="dv">2</span> , <span class="dt">pars=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"mu"</span>,<span class="st">"theta"</span>,<span class="st">"sdi"</span>,<span class="st">"rho"</span>) , <span class="dt">probs=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.025</span>,<span class="fl">0.5</span>,<span class="fl">0.975</span>) )</a></code></pre></div>
<pre><code>Inference for Stan model: 9dc7983397a9006ed9f27a81fd07593c.
1 chains, each with iter=1000; warmup=200; thin=1; 
post-warmup draws per chain=800, total post-warmup draws=800.

         mean se_mean     sd    2.5%    50%  97.5% n_eff Rhat
mu[1]  -21.93   15.89  99.67 -195.48 -33.20 243.08    39 1.00
mu[2]  -13.07   25.32 105.59 -230.82 -10.37 201.26    17 1.15
theta    2.52    5.70  97.88 -188.18   7.65 185.50   295 1.00
sdi[1]   1.17    0.22   0.92    0.41   0.90   3.98    18 1.10
sdi[2]   1.02    0.09   0.59    0.38   0.83   2.80    45 1.00
rho     -0.01    0.07   0.57   -0.93   0.01   0.92    75 1.00

Samples were drawn using NUTS(diag_e) at Wed Jul 24 18:50:27 2019.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="co">#library(shinystan)</span></a>
<a class="sourceLine" id="cb33-2" data-line-number="2"><span class="co">#shinystan::launch_shinystan(fit)</span></a></code></pre></div>
<p>#Bibliography</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#poisson-regression---hand-built-">Poisson regression - hand built.</a></li>
      <li><a href="#zero-inflated-models">Zero Inflated Models</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Bruce Campbell.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
