<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Count Regression Part III - Heirarchical / Mixed Effects â€¢ appregr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Count Regression Part III - Heirarchical / Mixed Effects">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">appregr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/count-regression-bayesian-vignette.html">Count Regression Part II - Bayesian Approches</a>
    </li>
    <li>
      <a href="../articles/count-regression-hierarchical-mixedeffect-partII-vignettes.html">Count Regression Part III - Heirarchical / Mixed Effects</a>
    </li>
    <li>
      <a href="../articles/count-regression-hierarchical-mixedeffects-vignette.html"> Heirarchical / Mixed Effects</a>
    </li>
    <li>
      <a href="../articles/count-regression-vignette.html">Count Regression</a>
    </li>
    <li>
      <a href="../articles/regression-diagnositcs-vignette.html">regression-diagnostics-vignette</a>
    </li>
    <li>
      <a href="../articles/regression-numerical-linalg-vignette.html">regression-numerical-linalg-vignette</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Count Regression Part III - Heirarchical / Mixed Effects</h1>
            <h3 class="subtitle">A tutorial on count regression</h3>
                        <h4 class="author">Bruce Campbell</h4>
            
            <h4 class="date">24 July, 2019</h4>
      
      
      <div class="hidden name"><code>count-regression-hierarchical-mixedeffect-partII-vignettes.Rmd</code></div>

    </div>

    
    
<p>##Bayesian Approaches to Count Regression</p>
<p>Please see the intorduction to count regression post for a review of count models from the maximum likelihood point o f view. Part 2 looks at the Bayesian implementation of count models. Here in Part III we look to understand heirarchical count models. Some discussion on the principles involved is warranted since the terminology can be confusing. There are Bayesian and frequentist approches to this - each with their own terminology.</p>
<p>Without random coefficients, the standard Poisson model is:</p>
<p><span class="math display">\[ \log E(y_{i}) = \alpha + X'_{i} \beta \]</span></p>
<p>The log link is the canonical link function for the Poisson distribution, and the expected value of the response is modeled.</p>
<p>With random coefficients, for example a random intercept, the model becomes:</p>
<p><span class="math display">\[ \log E(y_{ij}|u_{j}) = \alpha + X'_{ij} \beta + u_{j} \]</span></p>
<p>Where <span class="math inline">\(y_{ij}\)</span> is the observation for individual (i) in group (j) and <span class="math inline">\(u_{j}\)</span> is the random effect for group (j). Thus the two distributions are:</p>
<p><span class="math display">\[ y \sim Pois(\lambda) \]</span></p>
<p>and</p>
<p><span class="math display">\[ u \sim N(0, \sigma^{2}) \]</span></p>
<p>The random coefficient model is conditional on the random effect. Consider a simple model:</p>
<p><span class="math display">\[ \log E(y_{ij}|u_{j}) = -.5 + .3x_{ij} + u_{j} \]</span></p>
<p>In the original units, this becomes:</p>
<p><span class="math display">\[ E(y_{ij}|u_{j}) = \exp(-.5 + .3x_{ij} + u_{j}) \]</span></p>
<p>Now look what happens when we graph the estimated change for a 1 unit change in x for values of the random variable (u) ranging from 0 to 4 by increments of .5.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">f &lt;-<span class="st"> </span><span class="cf">function</span>(x_ij, u_j) {</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(<span class="op">-</span><span class="fl">0.5</span> <span class="op">+</span><span class="st"> </span>x_ij <span class="op">*</span><span class="st"> </span><span class="fl">0.3</span> <span class="op">+</span><span class="st"> </span>u_j)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">0</span>, <span class="dv">4</span>, <span class="fl">0.5</span>)) {</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">    <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/curve">curve</a></span>(<span class="kw">f</span>(x, <span class="dt">u_j =</span> i), <span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">1</span>, <span class="dt">n =</span> <span class="dv">200</span>, <span class="dt">add =</span> i <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="dt">ylim =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, </a>
<a class="sourceLine" id="cb1-7" data-line-number="7">        <span class="dv">45</span>), <span class="dt">ylab =</span> <span class="st">""</span>)</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/title">title</a></span>(<span class="dt">ylab =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/bquote">bquote</a></span>(<span class="kw">E</span>(Y <span class="op">~</span><span class="st"> </span>l <span class="op">~</span><span class="st"> </span>x[ij], u[j])), <span class="dt">main =</span> <span class="st">"Effect of x for different random effects"</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffect-partII-vignettes_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>Clearly, on the scale of the original units, a 1 unit increase in x has different effects depending on the value of u, hence the conditionalness of the model. Population <em>average</em> effects can be obtained by integrating out the random effect or by fitting a marginal model such as using GEEs. Although the outcome is assumed to have a Poisson distribution, the random effect (in the above example, u) is typically assumed to have a Gaussian distribution.</p>
<p>##Generate synthetic data <span class="math inline">\(y_{ij} \sim \;\; e^{\beta_0 + Z_i b + \beta_1 x_{ij}}\)</span></p>
<p><img src="count-regression-hierarchical-mixedeffect-partII-vignettes_files/figure-html/unnamed-chunk-3-1.png" width="700"><img src="count-regression-hierarchical-mixedeffect-partII-vignettes_files/figure-html/unnamed-chunk-3-2.png" width="700"><img src="count-regression-hierarchical-mixedeffect-partII-vignettes_files/figure-html/unnamed-chunk-3-3.png" width="700"></p>
<pre><code>[1] 0.4338723</code></pre>
<p>Factors are dropped from the summary</p>
<table class="table">
<caption>Synthtic Data : Summary Statistics</caption>
<colgroup>
<col width="21%">
<col width="8%">
<col width="3%">
<col width="8%">
<col width="8%">
<col width="3%">
<col width="9%">
<col width="8%">
<col width="10%">
<col width="8%">
<col width="9%">
</colgroup>
<thead><tr class="header">
<th></th>
<th align="center">N</th>
<th></th>
<th align="center">Mean</th>
<th align="center">SD</th>
<th></th>
<th align="center">Min</th>
<th align="center">Q1</th>
<th align="center">Median</th>
<th align="center">Q3</th>
<th align="center">Max</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>y</td>
<td align="center">1000</td>
<td></td>
<td align="center">3.21</td>
<td align="center">3.01</td>
<td></td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">2</td>
<td align="center">4</td>
<td align="center">19</td>
</tr>
<tr class="even">
<td>x</td>
<td align="center">1000</td>
<td></td>
<td align="center">4.92</td>
<td align="center">2.92</td>
<td></td>
<td align="center">0</td>
<td align="center">2.3</td>
<td align="center">4.91</td>
<td align="center">7.47</td>
<td align="center">10</td>
</tr>
<tr class="odd">
<td>fixed</td>
<td align="center">1000</td>
<td></td>
<td align="center">0.24</td>
<td align="center">0.65</td>
<td></td>
<td align="center">-0.79</td>
<td align="center">0.09</td>
<td align="center">0.29</td>
<td align="center">0.35</td>
<td align="center">1.24</td>
</tr>
<tr class="even">
<td>linearPredictor</td>
<td align="center">1000</td>
<td></td>
<td align="center">0.93</td>
<td align="center">0.69</td>
<td></td>
<td align="center">-0.59</td>
<td align="center">0.51</td>
<td align="center">0.96</td>
<td align="center">1.39</td>
<td align="center">2.44</td>
</tr>
<tr class="odd">
<td>mu</td>
<td align="center">1000</td>
<td></td>
<td align="center">3.18</td>
<td align="center">2.27</td>
<td></td>
<td align="center">0.55</td>
<td align="center">1.66</td>
<td align="center">2.6</td>
<td align="center">4.02</td>
<td align="center">11.44</td>
</tr>
</tbody>
</table>
<p><img src="count-regression-hierarchical-mixedeffect-partII-vignettes_files/figure-html/unnamed-chunk-3-4.png" width="700"><img src="count-regression-hierarchical-mixedeffect-partII-vignettes_files/figure-html/unnamed-chunk-3-5.png" width="700"></p>
<p>#Fit Poisson mixed effects model.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">m &lt;-<span class="st"> </span><span class="kw">glmer</span>(y <span class="op">~</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span>(x <span class="op">|</span><span class="st"> </span>groupIdx), modelling_data, <span class="dt">family =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/family">poisson</a></span>(<span class="dt">link =</span> <span class="st">"log"</span>))</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(m)</a></code></pre></div>
<pre><code>Generalized linear mixed model fit by maximum likelihood (Laplace
  Approximation) [glmerMod]
 Family: poisson  ( log )
Formula: y ~ x + (x | groupIdx)
   Data: modelling_data

     AIC      BIC   logLik deviance df.resid 
  3672.8   3697.3  -1831.4   3662.8      995 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-2.2160 -0.7547 -0.0778  0.5276  4.0711 

Random effects:
 Groups   Name        Variance  Std.Dev. Corr
 groupIdx (Intercept) 3.818e-01 0.617935     
          x           1.498e-05 0.003871 1.00
Number of obs: 1000, groups:  groupIdx, 5

Fixed effects:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) 0.383072   0.280658   1.365    0.172    
x           0.110423   0.007665  14.406   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
  (Intr)
x 0.069 
convergence code: 0
boundary (singular) fit: see ?isSingular</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">vv &lt;-<span class="st"> </span><span class="kw">vcov.merMod</span>(m, <span class="dt">corr =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw">as</span>(vv, <span class="st">"corMatrix"</span>)  <span class="co"># extracts the ('hidden') 'correlation' entry in @factors</span></a></code></pre></div>
<pre><code>2 x 2 Matrix of class "corMatrix"
            (Intercept)          x
(Intercept)  1.00000000 0.06919018
x            0.06919018 1.00000000</code></pre>
<div id="student-data-exaple" class="section level2">
<h2 class="hasAnchor">
<a href="#student-data-exaple" class="anchor"></a>Student Data Exaple</h2>
<p>The example data we use comes from a sample of the high school and beyond data set, with a made up variable, number of awards a student receives, awards. Our main predictor will be sex, female, and students are clustered (grouped) within schools, cid.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">require</a></span>(foreign)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co">## ggplot2 package for graphs</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">require</a></span>(ggplot2)</a></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co"># require(glmmADMB) load lme4 package</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">require</a></span>(lme4)</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="co">## read in data</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">dat &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/foreign/topics/read.dta">read.dta</a></span>(<span class="st">"https://stats.idre.ucla.edu/stat/data/hsbdemo.dta"</span>)</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">dat<span class="op">$</span>cid &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(dat<span class="op">$</span>cid)</a>
<a class="sourceLine" id="cb8-6" data-line-number="6"></a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="co">## look at the first few rows of the dataset</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(dat)</a></code></pre></div>
<pre><code>   id female    ses schtyp     prog read write math science socst
1  45 female    low public vocation   34    35   41      29    26
2 108   male middle public  general   34    33   41      36    36
3  15   male   high public vocation   39    39   44      26    42
4  67   male    low public vocation   37    37   42      33    32
5 153   male middle public vocation   39    31   40      39    51
6  51 female   high public  general   42    36   42      31    39
        honors awards cid
1 not enrolled      0   1
2 not enrolled      0   1
3 not enrolled      0   1
4 not enrolled      0   1
5 not enrolled      0   1
6 not enrolled      0   1</code></pre>
<p>We can get a sense of the distributions in the data using the ggplot2 package. The first plot is just histograms of number of awards for every cid. The second is a filled density plot. The density sums to 1 and the fill shows the distribution of female at every level of awards. If the distribution of female is equal across all awards, they would fall on the horizontal line.</p>
</div>
<div id="awards-by-school" class="section level2">
<h2 class="hasAnchor">
<a href="#awards-by-school" class="anchor"></a>awards by school</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(dat, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(awards)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="dt">binwidth =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="op">~</span>cid)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffect-partII-vignettes_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(modelling_data, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(y)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="dt">binwidth =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="op">~</span>groupIdx)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffect-partII-vignettes_files/figure-html/unnamed-chunk-7-2.png" width="700"></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co"># density of awards by sex, line at .5 is the null of no sex differences in</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="co"># number of awards</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(dat, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(awards))) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">fill =</span> female), <span class="dt">position =</span> <span class="st">"fill"</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="st">    </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span>(<span class="dt">yintercept =</span> <span class="fl">0.5</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffect-partII-vignettes_files/figure-html/unnamed-chunk-7-3.png" width="700"></p>
<p>Analysis methods you might consider - Random coefficient poisson models, the focus of this page. - Poisson regression with robust standard errors - Random coefficient poisson model analysis - Because generalized linear mixed models (GLMMs) such as random coefficient poisson models are rather difficult to fit, there tends to be some variability in parameter estimates between different programs. We will demonstrate the use of two packages in R that are able to fit these models, lme4 and glmmADMB.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co">## fit a random intercept only model using the Laplace approximation</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="co">## (equivalent to 1 point evaluated per axis in Gauss-Hermite approximation)</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3">m1a &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/glmer">glmer</a></span>(awards <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>cid), <span class="dt">data =</span> dat, <span class="dt">family =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/family">poisson</a></span>(<span class="dt">link =</span> <span class="st">"log"</span>))</a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co">## fit a random intercept only model using 100 points per axis in the</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="co">## adaptive Gauss-Hermite approximation of the log likelihood more points</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="co">## improves accuracy but will take longer</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7">m1b &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/glmer">glmer</a></span>(awards <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>cid), <span class="dt">data =</span> dat, <span class="dt">family =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/family">poisson</a></span>(<span class="dt">link =</span> <span class="st">"log"</span>), </a>
<a class="sourceLine" id="cb13-8" data-line-number="8">    <span class="dt">nAGQ =</span> <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb13-9" data-line-number="9"></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"><span class="co">## compare (only slightly different)</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(<span class="dt">m1a =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/coef">coef</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(m1a)), <span class="dt">m1b =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/coef">coef</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(m1b)))</a></code></pre></div>
<pre><code>                Estimate Std. Error     z value  Pr(&gt;|z|)
(Intercept) -0.008100387  0.2864037 -0.02828311 0.9774364
(Intercept) -0.009574892  0.2902939 -0.03298344 0.9736878</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(m1b)</a></code></pre></div>
<pre><code>Generalized linear mixed model fit by maximum likelihood (Adaptive
  Gauss-Hermite Quadrature, nAGQ = 100) [glmerMod]
 Family: poisson  ( log )
Formula: awards ~ 1 + (1 | cid)
   Data: dat

     AIC      BIC   logLik deviance df.resid 
   228.6    235.2   -112.3    224.6      198 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-1.3857 -0.5260 -0.3383  0.3379  3.3769 

Random effects:
 Groups Name        Variance Std.Dev.
 cid    (Intercept) 1.458    1.207   
Number of obs: 200, groups:  cid, 20

Fixed effects:
             Estimate Std. Error z value Pr(&gt;|z|)
(Intercept) -0.009575   0.290294  -0.033    0.974</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="co">## QQ plot</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/ranef">ranef</a></span>(m1b))</a></code></pre></div>
<pre><code>$cid</code></pre>
<p><img src="count-regression-hierarchical-mixedeffect-partII-vignettes_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="co">## $cid</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2"></a>
<a class="sourceLine" id="cb19-3" data-line-number="3"><span class="co">## Caterpillar plot</span></a>
<a class="sourceLine" id="cb19-4" data-line-number="4">lattice<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/lattice/topics/xyplot">dotplot</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/ranef">ranef</a></span>(m1b, <span class="dt">postVar =</span> <span class="ot">TRUE</span>))</a></code></pre></div>
<pre><code>$cid</code></pre>
<p><img src="count-regression-hierarchical-mixedeffect-partII-vignettes_files/figure-html/unnamed-chunk-8-2.png" width="700"></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="co">## $cid</span></a></code></pre></div>
<p>The estimate for the intercept is essentially 0, although the random effects variance indicates that there is some variability in the intercepts between schools. Now we will add in female as an explanatory variable.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">m2 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/glmer">glmer</a></span>(awards <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>female <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>cid), <span class="dt">data =</span> dat, <span class="dt">family =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/family">poisson</a></span>(<span class="dt">link =</span> <span class="st">"log"</span>), </a>
<a class="sourceLine" id="cb22-2" data-line-number="2">    <span class="dt">nAGQ =</span> <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(m2)</a></code></pre></div>
<pre><code>Generalized linear mixed model fit by maximum likelihood (Adaptive
  Gauss-Hermite Quadrature, nAGQ = 100) [glmerMod]
 Family: poisson  ( log )
Formula: awards ~ 1 + female + (1 | cid)
   Data: dat

     AIC      BIC   logLik deviance df.resid 
   221.1    231.0   -107.6    215.1      197 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-1.5312 -0.5919 -0.3304  0.2047  2.8806 

Random effects:
 Groups Name        Variance Std.Dev.
 cid    (Intercept) 1.431    1.196   
Number of obs: 200, groups:  cid, 20

Fixed effects:
             Estimate Std. Error z value Pr(&gt;|z|)   
(Intercept)   -0.2229     0.2975  -0.749  0.45370   
femalefemale   0.3632     0.1193   3.044  0.00234 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr)
femalefemal -0.252</code></pre>
<p>There appears to be a fairly strong effect of females such that females tend to get more awards than males. Now we will fit the same models using the glmmADMB package</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="co">## random intercept only model library(glmmADMB) m.alt1 &lt;- glmmadmb(awards ~</span></a>
<a class="sourceLine" id="cb24-2" data-line-number="2"><span class="co">## 1 + (1 | cid), data = dat, family = 'poisson', link = 'log') m.alt2 &lt;-</span></a>
<a class="sourceLine" id="cb24-3" data-line-number="3"><span class="co">## glmmadmb(awards ~ 1 + female + (1 | cid), data = dat, family = 'poisson',</span></a>
<a class="sourceLine" id="cb24-4" data-line-number="4"><span class="co">## link = 'log') summary(m.alt1)</span></a></code></pre></div>
<p>The results from glmmadmb match closely with those from glmer.</p>
</div>
<div id="sleep-study-example" class="section level2">
<h2 class="hasAnchor">
<a href="#sleep-study-example" class="anchor"></a>Sleep Study Example</h2>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(lme4)</a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">require</a></span>(lattice)</a>
<a class="sourceLine" id="cb25-3" data-line-number="3">fm1 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/lmer">lmer</a></span>(Reaction <span class="op">~</span><span class="st"> </span>Days <span class="op">+</span><span class="st"> </span>(Days <span class="op">|</span><span class="st"> </span>Subject), sleepstudy)</a>
<a class="sourceLine" id="cb25-4" data-line-number="4">fm2 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/lmer">lmer</a></span>(Reaction <span class="op">~</span><span class="st"> </span>Days <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>Subject) <span class="op">+</span><span class="st"> </span>(<span class="dv">0</span> <span class="op">+</span><span class="st"> </span>Days <span class="op">|</span><span class="st"> </span>Subject), sleepstudy)</a>
<a class="sourceLine" id="cb25-5" data-line-number="5">fm3 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/lmer">lmer</a></span>(diameter <span class="op">~</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>plate) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>sample), Penicillin)</a>
<a class="sourceLine" id="cb25-6" data-line-number="6"><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/ranef">ranef</a></span>(fm1)</a></code></pre></div>
<pre><code>$Subject
    (Intercept)        Days
308   2.2575329   9.1992737
309 -40.3942719  -8.6205161
310 -38.9563542  -5.4495796
330  23.6888704  -4.8141448
331  22.2585409  -3.0696766
332   9.0387625  -0.2720535
333  16.8389833  -0.2233978
334  -7.2320462   1.0745075
335  -0.3326901 -10.7524799
337  34.8865253   8.6290208
349 -25.2080191   1.1730997
350 -13.0694180   6.6142185
351   4.5777099  -3.0152825
352  20.8614523   3.5364062
369   3.2750882   0.8722876
370 -25.6110745   4.8222518
371   0.8070591  -0.9881730
372  12.3133491   1.2842380

with conditional variances for "Subject" </code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/str">str</a></span>(rr1 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/ranef">ranef</a></span>(fm1, <span class="dt">condVar =</span> <span class="ot">TRUE</span>))</a></code></pre></div>
<pre><code>List of 1
 $ Subject:'data.frame':    18 obs. of  2 variables:
  ..$ (Intercept): num [1:18] 2.26 -40.39 -38.96 23.69 22.26 ...
  ..$ Days       : num [1:18] 9.2 -8.62 -5.45 -4.81 -3.07 ...
  ..- attr(*, "postVar")= num [1:2, 1:2, 1:18] 145.69 -21.44 -21.44 5.31 145.69 ...
 - attr(*, "class")= chr "ranef.mer"</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/lattice/topics/xyplot">dotplot</a></span>(rr1)  <span class="co">## default</span></a></code></pre></div>
<pre><code>$Subject</code></pre>
<p><img src="count-regression-hierarchical-mixedeffect-partII-vignettes_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="co">## specify free scales in order to make Day effects more visible</span></a>
<a class="sourceLine" id="cb31-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/lattice/topics/xyplot">dotplot</a></span>(rr1, <span class="dt">scales =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">x =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">relation =</span> <span class="st">"free"</span>)))[[<span class="st">"Subject"</span>]]</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffect-partII-vignettes_files/figure-html/unnamed-chunk-11-2.png" width="700"></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/ranef">ranef</a></span>(fm2)</a></code></pre></div>
<pre><code>$Subject
    (Intercept)        Days
308   1.5116973   9.3237308
309 -40.3720066  -8.5995358
310 -39.1795117  -5.3880715
330  24.5188072  -4.9686809
331  22.9141930  -3.1939310
332   9.2217762  -0.3084673
333  17.1557243  -0.2871512
334  -7.4516633   1.1159907
335   0.5798353 -10.9062401
337  34.7661741   8.6279628
349 -25.7538155   1.2806250
350 -13.8653871   6.7565202
351   4.9161750  -3.0751926
352  20.9281601   3.5123758
369   3.2584763   0.8730848
370 -26.4756822   4.9838147
371   0.9057286  -1.0053150
372  12.4213189   1.2584805

with conditional variances for "Subject" </code></pre>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1">op &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/options">options</a></span>(<span class="dt">digits =</span> <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb34-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/ranef">ranef</a></span>(fm3, <span class="dt">drop =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>$plate
       a        b        c        d        e        f        g        h 
 0.80454  0.80454  0.18167  0.33739  0.02595 -0.44120 -1.37551  0.80454 
       i        j        k        l        m        n        o        p 
-0.75264 -0.75264  0.96026  0.49311  1.42742  0.49311  0.96026  0.02595 
       q        r        s        t        u        v        w        x 
-0.28548 -0.28548 -1.37551  0.96026 -0.90836 -0.28548 -0.59692 -1.21979 
attr(,"postVar")
 [1] 0.07363 0.07363 0.07363 0.07363 0.07363 0.07363 0.07363 0.07363
 [9] 0.07363 0.07363 0.07363 0.07363 0.07363 0.07363 0.07363 0.07363
[17] 0.07363 0.07363 0.07363 0.07363 0.07363 0.07363 0.07363 0.07363

$sample
       A        B        C        D        E        F 
 2.18706 -1.01048  1.93790 -0.09689 -0.01384 -3.00374 
attr(,"postVar")
[1] 0.04087 0.04087 0.04087 0.04087 0.04087 0.04087

with conditional variances for "plate" "sample" </code></pre>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/options">options</a></span>(op)</a>
<a class="sourceLine" id="cb36-2" data-line-number="2"><span class="co">## as.data.frame() provides RE's and conditional standard deviations:</span></a>
<a class="sourceLine" id="cb36-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/str">str</a></span>(dd &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.data.frame">as.data.frame</a></span>(rr1))</a></code></pre></div>
<pre><code>'data.frame':   36 obs. of  5 variables:
 $ grpvar : chr  "Subject" "Subject" "Subject" "Subject" ...
 $ term   : Factor w/ 2 levels "(Intercept)",..: 1 1 1 1 1 1 1 1 1 1 ...
 $ grp    : Factor w/ 18 levels "309","310","370",..: 9 1 2 17 16 12 14 6 7 18 ...
 $ condval: num  2.26 -40.39 -38.96 23.69 22.26 ...
 $ condsd : num  12.1 12.1 12.1 12.1 12.1 ...</code></pre>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1"><span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">require</a></span>(ggplot2)) {</a>
<a class="sourceLine" id="cb38-2" data-line-number="2">    <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(dd, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">y =</span> grp, <span class="dt">x =</span> condval)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="op">~</span>term, </a>
<a class="sourceLine" id="cb38-3" data-line-number="3">        <span class="dt">scales =</span> <span class="st">"free_x"</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_errorbarh.html">geom_errorbarh</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">xmin =</span> condval <span class="op">-</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>condsd, </a>
<a class="sourceLine" id="cb38-4" data-line-number="4">        <span class="dt">xmax =</span> condval <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>condsd), <span class="dt">height =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb38-5" data-line-number="5">}</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffect-partII-vignettes_files/figure-html/unnamed-chunk-11-3.png" width="700"></p>
</div>
<div id="experiment-with-regressions-mixed-models-or-interaction-terms" class="section level1">
<h1 class="hasAnchor">
<a href="#experiment-with-regressions-mixed-models-or-interaction-terms" class="anchor"></a>Experiment with regressions (mixed models or interaction terms):</h1>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1"><span class="co"># Load packages:</span></a>
<a class="sourceLine" id="cb39-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(caret)</a>
<a class="sourceLine" id="cb39-3" data-line-number="3"></a>
<a class="sourceLine" id="cb39-4" data-line-number="4"><span class="co"># Set seed to insure reproducability:</span></a>
<a class="sourceLine" id="cb39-5" data-line-number="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb39-6" data-line-number="6"></a>
<a class="sourceLine" id="cb39-7" data-line-number="7"><span class="co"># Split randomly into training and testing:</span></a>
<a class="sourceLine" id="cb39-8" data-line-number="8">training_indices =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sample">sample</a></span>(<span class="dt">size =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(modelling_data)[<span class="dv">1</span>]<span class="op">/</span><span class="dv">10</span>), <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(modelling_data)[<span class="dv">1</span>], </a>
<a class="sourceLine" id="cb39-9" data-line-number="9">    <span class="dt">replace =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb39-10" data-line-number="10">modelling_data =<span class="st"> </span>modelling_data[training_indices, ]</a>
<a class="sourceLine" id="cb39-11" data-line-number="11">modelling_data_test =<span class="st"> </span>modelling_data[<span class="op">-</span>training_indices, ]</a>
<a class="sourceLine" id="cb39-12" data-line-number="12"></a>
<a class="sourceLine" id="cb39-13" data-line-number="13"><span class="co"># Compare held out performance of random slopes against interaction term:</span></a>
<a class="sourceLine" id="cb39-14" data-line-number="14">interaction_model =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/glm">glm</a></span>(y <span class="op">~</span><span class="st"> </span>x<span class="op">:</span>groupIdx, modelling_data, <span class="dt">family =</span> <span class="st">"poisson"</span>)</a>
<a class="sourceLine" id="cb39-15" data-line-number="15">random_slopes_model =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/glmer">glmer</a></span>(y <span class="op">~</span><span class="st"> </span>x <span class="op">|</span><span class="st"> </span>groupIdx, modelling_data, <span class="dt">family =</span> <span class="st">"poisson"</span>)</a>
<a class="sourceLine" id="cb39-16" data-line-number="16">confusion_matrix_interaction_model =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/caret/topics/confusionMatrix">confusionMatrix</a></span>(<span class="dt">data =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/logical">as.logical</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(interaction_model, </a>
<a class="sourceLine" id="cb39-17" data-line-number="17">    <span class="dt">newdata =</span> modelling_data_test[, <span class="op">-</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(modelling_data_test) <span class="op">==</span><span class="st"> "y"</span>)], </a>
<a class="sourceLine" id="cb39-18" data-line-number="18">    <span class="dt">type =</span> <span class="st">"response"</span>) <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.5</span>)), <span class="dt">reference =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/logical">as.logical</a></span>(modelling_data_test<span class="op">$</span>y <span class="op">&gt;</span><span class="st"> </span></a>
<a class="sourceLine" id="cb39-19" data-line-number="19"><span class="st">    </span><span class="dv">0</span>)), <span class="dt">positive =</span> <span class="st">"TRUE"</span>)</a>
<a class="sourceLine" id="cb39-20" data-line-number="20">confusion_matrix_random_slopes_model =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/caret/topics/confusionMatrix">confusionMatrix</a></span>(<span class="dt">data =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/logical">as.logical</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(random_slopes_model, </a>
<a class="sourceLine" id="cb39-21" data-line-number="21">    <span class="dt">newdata =</span> modelling_data_test[, <span class="op">-</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(modelling_data_test) <span class="op">==</span><span class="st"> "y"</span>)], </a>
<a class="sourceLine" id="cb39-22" data-line-number="22">    <span class="dt">type =</span> <span class="st">"response"</span>) <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.5</span>)), <span class="dt">reference =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/logical">as.logical</a></span>(modelling_data_test<span class="op">$</span>y <span class="op">&gt;</span><span class="st"> </span></a>
<a class="sourceLine" id="cb39-23" data-line-number="23"><span class="st">    </span><span class="dv">0</span>)), <span class="dt">positive =</span> <span class="st">"TRUE"</span>)</a>
<a class="sourceLine" id="cb39-24" data-line-number="24">confusion_matrix_interaction_model</a></code></pre></div>
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction FALSE TRUE
     FALSE     0    0
     TRUE     11   82
                                          
               Accuracy : 0.8817          
                 95% CI : (0.7982, 0.9395)
    No Information Rate : 0.8817          
    P-Value [Acc &gt; NIR] : 0.579424        
                                          
                  Kappa : 0               
                                          
 Mcnemar's Test P-Value : 0.002569        
                                          
            Sensitivity : 1.0000          
            Specificity : 0.0000          
         Pos Pred Value : 0.8817          
         Neg Pred Value :    NaN          
             Prevalence : 0.8817          
         Detection Rate : 0.8817          
   Detection Prevalence : 1.0000          
      Balanced Accuracy : 0.5000          
                                          
       'Positive' Class : TRUE            
                                          </code></pre>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1">confusion_matrix_random_slopes_model</a></code></pre></div>
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction FALSE TRUE
     FALSE     0    0
     TRUE     11   82
                                          
               Accuracy : 0.8817          
                 95% CI : (0.7982, 0.9395)
    No Information Rate : 0.8817          
    P-Value [Acc &gt; NIR] : 0.579424        
                                          
                  Kappa : 0               
                                          
 Mcnemar's Test P-Value : 0.002569        
                                          
            Sensitivity : 1.0000          
            Specificity : 0.0000          
         Pos Pred Value : 0.8817          
         Neg Pred Value :    NaN          
             Prevalence : 0.8817          
         Detection Rate : 0.8817          
   Detection Prevalence : 1.0000          
      Balanced Accuracy : 0.5000          
                                          
       'Positive' Class : TRUE            
                                          </code></pre>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" data-line-number="1"><span class="co"># and of random intercepts against both terms:</span></a>
<a class="sourceLine" id="cb43-2" data-line-number="2">two_predictors =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/glm">glm</a></span>(y <span class="op">~</span><span class="st"> </span>x<span class="op">:</span>groupIdx, modelling_data, <span class="dt">family =</span> <span class="st">"poisson"</span>)</a>
<a class="sourceLine" id="cb43-3" data-line-number="3">random_intercepts_model =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/glmer">glmer</a></span>(y <span class="op">~</span><span class="st"> </span>x <span class="op">|</span><span class="st"> </span>groupIdx, modelling_data, <span class="dt">family =</span> <span class="st">"poisson"</span>)</a>
<a class="sourceLine" id="cb43-4" data-line-number="4">confusion_matrix_two_predictors =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/caret/topics/confusionMatrix">confusionMatrix</a></span>(<span class="dt">data =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/logical">as.logical</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(two_predictors, </a>
<a class="sourceLine" id="cb43-5" data-line-number="5">    <span class="dt">newdata =</span> modelling_data_test[, <span class="op">-</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(modelling_data_test) <span class="op">==</span><span class="st"> "y"</span>)], </a>
<a class="sourceLine" id="cb43-6" data-line-number="6">    <span class="dt">type =</span> <span class="st">"response"</span>) <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.5</span>)), <span class="dt">reference =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/logical">as.logical</a></span>(modelling_data_test<span class="op">$</span>y <span class="op">&gt;</span><span class="st"> </span></a>
<a class="sourceLine" id="cb43-7" data-line-number="7"><span class="st">    </span><span class="dv">0</span>)), <span class="dt">positive =</span> <span class="st">"TRUE"</span>)</a>
<a class="sourceLine" id="cb43-8" data-line-number="8">confusion_matrix_random_intercepts_model =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/caret/topics/confusionMatrix">confusionMatrix</a></span>(<span class="dt">data =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/logical">as.logical</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(random_intercepts_model, </a>
<a class="sourceLine" id="cb43-9" data-line-number="9">    <span class="dt">newdata =</span> modelling_data_test[, <span class="op">-</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(modelling_data_test) <span class="op">==</span><span class="st"> "y"</span>)], </a>
<a class="sourceLine" id="cb43-10" data-line-number="10">    <span class="dt">type =</span> <span class="st">"response"</span>) <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.5</span>)), <span class="dt">reference =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/logical">as.logical</a></span>(modelling_data_test<span class="op">$</span>y <span class="op">&gt;</span><span class="st"> </span></a>
<a class="sourceLine" id="cb43-11" data-line-number="11"><span class="st">    </span><span class="dv">0</span>)), <span class="dt">positive =</span> <span class="st">"TRUE"</span>)</a>
<a class="sourceLine" id="cb43-12" data-line-number="12">confusion_matrix_two_predictors</a></code></pre></div>
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction FALSE TRUE
     FALSE     0    0
     TRUE     11   82
                                          
               Accuracy : 0.8817          
                 95% CI : (0.7982, 0.9395)
    No Information Rate : 0.8817          
    P-Value [Acc &gt; NIR] : 0.579424        
                                          
                  Kappa : 0               
                                          
 Mcnemar's Test P-Value : 0.002569        
                                          
            Sensitivity : 1.0000          
            Specificity : 0.0000          
         Pos Pred Value : 0.8817          
         Neg Pred Value :    NaN          
             Prevalence : 0.8817          
         Detection Rate : 0.8817          
   Detection Prevalence : 1.0000          
      Balanced Accuracy : 0.5000          
                                          
       'Positive' Class : TRUE            
                                          </code></pre>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" data-line-number="1">confusion_matrix_random_intercepts_model</a></code></pre></div>
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction FALSE TRUE
     FALSE     0    0
     TRUE     11   82
                                          
               Accuracy : 0.8817          
                 95% CI : (0.7982, 0.9395)
    No Information Rate : 0.8817          
    P-Value [Acc &gt; NIR] : 0.579424        
                                          
                  Kappa : 0               
                                          
 Mcnemar's Test P-Value : 0.002569        
                                          
            Sensitivity : 1.0000          
            Specificity : 0.0000          
         Pos Pred Value : 0.8817          
         Neg Pred Value :    NaN          
             Prevalence : 0.8817          
         Detection Rate : 0.8817          
   Detection Prevalence : 1.0000          
      Balanced Accuracy : 0.5000          
                                          
       'Positive' Class : TRUE            
                                          </code></pre>
<p>The simulated data are generated with 5 random intercepts and a shared slope for the log rate in a Poisson regression. On this simulated data, the random slopes performs slightly better on test data than the interacting predictors model. The random intercepts performs slightly better on test data than the two predictors model.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#student-data-exaple">Student Data Exaple</a></li>
      <li><a href="#awards-by-school">awards by school</a></li>
      <li><a href="#sleep-study-example">Sleep Study Example</a></li>
      <li><a href="#experiment-with-regressions-mixed-models-or-interaction-terms">Experiment with regressions (mixed models or interaction terms):</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Bruce Campbell.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
