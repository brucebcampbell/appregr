<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Heirarchical / Mixed Effects â€¢ appregr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Heirarchical / Mixed Effects">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">appregr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/count-regression-bayesian-vignette.html">Count Regression Part II - Bayesian Approaches</a>
    </li>
    <li>
      <a href="../articles/count-regression-hierarchical-mixedeffect-partII-vignettes.html">Count Regression Part III - Heirarchical / Mixed Effects</a>
    </li>
    <li>
      <a href="../articles/count-regression-hierarchical-mixedeffects-vignette.html"> Heirarchical / Mixed Effects</a>
    </li>
    <li>
      <a href="../articles/count-regression-vignette.html">Count Regression</a>
    </li>
    <li>
      <a href="../articles/regression-diagnositcs-vignette.html">regression-diagnostics-vignette</a>
    </li>
    <li>
      <a href="../articles/regression-numerical-linalg-vignette.html">regression-numerical-linalg-vignette</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Heirarchical / Mixed Effects</h1>
            <h3 class="subtitle">A tutorial on count regression</h3>
                        <h4 class="author">Bruce Campbell</h4>
            
            <h4 class="date">25 July, 2019</h4>
      
      
      <div class="hidden name"><code>count-regression-hierarchical-mixedeffects-vignette.Rmd</code></div>

    </div>

    
    
<div id="linear-mixed-effects" class="section level1">
<h1 class="hasAnchor">
<a href="#linear-mixed-effects" class="anchor"></a>Linear Mixed Effects</h1>
<p>Mixed-effects or mixed models have covariates with both fixed and random effects. The values for at least one set of effects (intercepts and/or slopes) to come from a normal distribution.This is what the random-effects assumption means. A close examination of how such a dataset can be simulated will help us better understand how real datasets are estimated down using mixed models. Very few strategies can be more effective to understand this type of mixed model than the combination of simulating data sets and describing the models fitted.</p>
<div id="model-types" class="section level3">
<h3 class="hasAnchor">
<a href="#model-types" class="anchor"></a>Model Types</h3>
<ul>
<li>random intercepts only</li>
<li>independent random intercepts and slopes</li>
<li>correlated random intercepts and slopes</li>
<li>modeling 2 correlated random effects with a scaled Inverse Wishart instead</li>
<li>general correlated random effects with a scaled Inverse Wishart</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">n_subjects &lt;-<span class="st"> </span><span class="dv">56</span>  <span class="co"># Number of subjects</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">n_sample &lt;-<span class="st"> </span><span class="dv">10</span>  <span class="co"># Number of observations for each subject</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">n_obs &lt;-<span class="st"> </span>n_subjects <span class="op">*</span><span class="st"> </span>n_sample  <span class="co"># Total number of data points</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">subjects &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/gl">gl</a></span>(<span class="dt">n =</span> n_subjects, <span class="dt">k =</span> n_sample)  <span class="co"># Indicator for subjects</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co"># Continuous predictor x</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7">original_x &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(n_obs, <span class="dv">45</span>, <span class="dv">70</span>)</a>
<a class="sourceLine" id="cb1-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="co"># standardize it</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10">mean_orig_x &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(original_x)</a>
<a class="sourceLine" id="cb1-11" data-line-number="11">sd_orig_x &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/sd">sd</a></span>(original_x)</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">x &lt;-<span class="st"> </span>(original_x <span class="op">-</span><span class="st"> </span>mean_orig_x)<span class="op">/</span>sd_orig_x</a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(x)</a></code></pre></div>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
-1.7807 -0.8637  0.1005  0.0000  0.8950  1.7092 </code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(x, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">breaks =</span> <span class="dv">10</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(x), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-1-1.png" width="700"></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># This is the model matrix for the means parametrization of the interaction</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co"># model between the subjects and the continuous covariate x</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">Xmat &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/model.matrix">model.matrix</a></span>(<span class="op">~</span>subjects <span class="op">*</span><span class="st"> </span>x <span class="op">-</span><span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>x)</a></code></pre></div>
<p>Parameters for the distributions of the random coefficients / random effects (note that the intercepts and slopes comes from two independent Gaussian distributions)</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">intercept_mean &lt;-<span class="st"> </span><span class="dv">230</span>  <span class="co"># mu_alpha</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">intercept_sd &lt;-<span class="st"> </span><span class="dv">20</span>  <span class="co"># sigma_alpha</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">slope_mean &lt;-<span class="st"> </span><span class="dv">60</span>  <span class="co"># mu_beta</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">slope_sd &lt;-<span class="st"> </span><span class="dv">30</span>  <span class="co"># sigma_beta</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="co"># Generate the random coefficients:</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"></a>
<a class="sourceLine" id="cb5-9" data-line-number="9">intercept_effects &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dt">n =</span> n_subjects, <span class="dt">mean =</span> intercept_mean, <span class="dt">sd =</span> intercept_sd)</a>
<a class="sourceLine" id="cb5-10" data-line-number="10">slope_effects &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dt">n =</span> n_subjects, <span class="dt">mean =</span> slope_mean, <span class="dt">sd =</span> slope_sd)</a>
<a class="sourceLine" id="cb5-11" data-line-number="11"></a>
<a class="sourceLine" id="cb5-12" data-line-number="12"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb5-13" data-line-number="13"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(intercept_effects, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">breaks =</span> <span class="dv">10</span>, </a>
<a class="sourceLine" id="cb5-14" data-line-number="14">    <span class="dt">freq =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb5-15" data-line-number="15"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(intercept_effects), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb5-16" data-line-number="16"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(slope_effects, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">breaks =</span> <span class="dv">10</span>, </a>
<a class="sourceLine" id="cb5-17" data-line-number="17">    <span class="dt">freq =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb5-18" data-line-number="18"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(slope_effects), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">all_effects &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(intercept_effects, slope_effects)  <span class="co"># Put them all together</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co"># Generating the continuous response variable:</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">lin_pred &lt;-<span class="st"> </span>Xmat <span class="op">%*%</span><span class="st"> </span>all_effects  <span class="co"># Value of lin_predictor</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/str">str</a></span>(lin_pred)</a></code></pre></div>
<pre><code> num [1:560, 1] 79.2 58.2 320.2 147.3 234.1 ...
 - attr(*, "dimnames")=List of 2
  ..$ : chr [1:560] "1" "2" "3" "4" ...
  ..$ : NULL</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co"># -- the stochastic part</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">sigma_res &lt;-<span class="st"> </span><span class="dv">30</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">normal_error &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dt">n =</span> n_obs, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> sigma_res)  <span class="co"># residuals</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">y &lt;-<span class="st"> </span>lin_pred <span class="op">+</span><span class="st"> </span>normal_error</a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="co"># alternatively y &lt;- rnorm(n = n_obs, mean = lin_pred, sd = sigma_res)</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7"></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="co"># We take a look at the response variable</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(y, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">breaks =</span> <span class="dv">30</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb8-10" data-line-number="10"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(y), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-2-2.png" width="700"></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(y)</a></code></pre></div>
<pre><code>       V1        
 Min.   :-16.65  
 1st Qu.:181.62  
 Median :228.59  
 Mean   :227.65  
 3rd Qu.:276.27  
 Max.   :426.15  </code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"lattice"</span>)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/lattice/topics/xyplot">xyplot</a></span>(y <span class="op">~</span><span class="st"> </span>x <span class="op">|</span><span class="st"> </span>subjects)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-2-3.png" width="700"></p>
</div>
<div id="reml-analysis-using-r-lme4" class="section level3">
<h3 class="hasAnchor">
<a href="#reml-analysis-using-r-lme4" class="anchor"></a>REML analysis using R lme4</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"lme4"</span>)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">lme_fit1 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/lmer">lmer</a></span>(y <span class="op">~</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>subjects))</a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(lme_fit1, <span class="dt">cor =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ x + (1 | subjects)
REML criterion at convergence: 5836.124
Random effects:
 Groups   Name        Std.Dev.
 subjects (Intercept) 23.31   
 Residual             41.65   
Number of obs: 560, groups:  subjects, 56
Fixed Effects:
(Intercept)            x  
      227.7         55.6  </code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme_fit1)</a></code></pre></div>
<pre><code>(Intercept)           x 
  227.65177    55.59795 </code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/ranef">ranef</a></span>(lme_fit1), <span class="dt">main =</span> <span class="st">"fitted random effects"</span>)</a></code></pre></div>
<pre><code>$subjects</code></pre>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">coef.re &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/coef">coef</a></span>(lme_fit1)</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(coef.re[[<span class="dv">1</span>]][, <span class="dv">1</span>], coef.re[[<span class="dv">1</span>]][, <span class="dv">2</span>], <span class="dt">main =</span> <span class="st">"Coefficients "</span>, <span class="dt">ylab =</span> <span class="st">"(Intercept)"</span>, </a>
<a class="sourceLine" id="cb18-3" data-line-number="3">    <span class="dt">xlab =</span> <span class="st">"x"</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-3-2.png" width="700"></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="co"># Compare with true values:</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">intercept_mean =</span> intercept_mean, <span class="dt">slope_mean =</span> slope_mean, <span class="dt">intercept_sd =</span> intercept_sd, </a>
<a class="sourceLine" id="cb19-3" data-line-number="3">    <span class="dt">slope_sd =</span> slope_sd, <span class="dt">sigma_res =</span> sigma_res)</a></code></pre></div>
<pre><code>  intercept_mean slope_mean intercept_sd slope_sd sigma_res
1            230         60           20       30        30</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(lme_fit1, <span class="dt">cor =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ x + (1 | subjects)
REML criterion at convergence: 5836.124
Random effects:
 Groups   Name        Std.Dev.
 subjects (Intercept) 23.31   
 Residual             41.65   
Number of obs: 560, groups:  subjects, 56
Fixed Effects:
(Intercept)            x  
      227.7         55.6  </code></pre>
</div>
<div id="bayesian-hierarchical-analysis-using-jags" class="section level2">
<h2 class="hasAnchor">
<a href="#bayesian-hierarchical-analysis-using-jags" class="anchor"></a>Bayesian hierarchical analysis using JAGS</h2>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="co"># Write model</span></a>
<a class="sourceLine" id="cb23-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">"model {</span></a>
<a class="sourceLine" id="cb23-3" data-line-number="3"><span class="st"># Priors</span></a>
<a class="sourceLine" id="cb23-4" data-line-number="4"><span class="st">mu_int~dnorm(0, 0.0001) # Mean hyperparameter for random intercepts</span></a>
<a class="sourceLine" id="cb23-5" data-line-number="5"><span class="st">sigma_int~dunif(0, 100) # SD hyperparameter for random intercepts</span></a>
<a class="sourceLine" id="cb23-6" data-line-number="6"><span class="st">tau_int &lt;- 1/(sigma_int*sigma_int)</span></a>
<a class="sourceLine" id="cb23-7" data-line-number="7"><span class="st">for (i in 1:n_subj) {</span></a>
<a class="sourceLine" id="cb23-8" data-line-number="8"><span class="st">    alpha[i]~dnorm(mu_int, tau_int) # Random intercepts</span></a>
<a class="sourceLine" id="cb23-9" data-line-number="9"><span class="st">}</span></a>
<a class="sourceLine" id="cb23-10" data-line-number="10"><span class="st">beta~dnorm(0, 0.0001) # Common slope</span></a>
<a class="sourceLine" id="cb23-11" data-line-number="11"><span class="st">sigma_res~dunif(0, 100) # Residual standard deviation</span></a>
<a class="sourceLine" id="cb23-12" data-line-number="12"><span class="st">tau_res &lt;- 1/(sigma_res*sigma_res)</span></a>
<a class="sourceLine" id="cb23-13" data-line-number="13"><span class="st"># Likelihood</span></a>
<a class="sourceLine" id="cb23-14" data-line-number="14"><span class="st">for (i in 1:n_obs) {</span></a>
<a class="sourceLine" id="cb23-15" data-line-number="15"><span class="st">    mu[i] &lt;- alpha[subjects[i]]+beta*x[i] # Expectation</span></a>
<a class="sourceLine" id="cb23-16" data-line-number="16"><span class="st">    y[i]~dnorm(mu[i], tau_res) # The actual (random) responses</span></a>
<a class="sourceLine" id="cb23-17" data-line-number="17"><span class="st">}</span></a>
<a class="sourceLine" id="cb23-18" data-line-number="18"><span class="st">}"</span>, </a>
<a class="sourceLine" id="cb23-19" data-line-number="19">    <span class="dt">fill =</span> <span class="ot">TRUE</span>, <span class="dt">file =</span> <span class="st">"lme_model1.txt"</span>)</a>
<a class="sourceLine" id="cb23-20" data-line-number="20"></a>
<a class="sourceLine" id="cb23-21" data-line-number="21"></a>
<a class="sourceLine" id="cb23-22" data-line-number="22">jags_data &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(y), <span class="dt">subjects =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(subjects), <span class="dt">x =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(x), </a>
<a class="sourceLine" id="cb23-23" data-line-number="23">    <span class="dt">n_subj =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(subjects)), <span class="dt">n_obs =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(n_obs))</a>
<a class="sourceLine" id="cb23-24" data-line-number="24"><span class="co"># use as.numeric across the board for the data passed to JAGS; it might work</span></a>
<a class="sourceLine" id="cb23-25" data-line-number="25"><span class="co"># w/o it, but this is often needed for other BUGS packages</span></a>
<a class="sourceLine" id="cb23-26" data-line-number="26"></a>
<a class="sourceLine" id="cb23-27" data-line-number="27"><span class="co"># Inits function</span></a>
<a class="sourceLine" id="cb23-28" data-line-number="28">inits &lt;-<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb23-29" data-line-number="29">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">alpha =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(n_subjects, <span class="dv">0</span>, <span class="dv">2</span>), <span class="dt">beta =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>), <span class="dt">mu_int =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">1</span>, </a>
<a class="sourceLine" id="cb23-30" data-line-number="30">        <span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">sigma_int =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Lognormal">rlnorm</a></span>(<span class="dv">1</span>), <span class="dt">sigma_res =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Lognormal">rlnorm</a></span>(<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb23-31" data-line-number="31">}</a>
<a class="sourceLine" id="cb23-32" data-line-number="32"></a>
<a class="sourceLine" id="cb23-33" data-line-number="33"><span class="co"># Parameters to estimate</span></a>
<a class="sourceLine" id="cb23-34" data-line-number="34">params &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"mu_int"</span>, <span class="st">"sigma_int"</span>, <span class="st">"sigma_res"</span>)</a>
<a class="sourceLine" id="cb23-35" data-line-number="35"></a>
<a class="sourceLine" id="cb23-36" data-line-number="36"><span class="co"># MCMC settings</span></a>
<a class="sourceLine" id="cb23-37" data-line-number="37">ni &lt;-<span class="st"> </span><span class="dv">11000</span></a>
<a class="sourceLine" id="cb23-38" data-line-number="38">nb &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb23-39" data-line-number="39">nt &lt;-<span class="st"> </span><span class="dv">20</span></a>
<a class="sourceLine" id="cb23-40" data-line-number="40">nc &lt;-<span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb23-41" data-line-number="41"></a>
<a class="sourceLine" id="cb23-42" data-line-number="42"><span class="co"># Start Gibbs sampling</span></a>
<a class="sourceLine" id="cb23-43" data-line-number="43"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"R2jags"</span>)</a>
<a class="sourceLine" id="cb23-44" data-line-number="44">outj &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/R2jags/topics/jags">jags</a></span>(jags_data, <span class="dt">inits =</span> inits, <span class="dt">parameters.to.save =</span> params, <span class="dt">model.file =</span> <span class="st">"lme_model1.txt"</span>, </a>
<a class="sourceLine" id="cb23-45" data-line-number="45">    <span class="dt">n.thin =</span> nt, <span class="dt">n.chains =</span> nc, <span class="dt">n.burnin =</span> nb, <span class="dt">n.iter =</span> ni)</a></code></pre></div>
<pre><code>Compiling model graph
   Resolving undeclared variables
   Allocating nodes
Graph information:
   Observed stochastic nodes: 560
   Unobserved stochastic nodes: 60
   Total graph size: 2870

Initializing model</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">out &lt;-<span class="st"> </span>outj<span class="op">$</span>BUGSoutput</a>
<a class="sourceLine" id="cb25-2" data-line-number="2"></a>
<a class="sourceLine" id="cb25-3" data-line-number="3"><span class="co"># Compare with MLEs and true values</span></a>
<a class="sourceLine" id="cb25-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">intercept_mean =</span> intercept_mean, <span class="dt">slope_mean =</span> slope_mean, <span class="dt">intercept_sd =</span> intercept_sd, </a>
<a class="sourceLine" id="cb25-5" data-line-number="5">    <span class="dt">slope_sd =</span> slope_sd, <span class="dt">sigma_res =</span> sigma_res)</a></code></pre></div>
<pre><code>  intercept_mean slope_mean intercept_sd slope_sd sigma_res
1            230         60           20       30        30</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(out<span class="op">$</span>mean, <span class="dt">dig =</span> <span class="dv">4</span>)</a></code></pre></div>
<pre><code>$alpha
 [1] 222.9 234.1 230.7 229.5 245.3 217.7 209.4 237.4 215.4 206.4 218.5
[12] 220.7 194.4 239.3 239.0 264.4 210.7 221.6 242.1 230.6 202.7 223.7
[23] 213.5 247.3 226.3 193.8 198.1 251.8 264.8 234.4 210.0 248.7 215.3
[34] 200.0 227.5 223.8 222.4 228.1 249.6 218.5 209.5 245.9 252.4 256.0
[45] 208.2 208.6 185.7 235.0 244.6 257.5 269.5 256.5 249.9 232.3 195.0
[56] 207.9

$beta
[1] 55.54

$deviance
[1] 5767

$mu_int
[1] 227.3

$sigma_int
[1] 23.87

$sigma_res
[1] 41.78</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(lme_fit1, <span class="dt">cor =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ x + (1 | subjects)
REML criterion at convergence: 5836.124
Random effects:
 Groups   Name        Std.Dev.
 subjects (Intercept) 23.31   
 Residual             41.65   
Number of obs: 560, groups:  subjects, 56
Fixed Effects:
(Intercept)            x  
      227.7         55.6  </code></pre>
<p>The same model can be parametrized by making the mean of the intercept ranefs a fixed effect and modeling the subject ranefs as coming from a normal distribution centered at 0. This is in fact how the lmer function models ranefs.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">"model {</span></a>
<a class="sourceLine" id="cb31-2" data-line-number="2"><span class="st"># Priors</span></a>
<a class="sourceLine" id="cb31-3" data-line-number="3"><span class="st">sigma_int~dunif(0, 100) # SD hyperparameter for random intercepts</span></a>
<a class="sourceLine" id="cb31-4" data-line-number="4"><span class="st">tau_int &lt;- 1/(sigma_int*sigma_int)</span></a>
<a class="sourceLine" id="cb31-5" data-line-number="5"><span class="st">for (i in 1:n_subj) {</span></a>
<a class="sourceLine" id="cb31-6" data-line-number="6"><span class="st">    alpha[i]~dnorm(0, tau_int) # Random by-subject deflections to the intercept</span></a>
<a class="sourceLine" id="cb31-7" data-line-number="7"><span class="st">}</span></a>
<a class="sourceLine" id="cb31-8" data-line-number="8"><span class="st">mu_int~dnorm(0, 0.0001) # The mean intercept</span></a>
<a class="sourceLine" id="cb31-9" data-line-number="9"><span class="st">beta~dnorm(0, 0.0001) # Common slope</span></a>
<a class="sourceLine" id="cb31-10" data-line-number="10"><span class="st">sigma_res~dunif(0, 100) # Residual standard deviation</span></a>
<a class="sourceLine" id="cb31-11" data-line-number="11"><span class="st">tau_res &lt;- 1/(sigma_res*sigma_res)</span></a>
<a class="sourceLine" id="cb31-12" data-line-number="12"><span class="st"># Likelihood</span></a>
<a class="sourceLine" id="cb31-13" data-line-number="13"><span class="st">for (i in 1:n_obs) {</span></a>
<a class="sourceLine" id="cb31-14" data-line-number="14"><span class="st">    mu[i] &lt;- mu_int + alpha[subjects[i]] + beta*x[i] # Expectation</span></a>
<a class="sourceLine" id="cb31-15" data-line-number="15"><span class="st">    y[i]~dnorm(mu[i], tau_res) # The actual (random) responses</span></a>
<a class="sourceLine" id="cb31-16" data-line-number="16"><span class="st">}</span></a>
<a class="sourceLine" id="cb31-17" data-line-number="17"><span class="st">}"</span>, </a>
<a class="sourceLine" id="cb31-18" data-line-number="18">    <span class="dt">fill =</span> <span class="ot">TRUE</span>, <span class="dt">file =</span> <span class="st">"lme_model1_1.txt"</span>)</a>
<a class="sourceLine" id="cb31-19" data-line-number="19"></a>
<a class="sourceLine" id="cb31-20" data-line-number="20"><span class="co"># Bundle data</span></a>
<a class="sourceLine" id="cb31-21" data-line-number="21">jags_data &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(y), <span class="dt">subjects =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(subjects), <span class="dt">x =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(x), </a>
<a class="sourceLine" id="cb31-22" data-line-number="22">    <span class="dt">n_subj =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(subjects)), <span class="dt">n_obs =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(n_obs))</a>
<a class="sourceLine" id="cb31-23" data-line-number="23"><span class="co"># use as.numeric across the board for the data passed to JAGS; it might work</span></a>
<a class="sourceLine" id="cb31-24" data-line-number="24"><span class="co"># w/o it, but this is often needed for other BUGS packages</span></a>
<a class="sourceLine" id="cb31-25" data-line-number="25"></a>
<a class="sourceLine" id="cb31-26" data-line-number="26"><span class="co"># Inits function</span></a>
<a class="sourceLine" id="cb31-27" data-line-number="27">inits &lt;-<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb31-28" data-line-number="28">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">alpha =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(n_subjects, <span class="dv">0</span>, <span class="dv">2</span>), <span class="dt">beta =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>), <span class="dt">mu_int =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">1</span>, </a>
<a class="sourceLine" id="cb31-29" data-line-number="29">        <span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">sigma_int =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Lognormal">rlnorm</a></span>(<span class="dv">1</span>), <span class="dt">sigma_res =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Lognormal">rlnorm</a></span>(<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb31-30" data-line-number="30">}</a>
<a class="sourceLine" id="cb31-31" data-line-number="31"></a>
<a class="sourceLine" id="cb31-32" data-line-number="32"><span class="co"># Parameters to estimate</span></a>
<a class="sourceLine" id="cb31-33" data-line-number="33">params &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"mu_int"</span>, <span class="st">"sigma_int"</span>, <span class="st">"sigma_res"</span>)</a>
<a class="sourceLine" id="cb31-34" data-line-number="34"></a>
<a class="sourceLine" id="cb31-35" data-line-number="35"><span class="co"># MCMC settings</span></a>
<a class="sourceLine" id="cb31-36" data-line-number="36">ni &lt;-<span class="st"> </span><span class="dv">11000</span></a>
<a class="sourceLine" id="cb31-37" data-line-number="37">nb &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb31-38" data-line-number="38">nt &lt;-<span class="st"> </span><span class="dv">20</span></a>
<a class="sourceLine" id="cb31-39" data-line-number="39">nc &lt;-<span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb31-40" data-line-number="40"></a>
<a class="sourceLine" id="cb31-41" data-line-number="41"><span class="co"># Start Gibbs sampling</span></a>
<a class="sourceLine" id="cb31-42" data-line-number="42"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"R2jags"</span>)</a>
<a class="sourceLine" id="cb31-43" data-line-number="43">outj &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/R2jags/topics/jags">jags</a></span>(jags_data, <span class="dt">inits =</span> inits, <span class="dt">parameters.to.save =</span> params, <span class="dt">model.file =</span> <span class="st">"lme_model1_1.txt"</span>, </a>
<a class="sourceLine" id="cb31-44" data-line-number="44">    <span class="dt">n.thin =</span> nt, <span class="dt">n.chains =</span> nc, <span class="dt">n.burnin =</span> nb, <span class="dt">n.iter =</span> ni)</a></code></pre></div>
<pre><code>Compiling model graph
   Resolving undeclared variables
   Allocating nodes
Graph information:
   Observed stochastic nodes: 560
   Unobserved stochastic nodes: 60
   Total graph size: 2870

Initializing model</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1">out &lt;-<span class="st"> </span>outj<span class="op">$</span>BUGSoutput</a>
<a class="sourceLine" id="cb33-2" data-line-number="2"></a>
<a class="sourceLine" id="cb33-3" data-line-number="3"><span class="co"># Compare with MLEs and true values</span></a>
<a class="sourceLine" id="cb33-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">intercept_mean =</span> intercept_mean, <span class="dt">slope_mean =</span> slope_mean, <span class="dt">intercept_sd =</span> intercept_sd, </a>
<a class="sourceLine" id="cb33-5" data-line-number="5">    <span class="dt">slope_sd =</span> slope_sd, <span class="dt">sigma_res =</span> sigma_res)</a></code></pre></div>
<pre><code>  intercept_mean slope_mean intercept_sd slope_sd sigma_res
1            230         60           20       30        30</code></pre>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(out<span class="op">$</span>mean, <span class="dt">dig =</span> <span class="dv">4</span>)</a></code></pre></div>
<pre><code>$alpha
 [1]  -4.7688   6.4754   3.2052   1.4666  17.7412  -9.8150 -17.6724
 [8]  10.4953 -11.9445 -20.8244  -7.7176  -6.5470 -33.3224  12.1604
[15]  11.7383  37.1071 -15.9736  -6.0369  14.6778   3.4286 -24.9014
[22]  -3.7411 -14.5913  20.0820  -0.8918 -33.5329 -28.8385  24.7047
[29]  37.4330   6.7121 -17.4807  20.9795 -12.4667 -27.4435  -0.3148
[36]  -3.3117  -3.9846   1.4395  22.4318  -9.1106 -17.4010  18.6826
[43]  25.6325  28.6196 -18.6818 -19.1975 -41.1431   7.3613  17.9411
[50]  30.3922  41.6440  30.0820  22.7628   4.2200 -31.8723 -19.5805

$beta
[1] 55.69

$deviance
[1] 5768

$mu_int
[1] 227.3

$sigma_int
[1] 23.88

$sigma_res
[1] 41.8</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(lme_fit1, <span class="dt">cor =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ x + (1 | subjects)
REML criterion at convergence: 5836.124
Random effects:
 Groups   Name        Std.Dev.
 subjects (Intercept) 23.31   
 Residual             41.65   
Number of obs: 560, groups:  subjects, 56
Fixed Effects:
(Intercept)            x  
      227.7         55.6  </code></pre>
<div id="analysis-under-a-random-coefficients-model-without-correlation-between-intercept-and-slope" class="section level3">
<h3 class="hasAnchor">
<a href="#analysis-under-a-random-coefficients-model-without-correlation-between-intercept-and-slope" class="anchor"></a>Analysis under a random-coefficients model without correlation between intercept and slope</h3>
<p>REML analysis using Râ€™s lme4 - which extends nlme with additional respone and link options</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1">lme_fit2 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/lmer">lmer</a></span>(y <span class="op">~</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>subjects) <span class="op">+</span><span class="st"> </span>(<span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x <span class="op">|</span><span class="st"> </span>subjects))</a>
<a class="sourceLine" id="cb39-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(lme_fit2, <span class="dt">cor =</span> F)</a></code></pre></div>
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ x + (1 | subjects) + (0 + x | subjects)
REML criterion at convergence: 5644.788
Random effects:
 Groups     Name        Std.Dev.
 subjects   (Intercept) 23.42   
 subjects.1 x           29.45   
 Residual               30.67   
Number of obs: 560, groups:  subjects, 56
Fixed Effects:
(Intercept)            x  
     228.50        54.52  </code></pre>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme_fit2)</a></code></pre></div>
<pre><code>(Intercept)           x 
  228.49788    54.52382 </code></pre>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/ranef">ranef</a></span>(lme_fit2)[[<span class="dv">1</span>]][, <span class="dv">1</span>], <span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/ranef">ranef</a></span>(lme_fit2)[[<span class="dv">1</span>]][, <span class="dv">2</span>], <span class="dt">main =</span> <span class="st">"fitted random effects"</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" data-line-number="1">coef.re &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/coef">coef</a></span>(lme_fit2)</a>
<a class="sourceLine" id="cb44-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(coef.re[[<span class="dv">1</span>]][, <span class="dv">1</span>], coef.re[[<span class="dv">1</span>]][, <span class="dv">2</span>], <span class="dt">main =</span> <span class="st">"Coefficients "</span>, <span class="dt">ylab =</span> <span class="st">"(Intercept)"</span>, </a>
<a class="sourceLine" id="cb44-3" data-line-number="3">    <span class="dt">xlab =</span> <span class="st">"x"</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-6-2.png" width="700"></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(lme_fit2, <span class="dt">cor =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ x + (1 | subjects) + (0 + x | subjects)
REML criterion at convergence: 5644.788
Random effects:
 Groups     Name        Std.Dev.
 subjects   (Intercept) 23.42   
 subjects.1 x           29.45   
 Residual               30.67   
Number of obs: 560, groups:  subjects, 56
Fixed Effects:
(Intercept)            x  
     228.50        54.52  </code></pre>
</div>
<div id="bayesian-analysis-using-jags-of-a-random-coefficients-model-without-correlation-between-intercept-and-slope" class="section level3">
<h3 class="hasAnchor">
<a href="#bayesian-analysis-using-jags-of-a-random-coefficients-model-without-correlation-between-intercept-and-slope" class="anchor"></a>Bayesian analysis using JAGS of a random-coefficients model without correlation between intercept and slope</h3>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb47-1" data-line-number="1"><span class="co"># Define model</span></a>
<a class="sourceLine" id="cb47-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">"model {</span></a>
<a class="sourceLine" id="cb47-3" data-line-number="3"><span class="st"># Priors</span></a>
<a class="sourceLine" id="cb47-4" data-line-number="4"><span class="st">mu_int~dnorm(0, 0.001) # Mean hyperparameter for random intercepts</span></a>
<a class="sourceLine" id="cb47-5" data-line-number="5"><span class="st">sigma_int~dunif(0, 100) # SD hyperparameter for random intercepts</span></a>
<a class="sourceLine" id="cb47-6" data-line-number="6"><span class="st">tau_int &lt;- 1/(sigma_int*sigma_int)</span></a>
<a class="sourceLine" id="cb47-7" data-line-number="7"><span class="st">mu_slope~dnorm(0, 0.001) # Mean hyperparameter for random slopes</span></a>
<a class="sourceLine" id="cb47-8" data-line-number="8"><span class="st">sigma_slope~dunif(0, 100) # SD hyperparameter for slopes</span></a>
<a class="sourceLine" id="cb47-9" data-line-number="9"><span class="st">tau_slope &lt;- 1/(sigma_slope*sigma_slope)</span></a>
<a class="sourceLine" id="cb47-10" data-line-number="10"><span class="st">for (i in 1:n_subj) {</span></a>
<a class="sourceLine" id="cb47-11" data-line-number="11"><span class="st">    alpha[i]~dnorm(mu_int, tau_int) # Random intercepts</span></a>
<a class="sourceLine" id="cb47-12" data-line-number="12"><span class="st">    beta[i]~dnorm(mu_slope, tau_slope) # Random slopes</span></a>
<a class="sourceLine" id="cb47-13" data-line-number="13"><span class="st">}</span></a>
<a class="sourceLine" id="cb47-14" data-line-number="14"><span class="st">sigma_res~dunif(0, 100) # Residual standard deviation</span></a>
<a class="sourceLine" id="cb47-15" data-line-number="15"><span class="st">tau_res &lt;- 1/(sigma_res*sigma_res) # Residual precision</span></a>
<a class="sourceLine" id="cb47-16" data-line-number="16"><span class="st"># Likelihood</span></a>
<a class="sourceLine" id="cb47-17" data-line-number="17"><span class="st">for (i in 1:n_obs) {</span></a>
<a class="sourceLine" id="cb47-18" data-line-number="18"><span class="st">    mu[i] &lt;- alpha[subjects[i]]+beta[subjects[i]]*x[i]</span></a>
<a class="sourceLine" id="cb47-19" data-line-number="19"><span class="st">    y[i]~dnorm(mu[i], tau_res)</span></a>
<a class="sourceLine" id="cb47-20" data-line-number="20"><span class="st">}</span></a>
<a class="sourceLine" id="cb47-21" data-line-number="21"><span class="st">}"</span>, </a>
<a class="sourceLine" id="cb47-22" data-line-number="22">    <span class="dt">fill =</span> <span class="ot">TRUE</span>, <span class="dt">file =</span> <span class="st">"lme_model2.txt"</span>)</a>
<a class="sourceLine" id="cb47-23" data-line-number="23"></a>
<a class="sourceLine" id="cb47-24" data-line-number="24"><span class="co"># Bundle data</span></a>
<a class="sourceLine" id="cb47-25" data-line-number="25">jags_data &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(y), <span class="dt">subjects =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(subjects), <span class="dt">x =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(x), </a>
<a class="sourceLine" id="cb47-26" data-line-number="26">    <span class="dt">n_subj =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(subjects)), <span class="dt">n_obs =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(n_obs))</a>
<a class="sourceLine" id="cb47-27" data-line-number="27"></a>
<a class="sourceLine" id="cb47-28" data-line-number="28"><span class="co"># Inits function</span></a>
<a class="sourceLine" id="cb47-29" data-line-number="29">inits &lt;-<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb47-30" data-line-number="30">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">alpha =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(n_subjects, <span class="dv">0</span>, <span class="dv">2</span>), <span class="dt">beta =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(n_subjects, <span class="dv">10</span>, <span class="dv">2</span>), <span class="dt">mu_int =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">1</span>, </a>
<a class="sourceLine" id="cb47-31" data-line-number="31">        <span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">sigma_int =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Lognormal">rlnorm</a></span>(<span class="dv">1</span>), <span class="dt">mu_slope =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">sigma_slope =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Lognormal">rlnorm</a></span>(<span class="dv">1</span>), </a>
<a class="sourceLine" id="cb47-32" data-line-number="32">        <span class="dt">sigma_res =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Lognormal">rlnorm</a></span>(<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb47-33" data-line-number="33">}</a>
<a class="sourceLine" id="cb47-34" data-line-number="34"></a>
<a class="sourceLine" id="cb47-35" data-line-number="35"><span class="co"># Parameters to estimate</span></a>
<a class="sourceLine" id="cb47-36" data-line-number="36">params &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"mu_int"</span>, <span class="st">"sigma_int"</span>, <span class="st">"mu_slope"</span>, <span class="st">"sigma_slope"</span>, </a>
<a class="sourceLine" id="cb47-37" data-line-number="37">    <span class="st">"sigma_res"</span>)</a>
<a class="sourceLine" id="cb47-38" data-line-number="38"></a>
<a class="sourceLine" id="cb47-39" data-line-number="39"><span class="co"># MCMC settings</span></a>
<a class="sourceLine" id="cb47-40" data-line-number="40">ni &lt;-<span class="st"> </span><span class="dv">11000</span></a>
<a class="sourceLine" id="cb47-41" data-line-number="41">nb &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb47-42" data-line-number="42">nt &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb47-43" data-line-number="43">nc &lt;-<span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb47-44" data-line-number="44"></a>
<a class="sourceLine" id="cb47-45" data-line-number="45"><span class="co"># Start Gibbs sampling</span></a>
<a class="sourceLine" id="cb47-46" data-line-number="46"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"R2jags"</span>)</a>
<a class="sourceLine" id="cb47-47" data-line-number="47">outj &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/R2jags/topics/jags">jags</a></span>(jags_data, <span class="dt">inits =</span> inits, <span class="dt">parameters.to.save =</span> params, <span class="dt">model.file =</span> <span class="st">"lme_model2.txt"</span>, </a>
<a class="sourceLine" id="cb47-48" data-line-number="48">    <span class="dt">n.thin =</span> nt, <span class="dt">n.chains =</span> nc, <span class="dt">n.burnin =</span> nb, <span class="dt">n.iter =</span> ni)</a></code></pre></div>
<pre><code>Compiling model graph
   Resolving undeclared variables
   Allocating nodes
Graph information:
   Observed stochastic nodes: 560
   Unobserved stochastic nodes: 117
   Total graph size: 2929

Initializing model</code></pre>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb49-1" data-line-number="1">out &lt;-<span class="st"> </span>outj<span class="op">$</span>BUGSoutput</a>
<a class="sourceLine" id="cb49-2" data-line-number="2"></a>
<a class="sourceLine" id="cb49-3" data-line-number="3"><span class="co"># Compare with MLEs and true values</span></a>
<a class="sourceLine" id="cb49-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">intercept_mean =</span> intercept_mean, <span class="dt">slope_mean =</span> slope_mean, <span class="dt">intercept_sd =</span> intercept_sd, </a>
<a class="sourceLine" id="cb49-5" data-line-number="5">    <span class="dt">slope_sd =</span> slope_sd, <span class="dt">sigma_res =</span> sigma_res)</a></code></pre></div>
<pre><code>  intercept_mean slope_mean intercept_sd slope_sd sigma_res
1            230         60           20       30        30</code></pre>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb51-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(out<span class="op">$</span>mean, <span class="dt">dig =</span> <span class="dv">4</span>)</a></code></pre></div>
<pre><code>$alpha
 [1] 224.0 245.1 230.1 229.6 240.9 212.1 200.5 234.6 214.5 203.3 215.0
[12] 220.4 197.2 240.9 245.5 262.2 212.8 222.0 241.9 229.6 200.4 223.4
[23] 214.3 249.0 230.3 194.7 196.7 261.8 255.7 241.7 205.0 254.4 214.9
[34] 205.4 226.8 220.2 214.8 230.6 263.3 215.6 208.0 244.7 254.3 254.0
[45] 215.1 217.2 190.4 227.9 248.9 261.4 274.1 259.1 247.9 234.0 193.4
[56] 200.0

$beta
 [1]  91.0649  19.1176  55.4833  59.4941  35.8594  76.0443  25.6430
 [8]  25.0486  22.4792  55.1824  20.1924  54.1182  89.1289  57.9554
[15]  11.0069  90.8977  41.7919 112.5433  49.6948  60.8054  41.9405
[22]  53.5698  33.1804  54.7705  -0.6149  21.6095  65.0140  78.0750
[29]  87.0969  99.3739 101.6179  46.0656  41.2710  28.9955  18.3479
[36]  74.7179 107.6608  62.7627  93.8596  20.4692  39.0700  69.9472
[43]  74.8928  18.4211  26.7645  91.4579  80.1806  19.7970  70.6321
[50]  55.1271  54.0865  66.1072  45.6299  50.4884  21.7348  78.5456

$deviance
[1] 5425

$mu_int
[1] 225.6

$mu_slope
[1] 53.44

$sigma_int
[1] 24.11

$sigma_res
[1] 30.74

$sigma_slope
[1] 30.18</code></pre>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb53-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(lme_fit2, <span class="dt">cor =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ x + (1 | subjects) + (0 + x | subjects)
REML criterion at convergence: 5644.788
Random effects:
 Groups     Name        Std.Dev.
 subjects   (Intercept) 23.42   
 subjects.1 x           29.45   
 Residual               30.67   
Number of obs: 560, groups:  subjects, 56
Fixed Effects:
(Intercept)            x  
     228.50        54.52  </code></pre>
<p>Using simulated data and successfully recovering the input values makes us fairly confident that the JAGS analysis has been correctly specified. This is very helpful for more complex models b/c itâ€™s easy to make mistakes. A good way to check the JAGS analysis for a custom model that is needed for a particular phenomenon is to simulate the data and run the JAGS model on that data</p>
</div>
<div id="the-random-coefficients-model-with-correlation-between-intercept-and-slope" class="section level3">
<h3 class="hasAnchor">
<a href="#the-random-coefficients-model-with-correlation-between-intercept-and-slope" class="anchor"></a>The random-coefficients model with correlation between intercept and slope</h3>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb55-1" data-line-number="1">n_subjects &lt;-<span class="st"> </span><span class="dv">56</span></a>
<a class="sourceLine" id="cb55-2" data-line-number="2">n_sample &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb55-3" data-line-number="3">n_obs &lt;-<span class="st"> </span>n_subjects <span class="op">*</span><span class="st"> </span>n_sample</a>
<a class="sourceLine" id="cb55-4" data-line-number="4">subjects &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/gl">gl</a></span>(<span class="dt">n =</span> n_subjects, <span class="dt">k =</span> n_sample)</a>
<a class="sourceLine" id="cb55-5" data-line-number="5"></a>
<a class="sourceLine" id="cb55-6" data-line-number="6"><span class="co"># Standardized continuous covariate:</span></a>
<a class="sourceLine" id="cb55-7" data-line-number="7">original_x &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(n_obs, <span class="dv">45</span>, <span class="dv">70</span>)</a>
<a class="sourceLine" id="cb55-8" data-line-number="8">(mean_orig_x &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(original_x))</a></code></pre></div>
<pre><code>[1] 57.97829</code></pre>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb57-1" data-line-number="1">sd_orig_x &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/sd">sd</a></span>(original_x)</a>
<a class="sourceLine" id="cb57-2" data-line-number="2">x &lt;-<span class="st"> </span>(original_x <span class="op">-</span><span class="st"> </span>mean_orig_x)<span class="op">/</span>sd_orig_x</a>
<a class="sourceLine" id="cb57-3" data-line-number="3"></a>
<a class="sourceLine" id="cb57-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(x, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">breaks =</span> <span class="dv">20</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb57-5" data-line-number="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(x), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" data-line-number="1"><span class="co"># Design matrix:</span></a>
<a class="sourceLine" id="cb58-2" data-line-number="2">Xmat &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/model.matrix">model.matrix</a></span>(<span class="op">~</span>subjects <span class="op">*</span><span class="st"> </span>x <span class="op">-</span><span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>x)</a>
<a class="sourceLine" id="cb58-3" data-line-number="3"></a>
<a class="sourceLine" id="cb58-4" data-line-number="4"><span class="co"># Generate the correlated random effects for intercept and slope: Assembling</span></a>
<a class="sourceLine" id="cb58-5" data-line-number="5"><span class="co"># the parameters for the multivariate normal distribution</span></a>
<a class="sourceLine" id="cb58-6" data-line-number="6">intercept_mean &lt;-<span class="st"> </span><span class="dv">230</span>  <span class="co"># Values for five hyperparameters</span></a>
<a class="sourceLine" id="cb58-7" data-line-number="7">intercept_sd &lt;-<span class="st"> </span><span class="dv">20</span></a>
<a class="sourceLine" id="cb58-8" data-line-number="8">slope_mean &lt;-<span class="st"> </span><span class="dv">60</span></a>
<a class="sourceLine" id="cb58-9" data-line-number="9">slope_sd &lt;-<span class="st"> </span><span class="dv">30</span></a>
<a class="sourceLine" id="cb58-10" data-line-number="10">intercept_slope_covariance &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb58-11" data-line-number="11">intercept_slope_correlation &lt;-<span class="st"> </span>intercept_slope_covariance<span class="op">/</span>(intercept_sd <span class="op">*</span><span class="st"> </span>slope_sd)</a>
<a class="sourceLine" id="cb58-12" data-line-number="12"></a>
<a class="sourceLine" id="cb58-13" data-line-number="13">mu_vector &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(intercept_mean, slope_mean)</a>
<a class="sourceLine" id="cb58-14" data-line-number="14">var_covar_matrix &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(intercept_sd<span class="op">^</span><span class="dv">2</span>, intercept_slope_covariance, intercept_slope_covariance, </a>
<a class="sourceLine" id="cb58-15" data-line-number="15">    slope_sd<span class="op">^</span><span class="dv">2</span>), <span class="dv">2</span>, <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb58-16" data-line-number="16"></a>
<a class="sourceLine" id="cb58-17" data-line-number="17"><span class="co"># Generating the correlated random effects for intercepts and slopes:</span></a>
<a class="sourceLine" id="cb58-18" data-line-number="18"></a>
<a class="sourceLine" id="cb58-19" data-line-number="19"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"MASS"</span>)  <span class="co"># Load MASS to sample from a multivariate normal</span></a>
<a class="sourceLine" id="cb58-20" data-line-number="20">effects &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/MASS/topics/mvrnorm">mvrnorm</a></span>(<span class="dt">n =</span> n_subjects, <span class="dt">mu =</span> mu_vector, <span class="dt">Sigma =</span> var_covar_matrix)</a>
<a class="sourceLine" id="cb58-21" data-line-number="21"><span class="co">## round(effects, 2)</span></a></code></pre></div>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb59-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mar =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb59-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb59-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(effects[, <span class="dv">1</span>], <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">breaks =</span> <span class="dv">10</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb59-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(effects[, <span class="dv">1</span>]), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb59-5" data-line-number="5"></a>
<a class="sourceLine" id="cb59-6" data-line-number="6"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(effects[, <span class="dv">2</span>], <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">breaks =</span> <span class="dv">10</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb59-7" data-line-number="7"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(effects[, <span class="dv">2</span>]), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb60-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb60-2" data-line-number="2"></a>
<a class="sourceLine" id="cb60-3" data-line-number="3"><span class="co"># Plotting the bivariate distribution:</span></a>
<a class="sourceLine" id="cb60-4" data-line-number="4">effects_kde &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/MASS/topics/kde2d">kde2d</a></span>(effects[, <span class="dv">1</span>], effects[, <span class="dv">2</span>], <span class="dt">n =</span> <span class="dv">50</span>)  <span class="co"># kernel density estimate</span></a>
<a class="sourceLine" id="cb60-5" data-line-number="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">3</span>))</a>
<a class="sourceLine" id="cb60-6" data-line-number="6"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/contour">contour</a></span>(effects_kde)</a>
<a class="sourceLine" id="cb60-7" data-line-number="7"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/image">image</a></span>(effects_kde)</a>
<a class="sourceLine" id="cb60-8" data-line-number="8"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/persp">persp</a></span>(effects_kde, <span class="dt">phi =</span> <span class="dv">45</span>, <span class="dt">theta =</span> <span class="dv">30</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-9-2.png" width="700"></p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb61-1" data-line-number="1"><span class="co"># even better:</span></a>
<a class="sourceLine" id="cb61-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb61-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/image">image</a></span>(effects_kde)</a>
<a class="sourceLine" id="cb61-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/contour">contour</a></span>(effects_kde, <span class="dt">add =</span> T)</a>
<a class="sourceLine" id="cb61-5" data-line-number="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/persp">persp</a></span>(effects_kde, <span class="dt">phi =</span> <span class="dv">45</span>, <span class="dt">theta =</span> <span class="dv">-30</span>, <span class="dt">shade =</span> <span class="fl">0.1</span>, <span class="dt">border =</span> <span class="ot">NULL</span>, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, </a>
<a class="sourceLine" id="cb61-6" data-line-number="6">    <span class="dt">ticktype =</span> <span class="st">"detailed"</span>, <span class="dt">xlab =</span> <span class="st">""</span>, <span class="dt">ylab =</span> <span class="st">""</span>, <span class="dt">zlab =</span> <span class="st">""</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-9-3.png" width="700"></p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb62-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb62-2" data-line-number="2"></a>
<a class="sourceLine" id="cb62-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/apply">apply</a></span>(effects, <span class="dv">2</span>, mean)</a></code></pre></div>
<pre><code>[1] 228.32068  60.04359</code></pre>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb64-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/apply">apply</a></span>(effects, <span class="dv">2</span>, sd)</a></code></pre></div>
<pre><code>[1] 18.57572 25.46711</code></pre>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb66-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/apply">apply</a></span>(effects, <span class="dv">2</span>, var)</a></code></pre></div>
<pre><code>[1] 345.0575 648.5739</code></pre>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb68-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">cov</a></span>(effects[, <span class="dv">1</span>], effects[, <span class="dv">2</span>])</a></code></pre></div>
<pre><code>[1] 21.22323</code></pre>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb70-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">var</a></span>(effects)</a></code></pre></div>
<pre><code>          [,1]      [,2]
[1,] 345.05750  21.22323
[2,]  21.22323 648.57387</code></pre>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb72-1" data-line-number="1"><span class="co"># Population parameters</span></a>
<a class="sourceLine" id="cb72-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">intercept_mean =</span> intercept_mean, <span class="dt">slope_mean =</span> slope_mean, <span class="dt">intercept_sd =</span> intercept_sd, </a>
<a class="sourceLine" id="cb72-3" data-line-number="3">    <span class="dt">slope_sd =</span> slope_sd, <span class="dt">intercept_slope_covariance =</span> intercept_slope_covariance, </a>
<a class="sourceLine" id="cb72-4" data-line-number="4">    <span class="dt">sigma_res =</span> sigma_res)</a></code></pre></div>
<pre><code>  intercept_mean slope_mean intercept_sd slope_sd
1            230         60           20       30
  intercept_slope_covariance sigma_res
1                         10        30</code></pre>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb74-1" data-line-number="1"><span class="co"># Sampling error for intercept-slope covariance (200 samples of 50, 500,</span></a>
<a class="sourceLine" id="cb74-2" data-line-number="2"><span class="co"># 5000 and 50000 group/random effects each) -- just to illustrate how</span></a>
<a class="sourceLine" id="cb74-3" data-line-number="3"><span class="co"># difficult it is to estimate measures of association, even from fairly</span></a>
<a class="sourceLine" id="cb74-4" data-line-number="4"><span class="co"># large data sets with 5000 observations:</span></a>
<a class="sourceLine" id="cb74-5" data-line-number="5"></a>
<a class="sourceLine" id="cb74-6" data-line-number="6"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">4</span>))</a>
<a class="sourceLine" id="cb74-7" data-line-number="7">cov_temp1 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">numeric</a></span>()</a>
<a class="sourceLine" id="cb74-8" data-line-number="8"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">200</span>) {</a>
<a class="sourceLine" id="cb74-9" data-line-number="9">    temp1 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/MASS/topics/mvrnorm">mvrnorm</a></span>(<span class="dv">50</span>, <span class="dt">mu =</span> mu_vector, <span class="dt">Sigma =</span> var_covar_matrix)</a>
<a class="sourceLine" id="cb74-10" data-line-number="10">    cov_temp1[i] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">var</a></span>(temp1)[<span class="dv">1</span>, <span class="dv">2</span>]</a>
<a class="sourceLine" id="cb74-11" data-line-number="11">}</a>
<a class="sourceLine" id="cb74-12" data-line-number="12"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(cov_temp1, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>, <span class="dt">main =</span> <span class="st">"n_obs=50"</span>)</a>
<a class="sourceLine" id="cb74-13" data-line-number="13"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(cov_temp1), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb74-14" data-line-number="14"></a>
<a class="sourceLine" id="cb74-15" data-line-number="15">cov_temp2 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">numeric</a></span>()</a>
<a class="sourceLine" id="cb74-16" data-line-number="16"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">200</span>) {</a>
<a class="sourceLine" id="cb74-17" data-line-number="17">    temp2 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/MASS/topics/mvrnorm">mvrnorm</a></span>(<span class="dv">500</span>, <span class="dt">mu =</span> mu_vector, <span class="dt">Sigma =</span> var_covar_matrix)</a>
<a class="sourceLine" id="cb74-18" data-line-number="18">    cov_temp2[i] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">var</a></span>(temp2)[<span class="dv">1</span>, <span class="dv">2</span>]</a>
<a class="sourceLine" id="cb74-19" data-line-number="19">}</a>
<a class="sourceLine" id="cb74-20" data-line-number="20"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(cov_temp2, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>, <span class="dt">main =</span> <span class="st">"n_obs=500"</span>)</a>
<a class="sourceLine" id="cb74-21" data-line-number="21"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(cov_temp2), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb74-22" data-line-number="22"></a>
<a class="sourceLine" id="cb74-23" data-line-number="23">cov_temp3 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">numeric</a></span>()</a>
<a class="sourceLine" id="cb74-24" data-line-number="24"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">200</span>) {</a>
<a class="sourceLine" id="cb74-25" data-line-number="25">    temp3 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/MASS/topics/mvrnorm">mvrnorm</a></span>(<span class="dv">5000</span>, <span class="dt">mu =</span> mu_vector, <span class="dt">Sigma =</span> var_covar_matrix)</a>
<a class="sourceLine" id="cb74-26" data-line-number="26">    cov_temp3[i] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">var</a></span>(temp3)[<span class="dv">1</span>, <span class="dv">2</span>]</a>
<a class="sourceLine" id="cb74-27" data-line-number="27">}</a>
<a class="sourceLine" id="cb74-28" data-line-number="28"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(cov_temp3, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>, <span class="dt">main =</span> <span class="st">"n_obs=5000"</span>)</a>
<a class="sourceLine" id="cb74-29" data-line-number="29"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(cov_temp3), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb74-30" data-line-number="30"></a>
<a class="sourceLine" id="cb74-31" data-line-number="31">cov_temp4 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">numeric</a></span>()</a>
<a class="sourceLine" id="cb74-32" data-line-number="32"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">200</span>) {</a>
<a class="sourceLine" id="cb74-33" data-line-number="33">    temp4 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/MASS/topics/mvrnorm">mvrnorm</a></span>(<span class="dv">50000</span>, <span class="dt">mu =</span> mu_vector, <span class="dt">Sigma =</span> var_covar_matrix)</a>
<a class="sourceLine" id="cb74-34" data-line-number="34">    cov_temp4[i] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">var</a></span>(temp4)[<span class="dv">1</span>, <span class="dv">2</span>]</a>
<a class="sourceLine" id="cb74-35" data-line-number="35">}</a>
<a class="sourceLine" id="cb74-36" data-line-number="36"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(cov_temp4, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>, <span class="dt">main =</span> <span class="st">"n_obs=50000"</span>)</a>
<a class="sourceLine" id="cb74-37" data-line-number="37"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(cov_temp4), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-9-4.png" width="700"></p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb75-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb75-2" data-line-number="2"></a>
<a class="sourceLine" id="cb75-3" data-line-number="3"></a>
<a class="sourceLine" id="cb75-4" data-line-number="4">intercept_effects &lt;-<span class="st"> </span>effects[, <span class="dv">1</span>]</a>
<a class="sourceLine" id="cb75-5" data-line-number="5"><span class="co">## round(intercept_effects, 2)</span></a>
<a class="sourceLine" id="cb75-6" data-line-number="6">slope_effects &lt;-<span class="st"> </span>effects[, <span class="dv">2</span>]</a>
<a class="sourceLine" id="cb75-7" data-line-number="7"><span class="co">## round(slope_effects, 2)</span></a>
<a class="sourceLine" id="cb75-8" data-line-number="8">all_effects &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(intercept_effects, slope_effects)  <span class="co"># Put them all together</span></a>
<a class="sourceLine" id="cb75-9" data-line-number="9"><span class="co">## round(all_effects, 2)</span></a>
<a class="sourceLine" id="cb75-10" data-line-number="10"></a>
<a class="sourceLine" id="cb75-11" data-line-number="11"></a>
<a class="sourceLine" id="cb75-12" data-line-number="12"><span class="co"># Generate the response variable: -- the deterministic part</span></a>
<a class="sourceLine" id="cb75-13" data-line-number="13">lin_pred &lt;-<span class="st"> </span>Xmat <span class="op">%*%</span><span class="st"> </span>all_effects</a>
<a class="sourceLine" id="cb75-14" data-line-number="14"><span class="co">## round(as.vector(lin_pred), 2)</span></a>
<a class="sourceLine" id="cb75-15" data-line-number="15"></a>
<a class="sourceLine" id="cb75-16" data-line-number="16"><span class="co"># -- the stochastic part</span></a>
<a class="sourceLine" id="cb75-17" data-line-number="17">sigma_res &lt;-<span class="st"> </span><span class="dv">30</span></a>
<a class="sourceLine" id="cb75-18" data-line-number="18">normal_error &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dt">n =</span> n_obs, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> sigma_res)  <span class="co"># residuals</span></a>
<a class="sourceLine" id="cb75-19" data-line-number="19"></a>
<a class="sourceLine" id="cb75-20" data-line-number="20"><span class="co"># -- add them together</span></a>
<a class="sourceLine" id="cb75-21" data-line-number="21">y &lt;-<span class="st"> </span>lin_pred <span class="op">+</span><span class="st"> </span>normal_error</a>
<a class="sourceLine" id="cb75-22" data-line-number="22"><span class="co"># or, in one go:</span></a>
<a class="sourceLine" id="cb75-23" data-line-number="23">y &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dt">n =</span> n_obs, <span class="dt">mean =</span> lin_pred, <span class="dt">sd =</span> sigma_res)</a>
<a class="sourceLine" id="cb75-24" data-line-number="24"></a>
<a class="sourceLine" id="cb75-25" data-line-number="25"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(y, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">breaks =</span> <span class="dv">15</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb75-26" data-line-number="26"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(y), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-9-5.png" width="700"></p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb76-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"lattice"</span>)</a>
<a class="sourceLine" id="cb76-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/lattice/topics/xyplot">xyplot</a></span>(y <span class="op">~</span><span class="st"> </span>x <span class="op">|</span><span class="st"> </span>subjects, <span class="dt">pch =</span> <span class="dv">20</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-9-6.png" width="700"></p>
<div id="reml-analysis-using-r" class="section level4">
<h4 class="hasAnchor">
<a href="#reml-analysis-using-r" class="anchor"></a>REML analysis using R</h4>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb77-1" data-line-number="1">lme_fit3 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/lmer">lmer</a></span>(y <span class="op">~</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span>(x <span class="op">|</span><span class="st"> </span>subjects))</a>
<a class="sourceLine" id="cb77-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(lme_fit3, <span class="dt">cor =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ x + (x | subjects)
REML criterion at convergence: 5597.869
Random effects:
 Groups   Name        Std.Dev. Corr 
 subjects (Intercept) 18.03         
          x           24.94    -0.09
 Residual             30.44         
Number of obs: 560, groups:  subjects, 56
Fixed Effects:
(Intercept)            x  
     228.14        62.27  </code></pre>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb79-1" data-line-number="1"><span class="co"># Compare with the true values:</span></a>
<a class="sourceLine" id="cb79-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">intercept_mean =</span> intercept_mean, <span class="dt">slope_mean =</span> slope_mean, <span class="dt">intercept_sd =</span> intercept_sd, </a>
<a class="sourceLine" id="cb79-3" data-line-number="3">    <span class="dt">slope_sd =</span> slope_sd, <span class="dt">intercept_slope_correlation =</span> intercept_slope_covariance<span class="op">/</span>(intercept_sd <span class="op">*</span><span class="st"> </span></a>
<a class="sourceLine" id="cb79-4" data-line-number="4"><span class="st">        </span>slope_sd), <span class="dt">sigma_res =</span> sigma_res)</a></code></pre></div>
<pre><code>  intercept_mean slope_mean intercept_sd slope_sd
1            230         60           20       30
  intercept_slope_correlation sigma_res
1                  0.01666667        30</code></pre>
</div>
<div id="bayesian-analysis-using-jags" class="section level4">
<h4 class="hasAnchor">
<a href="#bayesian-analysis-using-jags" class="anchor"></a>Bayesian analysis using JAGS</h4>
<p>This is one way in which we can specify a Bayesian analysis of the random-coefficients model with correlation. It is more intuitive but does not generalize well to more than 2 correlated random effects. We will introduce a different and more general way to allow for correlation among two or more sets of random effects in a model after this.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb81-1" data-line-number="1"><span class="co"># Define model</span></a>
<a class="sourceLine" id="cb81-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">"model {</span></a>
<a class="sourceLine" id="cb81-3" data-line-number="3"><span class="st"># Priors</span></a>
<a class="sourceLine" id="cb81-4" data-line-number="4"><span class="st">mu_int~dnorm(0, 0.0001) # mean for random intercepts</span></a>
<a class="sourceLine" id="cb81-5" data-line-number="5"><span class="st">mu_slope~dnorm(0, 0.0001) # mean for random slopes</span></a>
<a class="sourceLine" id="cb81-6" data-line-number="6"><span class="st">sigma_int~dunif(0, 100) # SD of intercepts</span></a>
<a class="sourceLine" id="cb81-7" data-line-number="7"><span class="st">sigma_slope~dunif(0, 100) # SD of slopes</span></a>
<a class="sourceLine" id="cb81-8" data-line-number="8"><span class="st">rho~dunif(-1, 1) # correlation between intercepts and slopes</span></a>
<a class="sourceLine" id="cb81-9" data-line-number="9"><span class="st">Sigma_B[1, 1] &lt;- pow(sigma_int, 2) # We start assembling the var-covar matrix for the random effects</span></a>
<a class="sourceLine" id="cb81-10" data-line-number="10"><span class="st">Sigma_B[2, 2] &lt;- pow(sigma_slope, 2)</span></a>
<a class="sourceLine" id="cb81-11" data-line-number="11"><span class="st">Sigma_B[1, 2] &lt;- rho*sigma_int*sigma_slope</span></a>
<a class="sourceLine" id="cb81-12" data-line-number="12"><span class="st">Sigma_B[2, 1] &lt;- Sigma_B[1, 2]</span></a>
<a class="sourceLine" id="cb81-13" data-line-number="13"><span class="st">covariance &lt;- Sigma_B[1, 2]</span></a>
<a class="sourceLine" id="cb81-14" data-line-number="14"><span class="st">Tau_B[1:2, 1:2] &lt;- inverse(Sigma_B[,])</span></a>
<a class="sourceLine" id="cb81-15" data-line-number="15"><span class="st">for (i in 1:n_subj) {</span></a>
<a class="sourceLine" id="cb81-16" data-line-number="16"><span class="st">    B_hat[i, 1] &lt;- mu_int</span></a>
<a class="sourceLine" id="cb81-17" data-line-number="17"><span class="st">    B_hat[i, 2] &lt;- mu_slope</span></a>
<a class="sourceLine" id="cb81-18" data-line-number="18"><span class="st">    B[i, 1:2]~dmnorm(B_hat[i, ], Tau_B[,]) # the pairs of correlated random effects</span></a>
<a class="sourceLine" id="cb81-19" data-line-number="19"><span class="st">    alpha[i] &lt;- B[i, 1] # random intercept</span></a>
<a class="sourceLine" id="cb81-20" data-line-number="20"><span class="st">    beta[i] &lt;- B[i, 2] # random slope</span></a>
<a class="sourceLine" id="cb81-21" data-line-number="21"><span class="st">}</span></a>
<a class="sourceLine" id="cb81-22" data-line-number="22"><span class="st">sigma_res~dunif(0, 100) # Residual standard deviation</span></a>
<a class="sourceLine" id="cb81-23" data-line-number="23"><span class="st">tau_res &lt;- 1/(sigma_res*sigma_res)</span></a>
<a class="sourceLine" id="cb81-24" data-line-number="24"><span class="st"># Likelihood</span></a>
<a class="sourceLine" id="cb81-25" data-line-number="25"><span class="st">for (i in 1:n_obs) {</span></a>
<a class="sourceLine" id="cb81-26" data-line-number="26"><span class="st">    mu[i] &lt;- alpha[subjects[i]]+beta[subjects[i]]*x[i]</span></a>
<a class="sourceLine" id="cb81-27" data-line-number="27"><span class="st">    y[i]~dnorm(mu[i], tau_res)</span></a>
<a class="sourceLine" id="cb81-28" data-line-number="28"><span class="st">}</span></a>
<a class="sourceLine" id="cb81-29" data-line-number="29"><span class="st">}"</span>, </a>
<a class="sourceLine" id="cb81-30" data-line-number="30">    <span class="dt">fill =</span> <span class="ot">TRUE</span>, <span class="dt">file =</span> <span class="st">"lme_model3.txt"</span>)</a>
<a class="sourceLine" id="cb81-31" data-line-number="31"></a>
<a class="sourceLine" id="cb81-32" data-line-number="32"><span class="co"># Bundle data</span></a>
<a class="sourceLine" id="cb81-33" data-line-number="33">jags_data &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(y), <span class="dt">subjects =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(subjects), <span class="dt">x =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(x), </a>
<a class="sourceLine" id="cb81-34" data-line-number="34">    <span class="dt">n_subj =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(subjects)), <span class="dt">n_obs =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(n_obs))</a>
<a class="sourceLine" id="cb81-35" data-line-number="35"></a>
<a class="sourceLine" id="cb81-36" data-line-number="36"><span class="co"># Inits function</span></a>
<a class="sourceLine" id="cb81-37" data-line-number="37">inits &lt;-<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb81-38" data-line-number="38">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">mu_int =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">sigma_int =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Lognormal">rlnorm</a></span>(<span class="dv">1</span>), <span class="dt">mu_slope =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">1</span>, </a>
<a class="sourceLine" id="cb81-39" data-line-number="39">        <span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">sigma_slope =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Lognormal">rlnorm</a></span>(<span class="dv">1</span>), <span class="dt">rho =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">-1</span>, <span class="dv">1</span>), <span class="dt">sigma_res =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Lognormal">rlnorm</a></span>(<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb81-40" data-line-number="40">}</a>
<a class="sourceLine" id="cb81-41" data-line-number="41"></a>
<a class="sourceLine" id="cb81-42" data-line-number="42"><span class="co"># Parameters to estimate</span></a>
<a class="sourceLine" id="cb81-43" data-line-number="43">params &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"mu_int"</span>, <span class="st">"sigma_int"</span>, <span class="st">"mu_slope"</span>, <span class="st">"sigma_slope"</span>, </a>
<a class="sourceLine" id="cb81-44" data-line-number="44">    <span class="st">"rho"</span>, <span class="st">"covariance"</span>, <span class="st">"sigma_res"</span>)</a>
<a class="sourceLine" id="cb81-45" data-line-number="45"></a>
<a class="sourceLine" id="cb81-46" data-line-number="46"><span class="co"># MCMC settings</span></a>
<a class="sourceLine" id="cb81-47" data-line-number="47">ni &lt;-<span class="st"> </span><span class="dv">3200</span></a>
<a class="sourceLine" id="cb81-48" data-line-number="48">nb &lt;-<span class="st"> </span><span class="dv">200</span></a>
<a class="sourceLine" id="cb81-49" data-line-number="49">nt &lt;-<span class="st"> </span><span class="dv">6</span></a>
<a class="sourceLine" id="cb81-50" data-line-number="50">nc &lt;-<span class="st"> </span><span class="dv">3</span>  <span class="co"># more than this probably needed for a good approx. of the posterior distribution</span></a>
<a class="sourceLine" id="cb81-51" data-line-number="51"></a>
<a class="sourceLine" id="cb81-52" data-line-number="52"><span class="co"># Start Gibbs sampler</span></a>
<a class="sourceLine" id="cb81-53" data-line-number="53"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"R2jags"</span>)</a>
<a class="sourceLine" id="cb81-54" data-line-number="54">outj &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/R2jags/topics/jags">jags</a></span>(jags_data, <span class="dt">inits =</span> inits, <span class="dt">parameters.to.save =</span> params, <span class="dt">model.file =</span> <span class="st">"lme_model3.txt"</span>, </a>
<a class="sourceLine" id="cb81-55" data-line-number="55">    <span class="dt">n.thin =</span> nt, <span class="dt">n.chains =</span> nc, <span class="dt">n.burnin =</span> nb, <span class="dt">n.iter =</span> ni)</a></code></pre></div>
<pre><code>Compiling model graph
   Resolving undeclared variables
   Allocating nodes
Graph information:
   Observed stochastic nodes: 560
   Unobserved stochastic nodes: 62
   Total graph size: 3045

Initializing model</code></pre>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb83-1" data-line-number="1"><span class="co"># traceplot(outj)</span></a>
<a class="sourceLine" id="cb83-2" data-line-number="2"></a>
<a class="sourceLine" id="cb83-3" data-line-number="3"><span class="co"># -- this type of model does not converge very fast in addition to the fact</span></a>
<a class="sourceLine" id="cb83-4" data-line-number="4"><span class="co"># that it does not generalize very well; we increase the number of</span></a>
<a class="sourceLine" id="cb83-5" data-line-number="5"><span class="co"># iterations</span></a>
<a class="sourceLine" id="cb83-6" data-line-number="6"></a>
<a class="sourceLine" id="cb83-7" data-line-number="7">ni &lt;-<span class="st"> </span><span class="dv">25000</span></a>
<a class="sourceLine" id="cb83-8" data-line-number="8">nb &lt;-<span class="st"> </span><span class="dv">5000</span></a>
<a class="sourceLine" id="cb83-9" data-line-number="9">nt &lt;-<span class="st"> </span><span class="dv">40</span></a>
<a class="sourceLine" id="cb83-10" data-line-number="10">nc &lt;-<span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb83-11" data-line-number="11">outj &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/R2jags/topics/jags">jags</a></span>(jags_data, <span class="dt">inits =</span> inits, <span class="dt">parameters.to.save =</span> params, <span class="dt">model.file =</span> <span class="st">"lme_model3.txt"</span>, </a>
<a class="sourceLine" id="cb83-12" data-line-number="12">    <span class="dt">n.thin =</span> nt, <span class="dt">n.chains =</span> nc, <span class="dt">n.burnin =</span> nb, <span class="dt">n.iter =</span> ni)</a></code></pre></div>
<pre><code>Compiling model graph
   Resolving undeclared variables
   Allocating nodes
Graph information:
   Observed stochastic nodes: 560
   Unobserved stochastic nodes: 62
   Total graph size: 3045

Initializing model</code></pre>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb85-1" data-line-number="1"><span class="co"># traceplot(outj)</span></a>
<a class="sourceLine" id="cb85-2" data-line-number="2"></a>
<a class="sourceLine" id="cb85-3" data-line-number="3"><span class="co"># print(outj, dig = 3)</span></a>
<a class="sourceLine" id="cb85-4" data-line-number="4"></a>
<a class="sourceLine" id="cb85-5" data-line-number="5">out &lt;-<span class="st"> </span>outj<span class="op">$</span>BUGSoutput</a>
<a class="sourceLine" id="cb85-6" data-line-number="6"></a>
<a class="sourceLine" id="cb85-7" data-line-number="7"><span class="co"># Compare with MLEs and true values</span></a>
<a class="sourceLine" id="cb85-8" data-line-number="8"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">intercept_mean =</span> intercept_mean, <span class="dt">slope_mean =</span> slope_mean, <span class="dt">intercept_sd =</span> intercept_sd, </a>
<a class="sourceLine" id="cb85-9" data-line-number="9">    <span class="dt">slope_sd =</span> slope_sd, <span class="dt">intercept_slope_correlation =</span> intercept_slope_covariance<span class="op">/</span>(intercept_sd <span class="op">*</span><span class="st"> </span></a>
<a class="sourceLine" id="cb85-10" data-line-number="10"><span class="st">        </span>slope_sd), <span class="dt">sigma_res =</span> sigma_res)</a></code></pre></div>
<pre><code>  intercept_mean slope_mean intercept_sd slope_sd
1            230         60           20       30
  intercept_slope_correlation sigma_res
1                  0.01666667        30</code></pre>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb87-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(out<span class="op">$</span>mean, <span class="dt">dig =</span> <span class="dv">4</span>)</a></code></pre></div>
<pre><code>$alpha
 [1] 234.8 210.8 216.0 231.8 213.4 252.1 197.5 206.4 214.3 214.3 229.8
[12] 235.7 221.3 232.9 239.9 237.5 225.3 220.9 234.9 244.7 210.9 241.2
[23] 240.5 232.6 282.7 242.9 216.7 239.1 246.4 235.2 224.9 207.8 205.7
[34] 216.8 224.3 228.9 200.1 244.1 212.9 227.3 254.3 233.4 221.4 231.0
[45] 232.2 231.0 250.0 223.7 202.7 213.3 226.4 248.2 243.1 217.2 222.9
[56] 228.2

$beta
 [1]  49.386  91.198  71.698  53.506  63.009 102.551  46.468 124.803
 [9]  16.620  62.329  57.112  45.341  61.833  68.319  67.687  98.557
[17]  52.904  51.516  87.618  57.938  34.182  37.561  92.316  72.838
[25]  27.757  50.355  76.846  54.728  29.734  60.861 105.686  32.490
[33]  45.201  65.099  81.350  71.737  66.407  62.833  69.787  66.802
[41]  63.020  46.667  74.904  44.455  86.524  55.774  67.336  92.737
[49] 102.220  47.125   8.194  74.128  34.882  44.468  71.423  35.515

$covariance
[1] -46.25

$deviance
[1] 5417

$mu_int
[1] 227.8

$mu_slope
[1] 62.18

$rho
[1] -0.09409

$sigma_int
[1] 18.5

$sigma_res
[1] 30.52

$sigma_slope
[1] 25.85</code></pre>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb89-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(lme_fit3, <span class="dt">cor =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ x + (x | subjects)
REML criterion at convergence: 5597.869
Random effects:
 Groups   Name        Std.Dev. Corr 
 subjects (Intercept) 18.03         
          x           24.94    -0.09
 Residual             30.44         
Number of obs: 560, groups:  subjects, 56
Fixed Effects:
(Intercept)            x  
     228.14        62.27  </code></pre>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb91-1" data-line-number="1"><span class="co"># Note the very large SD for the posterior distribution of the covariance</span></a>
<a class="sourceLine" id="cb91-2" data-line-number="2"><span class="co"># (relative to the mean):</span></a>
<a class="sourceLine" id="cb91-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(out<span class="op">$</span>mean<span class="op">$</span>covariance, <span class="dt">dig =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>[1] -46</code></pre>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb93-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(out<span class="op">$</span>sd<span class="op">$</span>covariance, <span class="dt">dig =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>[1] 82</code></pre>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb95-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(out<span class="op">$</span>mean<span class="op">$</span>rho, <span class="dt">dig =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>[1] -0.094</code></pre>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb97-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(out<span class="op">$</span>sd<span class="op">$</span>rho, <span class="dt">dig =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>[1] 0.16</code></pre>
<p>R does not even provide an SE for the covariance estimator (equivalently, for the correlation of random effects). Covariances are even harder to reliably estimate than variances, which are harder than mean estimators (itâ€™s easy to estimate measures of center / location, harder to estimate measures of dispersion and even harder to estimate measures of association)</p>
<p>MODELING CORRELATED RANEFS WITH A SCALED INVERSE WISHART: the 2 correlated ranefs case first.</p>
<p>We will now introduce an alternative way of placing priors over correlated random effects that both converges faster and generalizes to structures with more than 2 correlated random effects. See the relevant chapter of Gelman &amp; Hill (2007) for more introductory discussion and references</p>
<p>Bayesian analysis using a scaled Inverse Wishart</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb99-1" data-line-number="1"><span class="co"># Define model</span></a>
<a class="sourceLine" id="cb99-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">"model {</span></a>
<a class="sourceLine" id="cb99-3" data-line-number="3"></a>
<a class="sourceLine" id="cb99-4" data-line-number="4"><span class="st"># Set up the means for the multivariate ranef distribution</span></a>
<a class="sourceLine" id="cb99-5" data-line-number="5"><span class="st">for (i in 1:2) {</span></a>
<a class="sourceLine" id="cb99-6" data-line-number="6"><span class="st">    xi[i]~dunif(0, 100) # scaling for the multivariate ranef distribution (for means, sds, and the ranefs themselves)</span></a>
<a class="sourceLine" id="cb99-7" data-line-number="7"><span class="st">    mu_raw[i]~dnorm(0, .0001) # unscaled means for the multivariate ranef distribution</span></a>
<a class="sourceLine" id="cb99-8" data-line-number="8"><span class="st">    mu[i] &lt;- xi[i]*mu_raw[i] # scaled means for the multivariate ranef distribution</span></a>
<a class="sourceLine" id="cb99-9" data-line-number="9"><span class="st">}</span></a>
<a class="sourceLine" id="cb99-10" data-line-number="10"><span class="st">mu_int &lt;- mu[1] # mean for random intercepts</span></a>
<a class="sourceLine" id="cb99-11" data-line-number="11"><span class="st">mu_slope &lt;- mu[2] # mean for random slopes</span></a>
<a class="sourceLine" id="cb99-12" data-line-number="12"></a>
<a class="sourceLine" id="cb99-13" data-line-number="13"><span class="st"># Set up the var-covar matrix for the multivariate ranef distribution</span></a>
<a class="sourceLine" id="cb99-14" data-line-number="14"><span class="st">Tau_B_raw[1:2, 1:2] ~ dwish(W[,], 3) # W is the identity matrix, provided as data; we have 3 dofs, i.e., 2 ranefs + 1, to ensure a uniform (-1, 1) prior for the correlation between ranefs</span></a>
<a class="sourceLine" id="cb99-15" data-line-number="15"><span class="st">Sigma_B_raw[1:2, 1:2] &lt;- inverse(Tau_B_raw[,])</span></a>
<a class="sourceLine" id="cb99-16" data-line-number="16"><span class="st">for (i in 1:2) {</span></a>
<a class="sourceLine" id="cb99-17" data-line-number="17"><span class="st">    sigma[i] &lt;- xi[i]*sqrt(Sigma_B_raw[i, i])</span></a>
<a class="sourceLine" id="cb99-18" data-line-number="18"><span class="st">}</span></a>
<a class="sourceLine" id="cb99-19" data-line-number="19"><span class="st">sigma_int &lt;- sigma[1] # SD of intercepts</span></a>
<a class="sourceLine" id="cb99-20" data-line-number="20"><span class="st">sigma_slope &lt;- sigma[2] # SD of slopes</span></a>
<a class="sourceLine" id="cb99-21" data-line-number="21"><span class="st">for (i in 1:2) { for (j in 1:2) {</span></a>
<a class="sourceLine" id="cb99-22" data-line-number="22"><span class="st">    rho[i, j] &lt;- Sigma_B_raw[i, j]/sqrt(Sigma_B_raw[i, i]*Sigma_B_raw[j, j])</span></a>
<a class="sourceLine" id="cb99-23" data-line-number="23"><span class="st">} }</span></a>
<a class="sourceLine" id="cb99-24" data-line-number="24"><span class="st">rho_int_slope &lt;- rho[1, 2]</span></a>
<a class="sourceLine" id="cb99-25" data-line-number="25"><span class="st">covariance &lt;- rho_int_slope*sigma_int*sigma_slope</span></a>
<a class="sourceLine" id="cb99-26" data-line-number="26"></a>
<a class="sourceLine" id="cb99-27" data-line-number="27"><span class="st"># The multivariate ranef distribution, i.e., modeling the correlated ranefs</span></a>
<a class="sourceLine" id="cb99-28" data-line-number="28"><span class="st">for (j in 1:n_subj) {</span></a>
<a class="sourceLine" id="cb99-29" data-line-number="29"><span class="ch">\t</span><span class="st">B_raw_hat[j, 1] &lt;- mu_raw[1]</span></a>
<a class="sourceLine" id="cb99-30" data-line-number="30"><span class="ch">\t</span><span class="st">B_raw_hat[j, 2] &lt;- mu_raw[2]</span></a>
<a class="sourceLine" id="cb99-31" data-line-number="31"><span class="ch">\t</span><span class="st">B_raw[j, 1:2] ~ dmnorm(B_raw_hat[j, ], Tau_B_raw[, ]) # the pairs of unscaled (raw) correlated random effects</span></a>
<a class="sourceLine" id="cb99-32" data-line-number="32"><span class="ch">\t</span><span class="st">alpha[j] &lt;- xi[1]*B_raw[j, 1] # random intercept</span></a>
<a class="sourceLine" id="cb99-33" data-line-number="33"><span class="st">    beta[j] &lt;- xi[2]*B_raw[j, 2] # random slope</span></a>
<a class="sourceLine" id="cb99-34" data-line-number="34"><span class="st">}</span></a>
<a class="sourceLine" id="cb99-35" data-line-number="35"></a>
<a class="sourceLine" id="cb99-36" data-line-number="36"><span class="st"># Model the resid. sd independently</span></a>
<a class="sourceLine" id="cb99-37" data-line-number="37"><span class="st">sigma_res~dunif(0, 100) # Residual standard deviation</span></a>
<a class="sourceLine" id="cb99-38" data-line-number="38"><span class="st">tau_res &lt;- 1/(sigma_res*sigma_res)</span></a>
<a class="sourceLine" id="cb99-39" data-line-number="39"></a>
<a class="sourceLine" id="cb99-40" data-line-number="40"><span class="st"># Likelihood</span></a>
<a class="sourceLine" id="cb99-41" data-line-number="41"><span class="st">for (i in 1:n_obs) {</span></a>
<a class="sourceLine" id="cb99-42" data-line-number="42"><span class="st">    mu_obs[i] &lt;- alpha[subjects[i]]+beta[subjects[i]]*x[i]</span></a>
<a class="sourceLine" id="cb99-43" data-line-number="43"><span class="st">    y[i]~dnorm(mu_obs[i], tau_res)</span></a>
<a class="sourceLine" id="cb99-44" data-line-number="44"><span class="st">}</span></a>
<a class="sourceLine" id="cb99-45" data-line-number="45"></a>
<a class="sourceLine" id="cb99-46" data-line-number="46"><span class="st"># Sampling from the prior: given that we do not place hyperpriors directly on the means, sds and correlation(s) of the multivariate ranef distribution, we want to sample from the prior to make sure we didn't accidentally make it more informed than we wanted (and we want it very vague)</span></a>
<a class="sourceLine" id="cb99-47" data-line-number="47"><span class="st">for (i in 1:2) {</span></a>
<a class="sourceLine" id="cb99-48" data-line-number="48"><span class="st">    xi_prior[i]~dunif(0, 100)</span></a>
<a class="sourceLine" id="cb99-49" data-line-number="49"><span class="st">    mu_raw_prior[i]~dnorm(0, .0001)</span></a>
<a class="sourceLine" id="cb99-50" data-line-number="50"><span class="st">    mu_prior[i] &lt;- xi_prior[i]*mu_raw_prior[i]</span></a>
<a class="sourceLine" id="cb99-51" data-line-number="51"><span class="st">}</span></a>
<a class="sourceLine" id="cb99-52" data-line-number="52"><span class="st">mu_int_prior &lt;- mu_prior[1]</span></a>
<a class="sourceLine" id="cb99-53" data-line-number="53"><span class="st">mu_slope_prior &lt;- mu_prior[2]</span></a>
<a class="sourceLine" id="cb99-54" data-line-number="54"><span class="st">Tau_B_raw_prior[1:2, 1:2] ~ dwish(W[,], 3)</span></a>
<a class="sourceLine" id="cb99-55" data-line-number="55"><span class="st">Sigma_B_raw_prior[1:2, 1:2] &lt;- inverse(Tau_B_raw_prior[,])</span></a>
<a class="sourceLine" id="cb99-56" data-line-number="56"><span class="st">for (i in 1:2) {</span></a>
<a class="sourceLine" id="cb99-57" data-line-number="57"><span class="st">    sigma_prior[i] &lt;- xi_prior[i]*sqrt(Sigma_B_raw_prior[i, i])</span></a>
<a class="sourceLine" id="cb99-58" data-line-number="58"><span class="st">}</span></a>
<a class="sourceLine" id="cb99-59" data-line-number="59"><span class="st">sigma_int_prior &lt;- sigma_prior[1]</span></a>
<a class="sourceLine" id="cb99-60" data-line-number="60"><span class="st">sigma_slope_prior &lt;- sigma_prior[2]</span></a>
<a class="sourceLine" id="cb99-61" data-line-number="61"><span class="st">for (i in 1:2) { for (j in 1:2) {</span></a>
<a class="sourceLine" id="cb99-62" data-line-number="62"><span class="st">    rho_prior[i, j] &lt;- Sigma_B_raw_prior[i, j]/sqrt(Sigma_B_raw_prior[i, i]*Sigma_B_raw_prior[j, j])</span></a>
<a class="sourceLine" id="cb99-63" data-line-number="63"><span class="st">} }</span></a>
<a class="sourceLine" id="cb99-64" data-line-number="64"><span class="st">rho_int_slope_prior &lt;- rho_prior[1, 2]</span></a>
<a class="sourceLine" id="cb99-65" data-line-number="65"><span class="st">}"</span>, </a>
<a class="sourceLine" id="cb99-66" data-line-number="66">    <span class="dt">fill =</span> <span class="ot">TRUE</span>, <span class="dt">file =</span> <span class="st">"lme_model4.txt"</span>)</a>
<a class="sourceLine" id="cb99-67" data-line-number="67"></a>
<a class="sourceLine" id="cb99-68" data-line-number="68"><span class="co"># Bundle data</span></a>
<a class="sourceLine" id="cb99-69" data-line-number="69">jags_data &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(y), <span class="dt">subjects =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(subjects), <span class="dt">x =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(x), </a>
<a class="sourceLine" id="cb99-70" data-line-number="70">    <span class="dt">n_subj =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(subjects)), <span class="dt">n_obs =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(n_obs), <span class="dt">W =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/diag">diag</a></span>(<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb99-71" data-line-number="71"></a>
<a class="sourceLine" id="cb99-72" data-line-number="72"><span class="co"># install.packages('bayesm')</span></a>
<a class="sourceLine" id="cb99-73" data-line-number="73"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"bayesm"</span>)</a>
<a class="sourceLine" id="cb99-74" data-line-number="74">var_vec &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/apply">apply</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/coef">coef</a></span>(lme_fit3)<span class="op">$</span>subjects, <span class="dv">2</span>, var)</a>
<a class="sourceLine" id="cb99-75" data-line-number="75"></a>
<a class="sourceLine" id="cb99-76" data-line-number="76"><span class="co"># Inits function</span></a>
<a class="sourceLine" id="cb99-77" data-line-number="77">inits &lt;-<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb99-78" data-line-number="78">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">xi =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Lognormal">rlnorm</a></span>(<span class="dv">2</span>), <span class="dt">mu_raw =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">2</span>), <span class="dt">Tau_B_raw =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/bayesm/topics/rwishart">rwishart</a></span>(<span class="dv">3</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/diag">diag</a></span>(<span class="dv">2</span>) <span class="op">*</span><span class="st"> </span></a>
<a class="sourceLine" id="cb99-79" data-line-number="79"><span class="st">        </span>var_vec)<span class="op">$</span>W, <span class="dt">sigma_res =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Lognormal">rlnorm</a></span>(<span class="dv">1</span>), <span class="dt">xi_prior =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Lognormal">rlnorm</a></span>(<span class="dv">2</span>), <span class="dt">mu_raw_prior =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">2</span>), </a>
<a class="sourceLine" id="cb99-80" data-line-number="80">        <span class="dt">Tau_B_raw_prior =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/bayesm/topics/rwishart">rwishart</a></span>(<span class="dv">3</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/diag">diag</a></span>(<span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>var_vec)<span class="op">$</span>W)</a>
<a class="sourceLine" id="cb99-81" data-line-number="81">}</a>
<a class="sourceLine" id="cb99-82" data-line-number="82"></a>
<a class="sourceLine" id="cb99-83" data-line-number="83"><span class="co"># Parameters to estimate</span></a>
<a class="sourceLine" id="cb99-84" data-line-number="84">params &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"mu"</span>, <span class="st">"mu_int"</span>, <span class="st">"mu_slope"</span>, <span class="st">"sigma"</span>, <span class="st">"sigma_int"</span>, <span class="st">"sigma_slope"</span>, </a>
<a class="sourceLine" id="cb99-85" data-line-number="85">    <span class="st">"rho"</span>, <span class="st">"rho_int_slope"</span>, <span class="st">"covariance"</span>, <span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"sigma_res"</span>, <span class="st">"mu_int_prior"</span>, </a>
<a class="sourceLine" id="cb99-86" data-line-number="86">    <span class="st">"mu_slope_prior"</span>, <span class="st">"sigma_int_prior"</span>, <span class="st">"sigma_slope_prior"</span>, <span class="st">"rho_int_slope_prior"</span>)</a>
<a class="sourceLine" id="cb99-87" data-line-number="87"></a>
<a class="sourceLine" id="cb99-88" data-line-number="88"><span class="co"># MCMC settings</span></a>
<a class="sourceLine" id="cb99-89" data-line-number="89">ni &lt;-<span class="st"> </span><span class="dv">7000</span></a>
<a class="sourceLine" id="cb99-90" data-line-number="90">nb &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb99-91" data-line-number="91">nt &lt;-<span class="st"> </span><span class="dv">6</span></a>
<a class="sourceLine" id="cb99-92" data-line-number="92">nc &lt;-<span class="st"> </span><span class="dv">3</span>  <span class="co"># more than this probably needed for a good approx. of the posterior distribution</span></a>
<a class="sourceLine" id="cb99-93" data-line-number="93"></a>
<a class="sourceLine" id="cb99-94" data-line-number="94"><span class="co"># Start Gibbs sampler</span></a>
<a class="sourceLine" id="cb99-95" data-line-number="95"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"R2jags"</span>)</a>
<a class="sourceLine" id="cb99-96" data-line-number="96">outj &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/R2jags/topics/jags">jags</a></span>(jags_data, <span class="dt">inits =</span> inits, <span class="dt">parameters.to.save =</span> params, <span class="dt">model.file =</span> <span class="st">"lme_model4.txt"</span>, </a>
<a class="sourceLine" id="cb99-97" data-line-number="97">    <span class="dt">n.thin =</span> nt, <span class="dt">n.chains =</span> nc, <span class="dt">n.burnin =</span> nb, <span class="dt">n.iter =</span> ni)</a></code></pre></div>
<pre><code>Compiling model graph
   Resolving undeclared variables
   Allocating nodes
Graph information:
   Observed stochastic nodes: 560
   Unobserved stochastic nodes: 67
   Total graph size: 3208

Initializing model</code></pre>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb101-1" data-line-number="1">out &lt;-<span class="st"> </span>outj<span class="op">$</span>BUGSoutput</a>
<a class="sourceLine" id="cb101-2" data-line-number="2"></a>
<a class="sourceLine" id="cb101-3" data-line-number="3"><span class="co"># Compare with MLEs and true values</span></a>
<a class="sourceLine" id="cb101-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">intercept_mean =</span> intercept_mean, <span class="dt">slope_mean =</span> slope_mean, <span class="dt">intercept_sd =</span> intercept_sd, </a>
<a class="sourceLine" id="cb101-5" data-line-number="5">    <span class="dt">slope_sd =</span> slope_sd, <span class="dt">intercept_slope_correlation =</span> intercept_slope_covariance<span class="op">/</span>(intercept_sd <span class="op">*</span><span class="st"> </span></a>
<a class="sourceLine" id="cb101-6" data-line-number="6"><span class="st">        </span>slope_sd), <span class="dt">sigma_res =</span> sigma_res)</a></code></pre></div>
<pre><code>  intercept_mean slope_mean intercept_sd slope_sd
1            230         60           20       30
  intercept_slope_correlation sigma_res
1                  0.01666667        30</code></pre>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb103-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(out<span class="op">$</span>mean, <span class="dt">dig =</span> <span class="dv">4</span>)</a></code></pre></div>
<pre><code>$alpha
 [1] 234.4 211.2 216.5 231.5 213.9 250.7 198.7 207.1 214.6 215.4 229.5
[12] 235.6 221.4 233.1 239.5 237.6 225.6 221.0 234.4 244.3 211.3 241.0
[23] 239.9 232.3 281.6 242.2 216.7 238.9 245.9 234.7 225.4 208.3 206.6
[34] 217.4 224.4 229.0 201.0 243.5 213.9 227.0 253.5 232.9 221.7 231.3
[45] 232.3 231.1 249.2 223.9 203.4 213.9 226.9 247.3 243.0 217.4 223.1
[56] 228.4

$beta
 [1]  50.096  90.709  71.367  54.144  62.578 102.154  46.475 124.284
 [9]  17.110  62.806  57.515  45.710  61.602  68.878  66.813  98.173
[17]  53.020  51.471  87.645  57.874  34.319  37.397  91.904  72.507
[25]  27.901  50.682  77.149  54.639  30.049  61.561 105.074  33.218
[33]  45.222  65.273  80.857  71.700  66.236  62.864  69.595  67.067
[41]  62.724  46.654  74.472  44.677  86.445  56.085  66.815  91.999
[49] 101.447  47.910   8.906  73.797  35.221  44.635  70.748  35.562

$covariance
[1] -44.08

$deviance
[1] 5420

$mu
[1] 228.13  62.22

$mu_int
[1] 228.1

$mu_int_prior
[1] 76.05

$mu_slope
[1] 62.22

$mu_slope_prior
[1] 96.1

$rho
         [,1]     [,2]
[1,]  1.00000 -0.09938
[2,] -0.09938  1.00000

$rho_int_slope
[1] -0.09938

$rho_int_slope_prior
[1] -0.008725

$sigma
[1] 17.39 24.89

$sigma_int
[1] 17.39

$sigma_int_prior
[1] 62.16

$sigma_res
[1] 30.65

$sigma_slope
[1] 24.89

$sigma_slope_prior
[1] 62.36</code></pre>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb105-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(lme_fit3, <span class="dt">cor =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ x + (x | subjects)
REML criterion at convergence: 5597.869
Random effects:
 Groups   Name        Std.Dev. Corr 
 subjects (Intercept) 18.03         
          x           24.94    -0.09
 Residual             30.44         
Number of obs: 560, groups:  subjects, 56
Fixed Effects:
(Intercept)            x  
     228.14        62.27  </code></pre>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb107-1" data-line-number="1"><span class="co"># Once again, note the very large SD for the posterior distribution of the</span></a>
<a class="sourceLine" id="cb107-2" data-line-number="2"><span class="co"># covariance (relative to the mean):</span></a>
<a class="sourceLine" id="cb107-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(out<span class="op">$</span>mean<span class="op">$</span>covariance, <span class="dt">dig =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>[1] -44</code></pre>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb109-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(out<span class="op">$</span>sd<span class="op">$</span>covariance, <span class="dt">dig =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>[1] 74</code></pre>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb111-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(out<span class="op">$</span>mean<span class="op">$</span>rho, <span class="dt">dig =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>       [,1]   [,2]
[1,]  1.000 -0.099
[2,] -0.099  1.000</code></pre>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb113-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(out<span class="op">$</span>sd<span class="op">$</span>rho, <span class="dt">dig =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>     [,1] [,2]
[1,] 0.00 0.16
[2,] 0.16 0.00</code></pre>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb115-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(out<span class="op">$</span>sims.list<span class="op">$</span>mu_int_prior, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, </a>
<a class="sourceLine" id="cb115-2" data-line-number="2">    <span class="dt">breaks =</span> <span class="dv">10</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>, <span class="dt">main =</span> <span class="st">"mu_int_prior"</span>)</a>
<a class="sourceLine" id="cb115-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(out<span class="op">$</span>sims.list<span class="op">$</span>mu_int_prior), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb116-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(out<span class="op">$</span>sims.list<span class="op">$</span>mu_int, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">breaks =</span> <span class="dv">10</span>, </a>
<a class="sourceLine" id="cb116-2" data-line-number="2">    <span class="dt">freq =</span> <span class="ot">FALSE</span>, <span class="dt">main =</span> <span class="st">"mu_int"</span>)</a>
<a class="sourceLine" id="cb116-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(out<span class="op">$</span>sims.list<span class="op">$</span>mu_int), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-13-2.png" width="700"></p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb117-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(out<span class="op">$</span>sims.list<span class="op">$</span>mu_slope_prior, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, </a>
<a class="sourceLine" id="cb117-2" data-line-number="2">    <span class="dt">breaks =</span> <span class="dv">10</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>, <span class="dt">main =</span> <span class="st">"mu_slope_prior"</span>)</a>
<a class="sourceLine" id="cb117-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(out<span class="op">$</span>sims.list<span class="op">$</span>mu_slope_prior), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-13-3.png" width="700"></p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb118-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(out<span class="op">$</span>sims.list<span class="op">$</span>mu_slope, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">breaks =</span> <span class="dv">10</span>, </a>
<a class="sourceLine" id="cb118-2" data-line-number="2">    <span class="dt">freq =</span> <span class="ot">FALSE</span>, <span class="dt">main =</span> <span class="st">"mu_slope"</span>)</a>
<a class="sourceLine" id="cb118-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(out<span class="op">$</span>sims.list<span class="op">$</span>mu_slope), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-13-4.png" width="700"></p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb119-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(out<span class="op">$</span>sims.list<span class="op">$</span>sigma_int_prior, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, </a>
<a class="sourceLine" id="cb119-2" data-line-number="2">    <span class="dt">breaks =</span> <span class="dv">10</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>, <span class="dt">main =</span> <span class="st">"sigma_int_prior"</span>)</a>
<a class="sourceLine" id="cb119-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(out<span class="op">$</span>sims.list<span class="op">$</span>sigma_int_prior), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-13-5.png" width="700"></p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb120-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(out<span class="op">$</span>sims.list<span class="op">$</span>sigma_int, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">breaks =</span> <span class="dv">10</span>, </a>
<a class="sourceLine" id="cb120-2" data-line-number="2">    <span class="dt">freq =</span> <span class="ot">FALSE</span>, <span class="dt">main =</span> <span class="st">"sigma_int"</span>)</a>
<a class="sourceLine" id="cb120-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(out<span class="op">$</span>sims.list<span class="op">$</span>sigma_int), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-13-6.png" width="700"></p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb121-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(out<span class="op">$</span>sims.list<span class="op">$</span>sigma_slope_prior, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, </a>
<a class="sourceLine" id="cb121-2" data-line-number="2">    <span class="dt">breaks =</span> <span class="dv">10</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>, <span class="dt">main =</span> <span class="st">"sigma_slope_prior"</span>)</a>
<a class="sourceLine" id="cb121-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(out<span class="op">$</span>sims.list<span class="op">$</span>sigma_slope_prior), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-13-7.png" width="700"></p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb122-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(out<span class="op">$</span>sims.list<span class="op">$</span>sigma_slope, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">breaks =</span> <span class="dv">10</span>, </a>
<a class="sourceLine" id="cb122-2" data-line-number="2">    <span class="dt">freq =</span> <span class="ot">FALSE</span>, <span class="dt">main =</span> <span class="st">"sigma_slope"</span>)</a>
<a class="sourceLine" id="cb122-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(out<span class="op">$</span>sims.list<span class="op">$</span>sigma_slope), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-13-8.png" width="700"></p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb123-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(out<span class="op">$</span>sims.list<span class="op">$</span>rho_int_slope_prior, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, </a>
<a class="sourceLine" id="cb123-2" data-line-number="2">    <span class="dt">breaks =</span> <span class="dv">10</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>, <span class="dt">main =</span> <span class="st">"rho_int_slope_prior"</span>)</a>
<a class="sourceLine" id="cb123-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(out<span class="op">$</span>sims.list<span class="op">$</span>rho_int_slope_prior), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-13-9.png" width="700"></p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb124-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(out<span class="op">$</span>sims.list<span class="op">$</span>rho_int_slope, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, </a>
<a class="sourceLine" id="cb124-2" data-line-number="2">    <span class="dt">breaks =</span> <span class="dv">10</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>, <span class="dt">main =</span> <span class="st">"rho_int_slope"</span>)</a>
<a class="sourceLine" id="cb124-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(out<span class="op">$</span>sims.list<span class="op">$</span>rho_int_slope), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-13-10.png" width="700"></p>
</div>
</div>
</div>
<div id="finally-we-simulate-data-from-a-model-with-3-correlated-ranefs-and-then-provide-the-r-and-jags-analyses-of-this-data" class="section level2">
<h2 class="hasAnchor">
<a href="#finally-we-simulate-data-from-a-model-with-3-correlated-ranefs-and-then-provide-the-r-and-jags-analyses-of-this-data" class="anchor"></a>Finally, we simulate data from a model with 3 correlated ranefs and then provide the R and JAGS analyses of this data</h2>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb125-1" data-line-number="1">n_subjects &lt;-<span class="st"> </span><span class="dv">56</span></a>
<a class="sourceLine" id="cb125-2" data-line-number="2">n_sample &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb125-3" data-line-number="3">n_obs &lt;-<span class="st"> </span>n_subjects <span class="op">*</span><span class="st"> </span>n_sample</a>
<a class="sourceLine" id="cb125-4" data-line-number="4">subjects &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/gl">gl</a></span>(<span class="dt">n =</span> n_subjects, <span class="dt">k =</span> n_sample)</a>
<a class="sourceLine" id="cb125-5" data-line-number="5"></a>
<a class="sourceLine" id="cb125-6" data-line-number="6"><span class="co"># Two standardized continuous covariates:</span></a>
<a class="sourceLine" id="cb125-7" data-line-number="7">original_x1 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(n_obs, <span class="dv">45</span>, <span class="dv">70</span>)</a>
<a class="sourceLine" id="cb125-8" data-line-number="8">(mean_orig_x1 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(original_x1))</a></code></pre></div>
<pre><code>[1] 57.63993</code></pre>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb127-1" data-line-number="1">(sd_orig_x1 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/sd">sd</a></span>(original_x1))</a></code></pre></div>
<pre><code>[1] 7.054903</code></pre>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb129-1" data-line-number="1">x1 &lt;-<span class="st"> </span>(original_x1 <span class="op">-</span><span class="st"> </span>mean_orig_x1)<span class="op">/</span>sd_orig_x1</a>
<a class="sourceLine" id="cb129-2" data-line-number="2"></a>
<a class="sourceLine" id="cb129-3" data-line-number="3">original_x2 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/GammaDist">rgamma</a></span>(n_obs, <span class="dv">10</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb129-4" data-line-number="4">(mean_orig_x2 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(original_x2))</a></code></pre></div>
<pre><code>[1] 9.881085</code></pre>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb131-1" data-line-number="1">(sd_orig_x2 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/sd">sd</a></span>(original_x2))</a></code></pre></div>
<pre><code>[1] 3.075498</code></pre>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb133-1" data-line-number="1">x2 &lt;-<span class="st"> </span>(original_x2 <span class="op">-</span><span class="st"> </span>mean_orig_x2)<span class="op">/</span>sd_orig_x2</a>
<a class="sourceLine" id="cb133-2" data-line-number="2"></a>
<a class="sourceLine" id="cb133-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb133-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(x1, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">breaks =</span> <span class="dv">15</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb133-5" data-line-number="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(x1), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb133-6" data-line-number="6"></a>
<a class="sourceLine" id="cb133-7" data-line-number="7"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(x2, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">breaks =</span> <span class="dv">15</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb133-8" data-line-number="8"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(x2), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb134-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb134-2" data-line-number="2"></a>
<a class="sourceLine" id="cb134-3" data-line-number="3"><span class="co"># Design matrix:</span></a>
<a class="sourceLine" id="cb134-4" data-line-number="4">Xmat &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/model.matrix">model.matrix</a></span>(<span class="op">~</span>subjects <span class="op">*</span><span class="st"> </span>x1 <span class="op">+</span><span class="st"> </span>subjects <span class="op">*</span><span class="st"> </span>x2 <span class="op">-</span><span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>x1 <span class="op">-</span><span class="st"> </span>x2)</a>
<a class="sourceLine" id="cb134-5" data-line-number="5"></a>
<a class="sourceLine" id="cb134-6" data-line-number="6"><span class="co"># Generate the correlated random effects for intercept and slope: Assembling</span></a>
<a class="sourceLine" id="cb134-7" data-line-number="7"><span class="co"># the parameters for the multivariate normal distribution</span></a>
<a class="sourceLine" id="cb134-8" data-line-number="8">intercept_mean &lt;-<span class="st"> </span><span class="dv">230</span></a>
<a class="sourceLine" id="cb134-9" data-line-number="9">intercept_sd &lt;-<span class="st"> </span><span class="dv">20</span></a>
<a class="sourceLine" id="cb134-10" data-line-number="10">slope1_mean &lt;-<span class="st"> </span><span class="dv">60</span></a>
<a class="sourceLine" id="cb134-11" data-line-number="11">slope1_sd &lt;-<span class="st"> </span><span class="dv">30</span></a>
<a class="sourceLine" id="cb134-12" data-line-number="12">slope2_mean &lt;-<span class="st"> </span><span class="dv">40</span></a>
<a class="sourceLine" id="cb134-13" data-line-number="13">slope2_sd &lt;-<span class="st"> </span><span class="dv">25</span></a>
<a class="sourceLine" id="cb134-14" data-line-number="14">intercept_slope1_covariance &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb134-15" data-line-number="15">intercept_slope1_correlation &lt;-<span class="st"> </span>intercept_slope1_covariance<span class="op">/</span>(intercept_sd <span class="op">*</span><span class="st"> </span></a>
<a class="sourceLine" id="cb134-16" data-line-number="16"><span class="st">    </span>slope1_sd)</a>
<a class="sourceLine" id="cb134-17" data-line-number="17">intercept_slope2_covariance &lt;-<span class="st"> </span><span class="dv">300</span></a>
<a class="sourceLine" id="cb134-18" data-line-number="18">intercept_slope2_correlation &lt;-<span class="st"> </span>intercept_slope2_covariance<span class="op">/</span>(intercept_sd <span class="op">*</span><span class="st"> </span></a>
<a class="sourceLine" id="cb134-19" data-line-number="19"><span class="st">    </span>slope2_sd)</a>
<a class="sourceLine" id="cb134-20" data-line-number="20">slope1_slope2_covariance &lt;-<span class="st"> </span><span class="dv">-200</span></a>
<a class="sourceLine" id="cb134-21" data-line-number="21">slope1_slope2_correlation &lt;-<span class="st"> </span>slope1_slope2_covariance<span class="op">/</span>(slope1_sd <span class="op">*</span><span class="st"> </span>slope2_sd)</a>
<a class="sourceLine" id="cb134-22" data-line-number="22"></a>
<a class="sourceLine" id="cb134-23" data-line-number="23">mu_vector &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(intercept_mean, slope1_mean, slope2_mean)</a>
<a class="sourceLine" id="cb134-24" data-line-number="24">var_covar_matrix &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(intercept_sd<span class="op">^</span><span class="dv">2</span>, intercept_slope1_covariance, intercept_slope2_covariance, </a>
<a class="sourceLine" id="cb134-25" data-line-number="25">    intercept_slope1_covariance, slope1_sd<span class="op">^</span><span class="dv">2</span>, slope1_slope2_covariance, intercept_slope2_covariance, </a>
<a class="sourceLine" id="cb134-26" data-line-number="26">    slope1_slope2_covariance, slope2_sd<span class="op">^</span><span class="dv">2</span>), <span class="dv">3</span>, <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb134-27" data-line-number="27"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/eigen">eigen</a></span>(var_covar_matrix)<span class="op">$</span>values</a></code></pre></div>
<pre><code>[1] 1039.4957  714.9788  170.5255</code></pre>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb136-1" data-line-number="1"><span class="co"># Generating the correlated random effects for intercepts and slopes:</span></a>
<a class="sourceLine" id="cb136-2" data-line-number="2"></a>
<a class="sourceLine" id="cb136-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"MASS"</span>)</a>
<a class="sourceLine" id="cb136-4" data-line-number="4">effects &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/MASS/topics/mvrnorm">mvrnorm</a></span>(<span class="dt">n =</span> n_subjects, <span class="dt">mu =</span> mu_vector, <span class="dt">Sigma =</span> var_covar_matrix)</a>
<a class="sourceLine" id="cb136-5" data-line-number="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/str">str</a></span>(effects)</a></code></pre></div>
<pre><code> num [1:56, 1:3] 201 250 228 222 230 ...
 - attr(*, "dimnames")=List of 2
  ..$ : NULL
  ..$ : NULL</code></pre>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb138-1" data-line-number="1"><span class="co"># round(effects, 2)</span></a></code></pre></div>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb139-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(effects[, <span class="dv">1</span>], <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">breaks =</span> <span class="dv">10</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb139-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(effects[, <span class="dv">1</span>]), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb140-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(effects[, <span class="dv">2</span>], <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">breaks =</span> <span class="dv">10</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb140-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(effects[, <span class="dv">2</span>]), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-15-2.png" width="700"></p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb141-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(effects[, <span class="dv">3</span>], <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">breaks =</span> <span class="dv">10</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb141-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(effects[, <span class="dv">3</span>]), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-15-3.png" width="700"></p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb142-1" data-line-number="1"><span class="co"># Plotting the bivariate distributions:</span></a>
<a class="sourceLine" id="cb142-2" data-line-number="2">effects_kde12 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/MASS/topics/kde2d">kde2d</a></span>(effects[, <span class="dv">1</span>], effects[, <span class="dv">2</span>], <span class="dt">n =</span> <span class="dv">50</span>)</a>
<a class="sourceLine" id="cb142-3" data-line-number="3">effects_kde13 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/MASS/topics/kde2d">kde2d</a></span>(effects[, <span class="dv">1</span>], effects[, <span class="dv">3</span>], <span class="dt">n =</span> <span class="dv">50</span>)</a>
<a class="sourceLine" id="cb142-4" data-line-number="4">effects_kde23 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/MASS/topics/kde2d">kde2d</a></span>(effects[, <span class="dv">2</span>], effects[, <span class="dv">3</span>], <span class="dt">n =</span> <span class="dv">50</span>)</a>
<a class="sourceLine" id="cb142-5" data-line-number="5"></a>
<a class="sourceLine" id="cb142-6" data-line-number="6"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/image">image</a></span>(effects_kde12)</a>
<a class="sourceLine" id="cb142-7" data-line-number="7"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/contour">contour</a></span>(effects_kde12, <span class="dt">add =</span> T)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-15-4.png" width="700"></p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb143-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/persp">persp</a></span>(effects_kde12, <span class="dt">phi =</span> <span class="dv">45</span>, <span class="dt">theta =</span> <span class="dv">-30</span>, <span class="dt">shade =</span> <span class="fl">0.1</span>, <span class="dt">border =</span> <span class="ot">NULL</span>, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, </a>
<a class="sourceLine" id="cb143-2" data-line-number="2">    <span class="dt">ticktype =</span> <span class="st">"detailed"</span>, <span class="dt">xlab =</span> <span class="st">""</span>, <span class="dt">ylab =</span> <span class="st">""</span>, <span class="dt">zlab =</span> <span class="st">""</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-15-5.png" width="700"></p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb144-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/image">image</a></span>(effects_kde13)</a>
<a class="sourceLine" id="cb144-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/contour">contour</a></span>(effects_kde13, <span class="dt">add =</span> T)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-15-6.png" width="700"></p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb145-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/persp">persp</a></span>(effects_kde13, <span class="dt">phi =</span> <span class="dv">45</span>, <span class="dt">theta =</span> <span class="dv">-30</span>, <span class="dt">shade =</span> <span class="fl">0.1</span>, <span class="dt">border =</span> <span class="ot">NULL</span>, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, </a>
<a class="sourceLine" id="cb145-2" data-line-number="2">    <span class="dt">ticktype =</span> <span class="st">"detailed"</span>, <span class="dt">xlab =</span> <span class="st">""</span>, <span class="dt">ylab =</span> <span class="st">""</span>, <span class="dt">zlab =</span> <span class="st">""</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-15-7.png" width="700"></p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb146-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/image">image</a></span>(effects_kde23)</a>
<a class="sourceLine" id="cb146-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/contour">contour</a></span>(effects_kde23, <span class="dt">add =</span> T)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-15-8.png" width="700"></p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb147-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/persp">persp</a></span>(effects_kde23, <span class="dt">phi =</span> <span class="dv">45</span>, <span class="dt">theta =</span> <span class="dv">-30</span>, <span class="dt">shade =</span> <span class="fl">0.1</span>, <span class="dt">border =</span> <span class="ot">NULL</span>, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, </a>
<a class="sourceLine" id="cb147-2" data-line-number="2">    <span class="dt">ticktype =</span> <span class="st">"detailed"</span>, <span class="dt">xlab =</span> <span class="st">""</span>, <span class="dt">ylab =</span> <span class="st">""</span>, <span class="dt">zlab =</span> <span class="st">""</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-15-9.png" width="700"></p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb148-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/apply">apply</a></span>(effects, <span class="dv">2</span>, mean)</a></code></pre></div>
<pre><code>[1] 229.87384  61.04242  34.40549</code></pre>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb150-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/apply">apply</a></span>(effects, <span class="dv">2</span>, sd)</a></code></pre></div>
<pre><code>[1] 20.55603 32.79704 24.26273</code></pre>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb152-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/apply">apply</a></span>(effects, <span class="dv">2</span>, var)</a></code></pre></div>
<pre><code>[1]  422.5503 1075.6456  588.6802</code></pre>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb154-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">cov</a></span>(effects[, <span class="dv">1</span>], effects[, <span class="dv">2</span>])</a></code></pre></div>
<pre><code>[1] 148.2773</code></pre>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb156-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">cov</a></span>(effects[, <span class="dv">1</span>], effects[, <span class="dv">3</span>])</a></code></pre></div>
<pre><code>[1] 310.1884</code></pre>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb158-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">cov</a></span>(effects[, <span class="dv">2</span>], effects[, <span class="dv">3</span>])</a></code></pre></div>
<pre><code>[1] -38.48322</code></pre>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb160-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">var</a></span>(effects)</a></code></pre></div>
<pre><code>         [,1]       [,2]      [,3]
[1,] 422.5503  148.27726 310.18836
[2,] 148.2773 1075.64563 -38.48322
[3,] 310.1884  -38.48322 588.68016</code></pre>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb162-1" data-line-number="1">sigma_res &lt;-<span class="st"> </span><span class="dv">30</span></a>
<a class="sourceLine" id="cb162-2" data-line-number="2"></a>
<a class="sourceLine" id="cb162-3" data-line-number="3">population_parameters &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">intercept_mean =</span> intercept_mean, <span class="dt">slope1_mean =</span> slope1_mean, </a>
<a class="sourceLine" id="cb162-4" data-line-number="4">    <span class="dt">slope2_mean =</span> slope2_mean, <span class="dt">intercept_sd =</span> intercept_sd, <span class="dt">slope1_sd =</span> slope1_sd, </a>
<a class="sourceLine" id="cb162-5" data-line-number="5">    <span class="dt">slope2_sd =</span> slope2_sd, <span class="dt">intercept_slope1_covariance =</span> intercept_slope1_covariance, </a>
<a class="sourceLine" id="cb162-6" data-line-number="6">    <span class="dt">intercept_slope2_covariance =</span> intercept_slope2_covariance, <span class="dt">slope1_slope2_covariance =</span> slope1_slope2_covariance, </a>
<a class="sourceLine" id="cb162-7" data-line-number="7">    <span class="dt">sigma_res =</span> sigma_res)</a>
<a class="sourceLine" id="cb162-8" data-line-number="8"></a>
<a class="sourceLine" id="cb162-9" data-line-number="9">intercept_effects &lt;-<span class="st"> </span>effects[, <span class="dv">1</span>]</a>
<a class="sourceLine" id="cb162-10" data-line-number="10"><span class="co"># round(intercept_effects, 2)</span></a>
<a class="sourceLine" id="cb162-11" data-line-number="11">slope1_effects &lt;-<span class="st"> </span>effects[, <span class="dv">2</span>]</a>
<a class="sourceLine" id="cb162-12" data-line-number="12"><span class="co"># round(slope1_effects, 2)</span></a>
<a class="sourceLine" id="cb162-13" data-line-number="13">slope2_effects &lt;-<span class="st"> </span>effects[, <span class="dv">3</span>]</a>
<a class="sourceLine" id="cb162-14" data-line-number="14"><span class="co"># round(slope2_effects, 2)</span></a>
<a class="sourceLine" id="cb162-15" data-line-number="15">all_effects &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(intercept_effects, slope1_effects, slope2_effects)</a>
<a class="sourceLine" id="cb162-16" data-line-number="16"></a>
<a class="sourceLine" id="cb162-17" data-line-number="17"><span class="co"># Generate the response variable: -- the deterministic part</span></a>
<a class="sourceLine" id="cb162-18" data-line-number="18">lin_pred &lt;-<span class="st"> </span>Xmat <span class="op">%*%</span><span class="st"> </span>all_effects</a>
<a class="sourceLine" id="cb162-19" data-line-number="19"><span class="co"># round(as.vector(lin_pred), 2)</span></a>
<a class="sourceLine" id="cb162-20" data-line-number="20"></a>
<a class="sourceLine" id="cb162-21" data-line-number="21"><span class="co"># -- the stochastic part</span></a>
<a class="sourceLine" id="cb162-22" data-line-number="22">sigma_res &lt;-<span class="st"> </span><span class="dv">30</span></a>
<a class="sourceLine" id="cb162-23" data-line-number="23">normal_error &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dt">n =</span> n_obs, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> sigma_res)  <span class="co"># residuals</span></a>
<a class="sourceLine" id="cb162-24" data-line-number="24"></a>
<a class="sourceLine" id="cb162-25" data-line-number="25"><span class="co"># -- add them together</span></a>
<a class="sourceLine" id="cb162-26" data-line-number="26">y &lt;-<span class="st"> </span>lin_pred <span class="op">+</span><span class="st"> </span>normal_error</a>
<a class="sourceLine" id="cb162-27" data-line-number="27"><span class="co"># or, in one go:</span></a>
<a class="sourceLine" id="cb162-28" data-line-number="28">y &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dt">n =</span> n_obs, <span class="dt">mean =</span> lin_pred, <span class="dt">sd =</span> sigma_res)</a>
<a class="sourceLine" id="cb162-29" data-line-number="29"></a>
<a class="sourceLine" id="cb162-30" data-line-number="30"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(y, <span class="dt">col =</span> <span class="st">"lightsteelblue1"</span>, <span class="dt">border =</span> <span class="st">"white"</span>, <span class="dt">breaks =</span> <span class="dv">15</span>, <span class="dt">freq =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb162-31" data-line-number="31"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(y), <span class="dt">col =</span> <span class="st">"lightsteelblue3"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-15-10.png" width="700"></p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb163-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"lattice"</span>)</a>
<a class="sourceLine" id="cb163-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/lattice/topics/xyplot">xyplot</a></span>(y <span class="op">~</span><span class="st"> </span>x1 <span class="op">+</span><span class="st"> </span>x2 <span class="op">|</span><span class="st"> </span>subjects, <span class="dt">pch =</span> <span class="dv">20</span>)</a></code></pre></div>
<p><img src="count-regression-hierarchical-mixedeffects-vignette_files/figure-html/unnamed-chunk-15-11.png" width="700"></p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb164-1" data-line-number="1"><span class="co"># REML analysis using R</span></a>
<a class="sourceLine" id="cb164-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"lme4"</span>)</a>
<a class="sourceLine" id="cb164-3" data-line-number="3">lme_fit4 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/lmer">lmer</a></span>(y <span class="op">~</span><span class="st"> </span>x1 <span class="op">+</span><span class="st"> </span>x2 <span class="op">+</span><span class="st"> </span>(x1 <span class="op">+</span><span class="st"> </span>x2 <span class="op">|</span><span class="st"> </span>subjects))</a>
<a class="sourceLine" id="cb164-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(lme_fit4, <span class="dt">cor =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ x1 + x2 + (x1 + x2 | subjects)
REML criterion at convergence: 5671.607
Random effects:
 Groups   Name        Std.Dev. Corr       
 subjects (Intercept) 19.14               
          x1          33.79     0.35      
          x2          24.19     0.58 -0.04
 Residual             29.28               
Number of obs: 560, groups:  subjects, 56
Fixed Effects:
(Intercept)           x1           x2  
     231.08        62.20        33.39  </code></pre>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb166-1" data-line-number="1"><span class="co"># Compare with the true values:</span></a>
<a class="sourceLine" id="cb166-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">intercept_mean =</span> intercept_mean, <span class="dt">slope1_mean =</span> slope1_mean, <span class="dt">slope2_mean =</span> slope2_mean, </a>
<a class="sourceLine" id="cb166-3" data-line-number="3">    <span class="dt">intercept_sd =</span> intercept_sd, <span class="dt">slope1_sd =</span> slope1_sd, <span class="dt">slope2_sd =</span> slope2_sd, </a>
<a class="sourceLine" id="cb166-4" data-line-number="4">    <span class="dt">intercept_slope1_covariance =</span> intercept_slope1_covariance, <span class="dt">intercept_slope2_covariance =</span> intercept_slope2_covariance, </a>
<a class="sourceLine" id="cb166-5" data-line-number="5">    <span class="dt">slope1_slope2_covariance =</span> slope1_slope2_covariance, <span class="dt">sigma_res =</span> sigma_res)</a></code></pre></div>
<pre><code>  intercept_mean slope1_mean slope2_mean intercept_sd slope1_sd slope2_sd
1            230          60          40           20        30        25
  intercept_slope1_covariance intercept_slope2_covariance
1                          10                         300
  slope1_slope2_covariance sigma_res
1                     -200        30</code></pre>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb168-1" data-line-number="1"><span class="co"># Bayesian analysis using a scaled Inverse Wishart</span></a>
<a class="sourceLine" id="cb168-2" data-line-number="2"></a>
<a class="sourceLine" id="cb168-3" data-line-number="3"><span class="co"># Define model</span></a>
<a class="sourceLine" id="cb168-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">"model {</span></a>
<a class="sourceLine" id="cb168-5" data-line-number="5"></a>
<a class="sourceLine" id="cb168-6" data-line-number="6"><span class="st"># Set up the means for the multivariate ranef distribution</span></a>
<a class="sourceLine" id="cb168-7" data-line-number="7"><span class="st">for (i in 1:3) {</span></a>
<a class="sourceLine" id="cb168-8" data-line-number="8"><span class="st">    xi[i]~dunif(0, 100)</span></a>
<a class="sourceLine" id="cb168-9" data-line-number="9"><span class="st">    mu_raw[i]~dnorm(0, .0001)</span></a>
<a class="sourceLine" id="cb168-10" data-line-number="10"><span class="st">    mu[i] &lt;- xi[i]*mu_raw[i]</span></a>
<a class="sourceLine" id="cb168-11" data-line-number="11"><span class="st">}</span></a>
<a class="sourceLine" id="cb168-12" data-line-number="12"><span class="st">mu_int &lt;- mu[1]</span></a>
<a class="sourceLine" id="cb168-13" data-line-number="13"><span class="st">mu_slope1 &lt;- mu[2]</span></a>
<a class="sourceLine" id="cb168-14" data-line-number="14"><span class="st">mu_slope2 &lt;- mu[3]</span></a>
<a class="sourceLine" id="cb168-15" data-line-number="15"></a>
<a class="sourceLine" id="cb168-16" data-line-number="16"><span class="st">Tau_B_raw[1:3, 1:3] ~ dwish(W[,], 4)</span></a>
<a class="sourceLine" id="cb168-17" data-line-number="17"><span class="st">Sigma_B_raw[1:3, 1:3] &lt;- inverse(Tau_B_raw[,])</span></a>
<a class="sourceLine" id="cb168-18" data-line-number="18"><span class="st">for (i in 1:3) {</span></a>
<a class="sourceLine" id="cb168-19" data-line-number="19"><span class="st">    sigma[i] &lt;- xi[i]*sqrt(Sigma_B_raw[i, i])</span></a>
<a class="sourceLine" id="cb168-20" data-line-number="20"><span class="st">}</span></a>
<a class="sourceLine" id="cb168-21" data-line-number="21"><span class="st">sigma_int &lt;- sigma[1]</span></a>
<a class="sourceLine" id="cb168-22" data-line-number="22"><span class="st">sigma_slope1 &lt;- sigma[2]</span></a>
<a class="sourceLine" id="cb168-23" data-line-number="23"><span class="st">sigma_slope2 &lt;- sigma[3]</span></a>
<a class="sourceLine" id="cb168-24" data-line-number="24"><span class="st">for (i in 1:3) { for (j in 1:3) {</span></a>
<a class="sourceLine" id="cb168-25" data-line-number="25"><span class="st">    rho[i, j] &lt;- Sigma_B_raw[i, j]/sqrt(Sigma_B_raw[i, i]*Sigma_B_raw[j, j])</span></a>
<a class="sourceLine" id="cb168-26" data-line-number="26"><span class="st">} }</span></a>
<a class="sourceLine" id="cb168-27" data-line-number="27"><span class="st">rho_int_slope1 &lt;- rho[1, 2]</span></a>
<a class="sourceLine" id="cb168-28" data-line-number="28"><span class="st">rho_int_slope2 &lt;- rho[1, 3]</span></a>
<a class="sourceLine" id="cb168-29" data-line-number="29"><span class="st">rho_slope1_slope2 &lt;- rho[2, 3]</span></a>
<a class="sourceLine" id="cb168-30" data-line-number="30"></a>
<a class="sourceLine" id="cb168-31" data-line-number="31"><span class="st">for (j in 1:n_subj) {</span></a>
<a class="sourceLine" id="cb168-32" data-line-number="32"><span class="ch">\t</span><span class="st">B_raw_hat[j, 1] &lt;- mu_raw[1]</span></a>
<a class="sourceLine" id="cb168-33" data-line-number="33"><span class="ch">\t</span><span class="st">B_raw_hat[j, 2] &lt;- mu_raw[2]</span></a>
<a class="sourceLine" id="cb168-34" data-line-number="34"><span class="ch">\t</span><span class="st">B_raw_hat[j, 3] &lt;- mu_raw[3]</span></a>
<a class="sourceLine" id="cb168-35" data-line-number="35"><span class="ch">\t</span><span class="st">B_raw[j, 1:3] ~ dmnorm(B_raw_hat[j, ], Tau_B_raw[, ])</span></a>
<a class="sourceLine" id="cb168-36" data-line-number="36"><span class="ch">\t</span><span class="st">alpha[j] &lt;- xi[1]*B_raw[j, 1]</span></a>
<a class="sourceLine" id="cb168-37" data-line-number="37"><span class="st">    beta1[j] &lt;- xi[2]*B_raw[j, 2]</span></a>
<a class="sourceLine" id="cb168-38" data-line-number="38"><span class="st">    beta2[j] &lt;- xi[3]*B_raw[j, 3]</span></a>
<a class="sourceLine" id="cb168-39" data-line-number="39"><span class="st">}</span></a>
<a class="sourceLine" id="cb168-40" data-line-number="40"></a>
<a class="sourceLine" id="cb168-41" data-line-number="41"><span class="st">sigma_res~dunif(0, 100) # Residual standard deviation</span></a>
<a class="sourceLine" id="cb168-42" data-line-number="42"><span class="st">tau_res &lt;- 1/(sigma_res*sigma_res)</span></a>
<a class="sourceLine" id="cb168-43" data-line-number="43"></a>
<a class="sourceLine" id="cb168-44" data-line-number="44"><span class="st">for (i in 1:n_obs) {</span></a>
<a class="sourceLine" id="cb168-45" data-line-number="45"><span class="st">    mu_obs[i] &lt;- alpha[subjects[i]]+beta1[subjects[i]]*x1[i]+beta2[subjects[i]]*x2[i]</span></a>
<a class="sourceLine" id="cb168-46" data-line-number="46"><span class="st">    y[i]~dnorm(mu_obs[i], tau_res)</span></a>
<a class="sourceLine" id="cb168-47" data-line-number="47"><span class="st">}</span></a>
<a class="sourceLine" id="cb168-48" data-line-number="48"></a>
<a class="sourceLine" id="cb168-49" data-line-number="49"><span class="st">for (i in 1:3) {</span></a>
<a class="sourceLine" id="cb168-50" data-line-number="50"><span class="st">    xi_prior[i]~dunif(0, 100)</span></a>
<a class="sourceLine" id="cb168-51" data-line-number="51"><span class="st">    mu_raw_prior[i]~dnorm(0, .0001)</span></a>
<a class="sourceLine" id="cb168-52" data-line-number="52"><span class="st">    mu_prior[i] &lt;- xi_prior[i]*mu_raw_prior[i]</span></a>
<a class="sourceLine" id="cb168-53" data-line-number="53"><span class="st">}</span></a>
<a class="sourceLine" id="cb168-54" data-line-number="54"><span class="st">mu_int_prior &lt;- mu_prior[1]</span></a>
<a class="sourceLine" id="cb168-55" data-line-number="55"><span class="st">mu_slope1_prior &lt;- mu_prior[2]</span></a>
<a class="sourceLine" id="cb168-56" data-line-number="56"><span class="st">mu_slope2_prior &lt;- mu_prior[3]</span></a>
<a class="sourceLine" id="cb168-57" data-line-number="57"><span class="st">Tau_B_raw_prior[1:3, 1:3] ~ dwish(W[,], 4)</span></a>
<a class="sourceLine" id="cb168-58" data-line-number="58"><span class="st">Sigma_B_raw_prior[1:3, 1:3] &lt;- inverse(Tau_B_raw_prior[,])</span></a>
<a class="sourceLine" id="cb168-59" data-line-number="59"><span class="st">for (i in 1:3) {</span></a>
<a class="sourceLine" id="cb168-60" data-line-number="60"><span class="st">    sigma_prior[i] &lt;- xi_prior[i]*sqrt(Sigma_B_raw_prior[i, i])</span></a>
<a class="sourceLine" id="cb168-61" data-line-number="61"><span class="st">}</span></a>
<a class="sourceLine" id="cb168-62" data-line-number="62"><span class="st">sigma_int_prior &lt;- sigma_prior[1]</span></a>
<a class="sourceLine" id="cb168-63" data-line-number="63"><span class="st">sigma_slope1_prior &lt;- sigma_prior[2]</span></a>
<a class="sourceLine" id="cb168-64" data-line-number="64"><span class="st">sigma_slope2_prior &lt;- sigma_prior[3]</span></a>
<a class="sourceLine" id="cb168-65" data-line-number="65"><span class="st">for (i in 1:3) { for (j in 1:3) {</span></a>
<a class="sourceLine" id="cb168-66" data-line-number="66"><span class="st">    rho_prior[i, j] &lt;- Sigma_B_raw_prior[i, j]/sqrt(Sigma_B_raw_prior[i, i]*Sigma_B_raw_prior[j, j])</span></a>
<a class="sourceLine" id="cb168-67" data-line-number="67"><span class="st">} }</span></a>
<a class="sourceLine" id="cb168-68" data-line-number="68"><span class="st">rho_int_slope1_prior &lt;- rho_prior[1, 2]</span></a>
<a class="sourceLine" id="cb168-69" data-line-number="69"><span class="st">rho_int_slope2_prior &lt;- rho_prior[1, 3]</span></a>
<a class="sourceLine" id="cb168-70" data-line-number="70"><span class="st">rho_slope1_slope2_prior &lt;- rho_prior[2, 3]</span></a>
<a class="sourceLine" id="cb168-71" data-line-number="71"><span class="st">}"</span>, </a>
<a class="sourceLine" id="cb168-72" data-line-number="72">    <span class="dt">fill =</span> <span class="ot">TRUE</span>, <span class="dt">file =</span> <span class="st">"lme_model5.txt"</span>)</a>
<a class="sourceLine" id="cb168-73" data-line-number="73"></a>
<a class="sourceLine" id="cb168-74" data-line-number="74"><span class="co"># Bundle data</span></a>
<a class="sourceLine" id="cb168-75" data-line-number="75">jags_data &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(y), <span class="dt">subjects =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(subjects), <span class="dt">x1 =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(x1), </a>
<a class="sourceLine" id="cb168-76" data-line-number="76">    <span class="dt">x2 =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(x2), <span class="dt">n_subj =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(subjects)), <span class="dt">n_obs =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(n_obs), </a>
<a class="sourceLine" id="cb168-77" data-line-number="77">    <span class="dt">W =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/diag">diag</a></span>(<span class="dv">3</span>))</a>
<a class="sourceLine" id="cb168-78" data-line-number="78"></a>
<a class="sourceLine" id="cb168-79" data-line-number="79"><span class="co"># install.packages('bayesm')</span></a>
<a class="sourceLine" id="cb168-80" data-line-number="80"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"bayesm"</span>)</a>
<a class="sourceLine" id="cb168-81" data-line-number="81">var_vec &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/apply">apply</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/coef">coef</a></span>(lme_fit4)<span class="op">$</span>subjects, <span class="dv">2</span>, var)</a>
<a class="sourceLine" id="cb168-82" data-line-number="82"></a>
<a class="sourceLine" id="cb168-83" data-line-number="83"><span class="co"># Inits function</span></a>
<a class="sourceLine" id="cb168-84" data-line-number="84">inits &lt;-<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb168-85" data-line-number="85">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">xi =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Lognormal">rlnorm</a></span>(<span class="dv">3</span>), <span class="dt">mu_raw =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">3</span>), <span class="dt">Tau_B_raw =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/bayesm/topics/rwishart">rwishart</a></span>(<span class="dv">4</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/diag">diag</a></span>(<span class="dv">3</span>) <span class="op">*</span><span class="st"> </span></a>
<a class="sourceLine" id="cb168-86" data-line-number="86"><span class="st">        </span>var_vec)<span class="op">$</span>W, <span class="dt">sigma_res =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Lognormal">rlnorm</a></span>(<span class="dv">1</span>), <span class="dt">xi_prior =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Lognormal">rlnorm</a></span>(<span class="dv">3</span>), <span class="dt">mu_raw_prior =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">3</span>), </a>
<a class="sourceLine" id="cb168-87" data-line-number="87">        <span class="dt">Tau_B_raw_prior =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/bayesm/topics/rwishart">rwishart</a></span>(<span class="dv">4</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/diag">diag</a></span>(<span class="dv">3</span>) <span class="op">*</span><span class="st"> </span>var_vec)<span class="op">$</span>W)</a>
<a class="sourceLine" id="cb168-88" data-line-number="88">}</a>
<a class="sourceLine" id="cb168-89" data-line-number="89"></a>
<a class="sourceLine" id="cb168-90" data-line-number="90"><span class="co"># Parameters to estimate</span></a>
<a class="sourceLine" id="cb168-91" data-line-number="91">params &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"mu"</span>, <span class="st">"mu_int"</span>, <span class="st">"mu_slope1"</span>, <span class="st">"mu_slope2"</span>, <span class="st">"sigma"</span>, <span class="st">"sigma_int"</span>, </a>
<a class="sourceLine" id="cb168-92" data-line-number="92">    <span class="st">"sigma_slope1"</span>, <span class="st">"sigma_slope2"</span>, <span class="st">"rho"</span>, <span class="st">"rho_int_slope1"</span>, <span class="st">"rho_int_slope2"</span>, </a>
<a class="sourceLine" id="cb168-93" data-line-number="93">    <span class="st">"rho_slope1_slope2"</span>, <span class="st">"alpha"</span>, <span class="st">"beta1"</span>, <span class="st">"beta2"</span>, <span class="st">"sigma_res"</span>, <span class="st">"mu_int_prior"</span>, </a>
<a class="sourceLine" id="cb168-94" data-line-number="94">    <span class="st">"mu_slope1_prior"</span>, <span class="st">"mu_slope2_prior"</span>, <span class="st">"sigma_int_prior"</span>, <span class="st">"sigma_slope1_prior"</span>, </a>
<a class="sourceLine" id="cb168-95" data-line-number="95">    <span class="st">"sigma_slope2_prior"</span>, <span class="st">"rho_prior"</span>, <span class="st">"rho_int_slope1_prior"</span>, <span class="st">"rho_int_slope2_prior"</span>, </a>
<a class="sourceLine" id="cb168-96" data-line-number="96">    <span class="st">"rho_slope1_slope2_prior"</span>)</a>
<a class="sourceLine" id="cb168-97" data-line-number="97"></a>
<a class="sourceLine" id="cb168-98" data-line-number="98"><span class="co"># MCMC settings</span></a>
<a class="sourceLine" id="cb168-99" data-line-number="99">ni &lt;-<span class="st"> </span><span class="dv">7000</span></a>
<a class="sourceLine" id="cb168-100" data-line-number="100">nb &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb168-101" data-line-number="101">nt &lt;-<span class="st"> </span><span class="dv">6</span></a>
<a class="sourceLine" id="cb168-102" data-line-number="102">nc &lt;-<span class="st"> </span><span class="dv">3</span>  <span class="co"># more than this probably needed for a good approx. of the posterior distribution</span></a>
<a class="sourceLine" id="cb168-103" data-line-number="103"></a>
<a class="sourceLine" id="cb168-104" data-line-number="104"><span class="co"># Start Gibbs sampler</span></a>
<a class="sourceLine" id="cb168-105" data-line-number="105"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"R2jags"</span>)</a>
<a class="sourceLine" id="cb168-106" data-line-number="106">outj &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/R2jags/topics/jags">jags</a></span>(jags_data, <span class="dt">inits =</span> inits, <span class="dt">parameters.to.save =</span> params, <span class="dt">model.file =</span> <span class="st">"lme_model5.txt"</span>, </a>
<a class="sourceLine" id="cb168-107" data-line-number="107">    <span class="dt">n.thin =</span> nt, <span class="dt">n.chains =</span> nc, <span class="dt">n.burnin =</span> nb, <span class="dt">n.iter =</span> ni)</a></code></pre></div>
<pre><code>Compiling model graph
   Resolving undeclared variables
   Allocating nodes
Graph information:
   Observed stochastic nodes: 560
   Unobserved stochastic nodes: 71
   Total graph size: 4494

Initializing model</code></pre>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb170-1" data-line-number="1"><span class="co"># traceplot(outj)</span></a>
<a class="sourceLine" id="cb170-2" data-line-number="2"></a>
<a class="sourceLine" id="cb170-3" data-line-number="3"><span class="co">## print(outj, dig = 3)</span></a>
<a class="sourceLine" id="cb170-4" data-line-number="4"></a>
<a class="sourceLine" id="cb170-5" data-line-number="5">out &lt;-<span class="st"> </span>outj<span class="op">$</span>BUGSoutput</a>
<a class="sourceLine" id="cb170-6" data-line-number="6"></a>
<a class="sourceLine" id="cb170-7" data-line-number="7"><span class="co"># Compare with MLEs and true values</span></a>
<a class="sourceLine" id="cb170-8" data-line-number="8"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(out<span class="op">$</span>mean, <span class="dt">dig =</span> <span class="dv">4</span>)</a></code></pre></div>
<pre><code>$alpha
 [1] 217.8 243.4 238.6 227.2 229.3 227.6 262.9 210.9 199.6 225.6 203.8
[12] 223.0 206.7 232.5 209.0 245.7 211.9 232.6 262.6 231.9 219.7 272.6
[23] 230.0 224.4 233.6 223.1 210.2 224.0 221.8 232.6 223.9 225.6 229.4
[34] 227.2 221.5 237.5 206.8 243.8 247.3 229.0 260.6 248.8 211.7 230.9
[45] 258.2 256.2 215.1 239.1 229.9 242.6 238.9 229.7 221.8 223.6 255.4
[56] 254.4

$beta1
 [1] 111.7706  42.8630  82.1078  32.7960  54.5385 109.1419 101.9165
 [8]  88.9700  32.7472  31.3557 119.7079  95.3456  16.4265  38.6030
[15]   4.9853  64.3551  22.0070  71.8977  94.2167  51.4323  87.5317
[22]  90.9158  39.9554   0.3494   6.8205  64.4347  10.8259  56.1589
[29]  30.7533  63.1827  67.1525  34.1163 101.7915   8.2188  77.0835
[36]  52.0454  68.1745  72.9775  82.1459  45.1824  67.0325  78.2213
[43]   3.9950  96.4582 124.0805 107.7060  78.3983  56.1488  52.3290
[50]  72.1807  51.2117  54.6774  69.6350  58.9315  77.0949 109.9637

$beta2
 [1]   1.495  30.951  -1.527  45.784  60.154  26.616  57.780  -8.824
 [9]  13.138  21.536   4.693   5.571   4.083  30.786  39.046  47.623
[17]  20.868  33.159  53.691  26.983 -11.101  98.981  63.403  31.652
[25]  42.240  17.734  19.095  38.448  62.040  49.460  35.611  12.260
[33]  22.440  39.959   4.306  28.573  15.403  29.607  51.533  46.012
[41]  66.301  35.592  30.617  26.340  61.084  57.625   4.595  40.725
[49]  61.073  39.075  46.516  49.900   8.016  37.354  47.036  44.776

$deviance
[1] 5383

$mu
[1] 231.09  62.21  33.35

$mu_int
[1] 231.1

$mu_int_prior
[1] -61.96

$mu_slope1
[1] 62.21

$mu_slope1_prior
[1] -131.8

$mu_slope2
[1] 33.35

$mu_slope2_prior
[1] -135.9

$rho
       [,1]     [,2]     [,3]
[1,] 1.0000  0.35050  0.58131
[2,] 0.3505  1.00000 -0.03531
[3,] 0.5813 -0.03531  1.00000

$rho_int_slope1
[1] 0.3505

$rho_int_slope1_prior
[1] 0.003383

$rho_int_slope2
[1] 0.5813

$rho_int_slope2_prior
[1] -0.003807

$rho_prior
          [,1]      [,2]      [,3]
[1,]  1.000000  0.003383 -0.003807
[2,]  0.003383  1.000000 -0.015150
[3,] -0.003807 -0.015150  1.000000

$rho_slope1_slope2
[1] -0.03531

$rho_slope1_slope2_prior
[1] -0.01515

$sigma
[1] 18.35 34.18 24.07

$sigma_int
[1] 18.35

$sigma_int_prior
[1] 62.34

$sigma_res
[1] 29.63

$sigma_slope1
[1] 34.18

$sigma_slope1_prior
[1] 62.59

$sigma_slope2
[1] 24.07

$sigma_slope2_prior
[1] 65.64</code></pre>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb172-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">intercept_mean =</span> intercept_mean, <span class="dt">slope1_mean =</span> slope1_mean, <span class="dt">slope2_mean =</span> slope2_mean, </a>
<a class="sourceLine" id="cb172-2" data-line-number="2">    <span class="dt">intercept_sd =</span> intercept_sd, <span class="dt">slope1_sd =</span> slope1_sd, <span class="dt">slope2_sd =</span> slope2_sd, </a>
<a class="sourceLine" id="cb172-3" data-line-number="3">    <span class="dt">intercept_slope1_covariance =</span> intercept_slope1_covariance, <span class="dt">intercept_slope2_covariance =</span> intercept_slope2_covariance, </a>
<a class="sourceLine" id="cb172-4" data-line-number="4">    <span class="dt">slope1_slope2_covariance =</span> slope1_slope2_covariance, <span class="dt">sigma_res =</span> sigma_res)</a></code></pre></div>
<pre><code>  intercept_mean slope1_mean slope2_mean intercept_sd slope1_sd slope2_sd
1            230          60          40           20        30        25
  intercept_slope1_covariance intercept_slope2_covariance
1                          10                         300
  slope1_slope2_covariance sigma_res
1                     -200        30</code></pre>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb174-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(lme_fit4, <span class="dt">cor =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ x1 + x2 + (x1 + x2 | subjects)
REML criterion at convergence: 5671.607
Random effects:
 Groups   Name        Std.Dev. Corr       
 subjects (Intercept) 19.14               
          x1          33.79     0.35      
          x2          24.19     0.58 -0.04
 Residual             29.28               
Number of obs: 560, groups:  subjects, 56
Fixed Effects:
(Intercept)           x1           x2  
     231.08        62.20        33.39  </code></pre>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb176-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">intercept_mean =</span> intercept_mean, <span class="dt">slope1_mean =</span> slope1_mean, <span class="dt">slope2_mean =</span> slope2_mean, </a>
<a class="sourceLine" id="cb176-2" data-line-number="2">    <span class="dt">intercept_sd =</span> intercept_sd, <span class="dt">slope1_sd =</span> slope1_sd, <span class="dt">slope2_sd =</span> slope2_sd, </a>
<a class="sourceLine" id="cb176-3" data-line-number="3">    <span class="dt">intercept_slope1_covariance =</span> intercept_slope1_covariance, <span class="dt">intercept_slope2_covariance =</span> intercept_slope2_covariance, </a>
<a class="sourceLine" id="cb176-4" data-line-number="4">    <span class="dt">slope1_slope2_covariance =</span> slope1_slope2_covariance, <span class="dt">sigma_res =</span> sigma_res)</a></code></pre></div>
<pre><code>  intercept_mean slope1_mean slope2_mean intercept_sd slope1_sd slope2_sd
1            230          60          40           20        30        25
  intercept_slope1_covariance intercept_slope2_covariance
1                          10                         300
  slope1_slope2_covariance sigma_res
1                     -200        30</code></pre>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb178-1" data-line-number="1"><span class="co"># Note the large sd.s for the measures of association</span></a>
<a class="sourceLine" id="cb178-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(out<span class="op">$</span>mean<span class="op">$</span>rho, <span class="dt">dig =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>     [,1]   [,2]   [,3]
[1,] 1.00  0.350  0.581
[2,] 0.35  1.000 -0.035
[3,] 0.58 -0.035  1.000</code></pre>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb180-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(out<span class="op">$</span>sd<span class="op">$</span>rho, <span class="dt">dig =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>     [,1] [,2] [,3]
[1,] 0.00 0.14 0.13
[2,] 0.14 0.00 0.15
[3,] 0.13 0.15 0.00</code></pre>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb182-1" data-line-number="1"><span class="co"># </span><span class="al">TBD</span><span class="co"> compare the prior and posterior distributions for the (derived) ranef</span></a>
<a class="sourceLine" id="cb182-2" data-line-number="2"><span class="co"># distribution parameters:</span></a></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#linear-mixed-effects">Linear Mixed Effects</a><ul class="nav nav-pills nav-stacked">
<li><a href="#bayesian-hierarchical-analysis-using-jags">Bayesian hierarchical analysis using JAGS</a></li>
      <li><a href="#finally-we-simulate-data-from-a-model-with-3-correlated-ranefs-and-then-provide-the-r-and-jags-analyses-of-this-data">Finally, we simulate data from a model with 3 correlated ranefs and then provide the R and JAGS analyses of this data</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Bruce Campbell.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
